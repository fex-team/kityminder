/*!
 * ====================================================
 * kityminder - v1.1.3 - 2014-07-23
 * https://github.com/fex-team/kityminder
 * GitHub: https://github.com/fex-team/kityminder.git 
 * Copyright (c) 2014 f-cube @ FEX; Licensed MIT
 * ====================================================
 */

!function(a,b){function c(a,b){return a.getIndex()-b.getIndex()}function d(a,b){return-c(a,b)}var e=b.KM=b.KityMinder=function(){var a={},b=0,c={};return{version:"1.2.0",uuid:function(a){return a=a||"unknown",c[a]=c[a]||0,++c[a],a+"_"+c[a]},createMinder:function(a,b){b=b||{},b.renderTo=Utils.isString(a)?document.getElementById(a):a;var c=new j(b);return this.addMinder(b.renderTo,c),c},addMinder:function(c,d){var e;e="string"==typeof c?c:c.id||"KM_INSTANCE_"+b++,a[e]=d},getMinder:function(c,d){var e;return e="string"==typeof c?c:c.id||"KM_INSTANCE_"+b++,a[e]||this.createMinder(c,d)},LANG:{}}}(),f=Utils=e.Utils={extend:a.Utils.extend.bind(a.Utils),listen:function(a,c,d){var e=f.isArray(c)?c:f.trim(c).split(/\s+/),g=e.length;if(g)for(;g--;)if(c=e[g],a.addEventListener)a.addEventListener(c,d,!1);else{d._d||(d._d={els:[]});var h=c+d.toString(),i=f.indexOf(d._d.els,a);d._d[h]&&-1!=i||(-1==i&&d._d.els.push(a),d._d[h]||(d._d[h]=function(a){return d.call(a.srcElement,a||b.event)}),a.attachEvent("on"+c,d._d[h]))}a=null},trim:function(a){return a.replace(/(^[ \t\n\r]+)|([ \t\n\r]+$)/g,"")},each:function(a,b,c){if(null!=a)if(a.length===+a.length){for(var d=0,e=a.length;e>d;d++)if(b.call(c,d,a[d],a)===!1)return!1}else for(var f in a)if(a.hasOwnProperty(f)&&b.call(c,f,a[f],a)===!1)return!1},addCssRule:function(a,b,c){var d;return void 0===b||b&&b.nodeType&&9==b.nodeType?(c=b&&b.nodeType&&9==b.nodeType?b:c||document,d=c.getElementById(a),d?d.innerHTML:void 0):(c=c||document,d=c.getElementById(a),""===b?d?(d.parentNode.removeChild(d),!0):!1:void(d?d.innerHTML=b:(d=c.createElement("style"),d.id=a,d.innerHTML=b,c.getElementsByTagName("head")[0].appendChild(d))))},keys:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},proxy:function(a,b){return function(){return a.apply(b,arguments)}},indexOf:function(a,b,c){var d=-1;return c=this.isNumber(c)?c:0,this.each(a,function(a,e){return e>=c&&a===b?(d=e,!1):void 0}),d},argsToArray:function(a,b){return Array.prototype.slice.call(a,b||0)},clonePlainObject:function(a,b){var c;b=b||{};for(var d in a)a.hasOwnProperty(d)&&(c=a[d],f.isObject(c)||f.isArray(c)?(b[d]=f.isArray(c)?[]:{},f.clonePlainObject(a[d],b[d])):b[d]=c);return b},compareObject:function(a,b){var c;if(this.isEmptyObject(a)!==this.isEmptyObject(b))return!1;if(this.getObjectLength(a)!=this.getObjectLength(b))return!1;for(var d in a)if(a.hasOwnProperty(d)){if(c=a[d],void 0===b[d])return!1;if(this.isObject(c)||this.isArray(c)){if(this.isObject(b[d])!==this.isObject(c))return!1;if(this.isArray(c)!==this.isArray(b[d]))return!1;if(this.compareObject(c,b[d])===!1)return!1}else if(c!=b[d])return!1}return!0},getObjectLength:function(a){if(this.isArray(a)||this.isString(a))return a.length;var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b},isEmptyObject:function(a){if(null==a)return!0;if(this.isArray(a)||this.isString(a))return 0===a.length;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},loadFile:function(){function a(a,c){try{for(var d,e=0;d=b[e++];)if(d.doc===a&&d.url==(c.src||c.href))return d}catch(f){return null}}var b=[];return function(c,d,e){var f=a(c,d);if(f)return void(f.ready?e&&e():f.funs.push(e));if(b.push({doc:c,url:d.src||d.href,funs:[e]}),!c.body){var g=[];for(var h in d)"tag"!=h&&g.push(h+'="'+d[h]+'"');return void c.write("<"+d.tag+" "+g.join(" ")+" ></"+d.tag+">")}if(!d.id||!c.getElementById(d.id)){var i=c.createElement(d.tag);delete d.tag;for(var h in d)i.setAttribute(h,d[h]);i.onload=i.onreadystatechange=function(){if(!this.readyState||/loaded|complete/.test(this.readyState)){if(f=a(c,d),f.funs.length>0){f.ready=1;for(var b;b=f.funs.pop();)b()}i.onload=i.onreadystatechange=null}},c.getElementsByTagName("head")[0].appendChild(i)}}}(),clone:function(a,b){var c;b=b||{};for(var d in a)a.hasOwnProperty(d)&&(c=a[d],"object"==typeof c?(b[d]=f.isArray(c)?[]:{},f.clone(a[d],b[d])):b[d]=c);return b},unhtml:function(a,b){return a?a.replace(b||/[&<">'](?:(amp|lt|quot|gt|#39|nbsp);)?/g,function(a,b){return b?a:{"<":"&lt;","&":"&amp;",'"':"&quot;",">":"&gt;","'":"&#39;"}[a]}):""},cloneArr:function(a){return[].concat(a)}};Utils.each(["String","Function","Array","Number","RegExp","Object"],function(a,b){e.Utils["is"+b]=function(a){return Object.prototype.toString.apply(a)=="[object "+b+"]"}});var g=a.createClass("Command",{constructor:function(){this._isContentChange=!0,this._isSelectionChange=!1},execute:function(){},setContentChanged:function(a){this._isContentChange=!!a},isContentChanged:function(){return this._isContentChange},setSelectionChanged:function(a){this._isSelectionChange=!!a},isSelectionChanged:function(){return this._isContentChange},queryState:function(){return 0},queryValue:function(){return 0},isNeedUndo:function(){return!0}}),h=e.MinderNode=a.createClass("MinderNode",{constructor:function(a){this.parent=null,this.root=this,this.children=[],this.data={},this.tmpData={},this.initContainers(),Utils.isString(a)?this.setText(a):this.setData(a)},initContainers:function(){this.rc=(new a.Group).setId(e.uuid("minder_node")),this.rc.minderNode=this},isRoot:function(){return this.root===this},isLeaf:function(){return 0===this.children.length},getRoot:function(){return this.root||this},getParent:function(){return this.parent},getLevel:function(){for(var a=0,b=this.parent;b;)a++,b=b.parent;return a},getComplex:function(){var a=0;return this.traverse(function(){a++}),a},getType:function(){return this.type=["root","main","sub"][Math.min(this.getLevel(),2)],this.type},isAncestorOf:function(a){for(var b=a.parent;b;){if(b==this)return!0;b=b.parent}return!1},setText:function(a){return this.setData("text",a)},getText:function(){return this.getData("text")},preTraverse:function(a,b){var c=this.getChildren();b||a(this);for(var d=0;d<c.length;d++)c[d].preTraverse(a)},postTraverse:function(a,b){for(var c=this.getChildren(),d=0;d<c.length;d++)c[d].postTraverse(a);b||a(this)},traverse:function(a,b){return this.postTraverse(a,b)},getChildren:function(){return this.children},getIndex:function(){return this.parent?this.parent.children.indexOf(this):-1},insertChild:function(a,b){void 0===b&&(b=this.children.length),a.parent&&a.parent.removeChild(a),a.parent=this,a.root=this.root,this.children.splice(b,0,a)},appendChild:function(a){return this.insertChild(a)},prependChild:function(a){return this.insertChild(a,0)},removeChild:function(a){var b,c=a;a instanceof h&&(c=this.children.indexOf(a)),c>=0&&(b=this.children.splice(c,1)[0],b.parent=null,b.root=b)},getChild:function(a){return this.children[a]},getFirstChild:function(){return this.children[0]},getLastChild:function(){return this.children[this.children.length-1]},getData:function(a){return void 0===a?this.data:this.data[a]},setData:function(a,b){return void 0===a?this.data={}:f.isObject(a)?Utils.extend(this.data,a):void 0===b?(this.data[a]=null,delete this.data[a]):this.data[a]=b,this},getRenderContainer:function(){return this.rc},getCommonAncestor:function(a){return Utils.getNodeCommonAncestor(this,a)},contains:function(a){return this==a||this.isAncestorOf(a)},clone:function(){function a(b,c){var d=new KM.MinderNode;d.data=Utils.clonePlainObject(c.getData()),d.tmpData=Utils.clonePlainObject(c.getTmpData()),b&&b.appendChild(d);for(var e,f=0;e=c.children[f++];)a(d,e);return d}return a(null,this)},equals:function(a,b){function c(){e&&d.setSelectedFlag(),g&&a.setSelectedFlag()}var d=this;if(b){var e=!1,g=!1;d.isSelected()&&(e=!0,d.clearSelectedFlag()),a.isSelected()&&(g=!0,a.clearSelectedFlag())}if(a.children.length!=this.children.length)return c(),!1;if(f.compareObject(a.getData(),d.getData())===!1)return c(),!1;if(f.compareObject(a.getTmpData(),d.getTmpData())===!1)return c(),!1;for(var h,i=0;h=d.children[i];i++)if(h.equals(a.children[i],b)===!1)return c(),!1;return c(),!0},clearChildren:function(){this.children=[]},setTmpData:function(a,b){var c=this;f.isObject(a)&&f.each(a,function(a,b){c.setTmpData(a,b)}),void 0===b||null===b||""===b?delete this.tmpData[a]:this.tmpData[a]=b},getTmpData:function(a){return void 0===a?this.tmpData:this.tmpData[a]},setValue:function(a){return this.data={},this.setData(f.clonePlainObject(a.getData())),this.tmpData={},this.setTmpData(f.clonePlainObject(a.getTmpData())),this}});h.getCommonAncestor=function(a,b){if(a instanceof Array)return h.getCommonAncestor.apply(this,a);switch(arguments.length){case 1:return a.parent;case 2:if(a.isAncestorOf(b))return a;if(b.isAncestorOf(a))return b;for(var c=a.parent;c&&!c.isAncestorOf(b);)c=c.parent;return c;default:return Array.prototype.reduce.call(arguments,function(a,b){return h.getCommonAncestor(a,b)},a)}},function(){var a;e.registerModule=function(b,c){a||(a={}),a[b]=c},e.getModules=function(){return a}}();var i=a.createClass("MindEvent",{constructor:function(b,c,d){c=c||{},c.getType&&"ShapeEvent"==c.getType()?(this.kityEvent=c,this.originEvent=c.originEvent,this.getPosition=c.getPosition.bind(c)):c.target&&c.preventDefault?this.originEvent=c:a.Utils.extend(this,c),this.type=b,this._canstop=d||!1},getTargetNode:function(){var a=this.kityEvent&&this.kityEvent.targetShape;if(!a)return null;for(;!a.minderNode&&a.container;)a=a.container;return a.minderNode||null},stopPropagation:function(){this._stoped=!0},stopPropagationImmediately:function(){this._immediatelyStoped=!0,this._stoped=!0},shouldStopPropagation:function(){return this._canstop&&this._stoped},shouldStopPropagationImmediately:function(){return this._canstop&&this._immediatelyStoped},preventDefault:function(){this.originEvent.preventDefault()},isRightMB:function(){var a=!1;return this.originEvent?("which"in this.originEvent?a=3==this.originEvent.which:"button"in this.originEvent&&(a=2==this.originEvent.button),a):!1}}),j=e.Minder=a.createClass("KityMinder",{constructor:function(a){this._options=Utils.extend(b.KITYMINDER_CONFIG||{},a),this.setDefaultOptions(KM.defaultOptions),this._initEvents(),this._initMinder(),this._initSelection(),this._initStatus(),this._initShortcutKey(),this._initContextmenu(),this._initModules(),this.getOptions("readOnly")===!0&&this.setDisabled(),this.getRoot().render().layout(),this.fire("ready")},getOptions:function(a){var b;return a?(b=this.getPreferences(a),null===b||void 0===b?this._options[a]:b):(b=this.getPreferences(),b?f.extend(b,this._options,!0):this._options)},setDefaultOptions:function(a,b,c){var d={};Utils.isString(a)?d[a]=b:d=a,f.extend(this._options,d,!c)},setOptions:function(a,b){this.setPreferences(a,b)},_initMinder:function(){this._paper=new a.Paper,this._paper.getNode().setAttribute("contenteditable",!0),this._paper.getNode().ondragstart=function(a){a.preventDefault()},this._paper.shapeNode.setAttribute("transform","translate(0.5, 0.5)"),this._addRenderContainer(),this.setRoot(this.createNode(this.getLang().maintopic)),this._options.renderTo&&this.renderTo(this._options.renderTo)},_addRenderContainer:function(){this._rc=(new a.Group).setId(e.uuid("minder")),this._paper.addShape(this._rc)},renderTo:function(a){this._paper.renderTo(this._renderTarget=a),this._bindEvents()},getRenderContainer:function(){return this._rc},getPaper:function(){return this._paper},getRenderTarget:function(){return this._renderTarget},_initShortcutKey:function(){this._shortcutkeys={},this._bindshortcutKeys()},addShortcutKeys:function(a,b){var c={},d=this;b?c[a]=b:c=a,f.each(c,function(a,b){d._shortcutkeys[a.toLowerCase()]=b})},getShortcutKey:function(a){return this._shortcutkeys[a]},_bindshortcutKeys:function(){function a(a,b,c){switch(a){case"ctrl":case"cmd":if(c.ctrlKey||c.metaKey)return!0;break;case"alt":if(c.altKey)return!0;break;case"shift":if(c.shiftKey)return!0}return b==l[a]?!0:!1}var b=this,c=this._shortcutkeys;b.on("keydown",function(d){var e=d.originEvent,g=e.keyCode||e.which;for(var h in c){var i=c[h].toLowerCase().split("+"),j=0;if(f.each(i,function(b,c){a(c,g,e)&&j++}),j==i.length){-1!=b.queryCommandState(h)&&b.execCommand(h),e.preventDefault();break}}})},_initContextmenu:function(){this.contextmenus=[]},addContextmenu:function(a){return f.isArray(a)?this.contextmenus=this.contextmenus.concat(a):this.contextmenus.push(a),this},getContextmenu:function(){return this.contextmenus},_initStatus:function(){this._status="normal",this._rollbackStatus="normal"},setStatus:function(a){return a!=this._status&&(this.fire("statuschange",{lastStatus:this._status,currentStatus:a}),this._rollbackStatus=this._status,this._status=a),this},rollbackStatus:function(){this.setStatus(this._rollbackStatus)},getStatus:function(){return this._status},setDisabled:function(){var a=this;a.bkqueryCommandState=a.queryCommandState,a.bkqueryCommandValue=a.queryCommandValue,a.queryCommandState=function(b){var c=this._getCommand(b);return c&&c.enableReadOnly===!1?a.bkqueryCommandState.apply(a,arguments):-1},a.queryCommandValue=function(b){var c=this._getCommand(b);return c&&c.enableReadOnly===!1?a.bkqueryCommandValue.apply(a,arguments):null},this.setStatus("readonly"),a.fire("interactchange")},setEnabled:function(){var a=this;a.bkqueryCommandState&&(a.queryCommandState=a.bkqueryCommandState,delete a.bkqueryCommandState),a.bkqueryCommandValue&&(a.queryCommandValue=a.bkqueryCommandValue,delete a.bkqueryCommandValue),this.rollbackStatus(),a.fire("interactchange")}});Utils.extend(e,{compatibility:function(a){function b(a,c){c(a),a.children&&a.children.forEach(function(a){b(a,c)})}function c(a){var c=a.data.currentstyle;delete a.data.currentstyle,"bottom"==c?(a.template="structure",a.theme="snow"):"default"==c&&(a.template="default",a.theme="classic"),b(a,function(a){var b=a.data;"PriorityIcon"in b&&(b.priority=b.PriorityIcon,delete b.PriorityIcon),"ProgressIcon"in b&&(b.progress=1+(b.ProgressIcon-1<<1),delete b.ProgressIcon),delete b.point,delete b.layout})}var d=a.version||"1.1.3";switch(d){case"1.1.3":c(a);case"1.2.0":}return a}}),Utils.extend(e,{_protocals:{},registerProtocal:function(a,b){e._protocals[a]=b()},findProtocal:function(a){return e._protocals[a]||null},getSupportedProtocals:function(){return Utils.keys(e._protocals).sort(function(a,b){return e._protocals[b].recognizePriority-e._protocals[a].recognizePriority})},getAllRegisteredProtocals:function(){return e._protocals}});var k={root:"maintopic",main:"topic",sub:"topic"};a.extendClass(j,{exportData:function(a){function b(a){var c={};c.data=a.getData();var d=a.getChildren();if(d.length){c.children=[];for(var e=0;e<d.length;e++)c.children.push(b(d[e]))}return c}var c,d;return c=b(this.getRoot()),d=e.findProtocal(a),this._fire(new i("beforeexport",{json:c,protocalName:a,protocal:d},!0))!==!0?(c.template=this.getTemplate(),c.theme=this.getTheme(),c.version=e.version,d?d.encode(c,this):c):void 0},importData:function(a,b){var c,d;if(b?d=e.findProtocal(b):e.getSupportedProtocals().every(function(b){var c=e.findProtocal(b);return c.recognize&&c.recognize(a)&&(d=c),!d}),!d)throw this.fire("unknownprotocal"),new Error("Unsupported protocal: "+b);var f={local:a,protocalName:b,protocal:d},g=this._fire(new i("beforeimport",f,!0));if(g)return this;try{c=f.json||(f.json=d.decode(a))}catch(h){return this.fire("parseerror",{message:h.message})}if("object"==typeof c&&"then"in c){var j=this;c.then(function(a){f.json=a,j._doImport(a,f)}).error(function(){j.fire("parseerror")})}else this._doImport(c,f);return this},_doImport:function(a,b){function c(a,b,d){var e=b.data;a.data={};for(var f in e)a.setData(f,e[f]);a.setData("text",e.text||d.getLang(k[a.getType()]));for(var g=b.children||[],h=0;h<g.length;h++){var i=d.createNode(null,a);c(i,g[h],d)}return a}if(a){for(this._fire(new i("preimport",b,!1));this._root.getChildren().length;)this.removeNode(this._root.getChildren()[0]);a=e.compatibility(a),c(this._root,a,this),this.setTemplate(a.template||null),this.setTheme(a.theme||null),this.refresh(),this.fire("import",b),this._firePharse({type:"contentchange"}),this._firePharse({type:"interactchange"})}}}),a.extendClass(j,{_initEvents:function(){this._eventCallbacks={}},_bindEvents:function(){this._bindPaperEvents(),this._bindKeyboardEvents()},_resetEvents:function(){this._initEvents(),this._bindEvents()},_bindPaperEvents:function(){this._paper.on("click dblclick mousedown contextmenu mouseup mousemove mousewheel DOMMouseScroll touchstart touchmove touchend dragenter dragleave drop",this._firePharse.bind(this)),b&&(b.addEventListener("resize",this._firePharse.bind(this)),b.addEventListener("blur",this._firePharse.bind(this)))},_bindKeyboardEvents:function(){-1==navigator.userAgent.indexOf("iPhone")&&-1==navigator.userAgent.indexOf("iPod")&&-1==navigator.userAgent.indexOf("iPad")&&Utils.listen(document.body,"keydown keyup keypress paste",this._firePharse.bind(this))},_firePharse:function(a){var b,c,d;"DOMMouseScroll"==a.type&&(a.type="mousewheel",a.wheelDelta=a.originEvent.wheelDelta=-10*a.originEvent.detail,a.wheelDeltaX=a.originEvent.mozMovementX,a.wheelDeltaY=a.originEvent.mozMovementY),b=new i("before"+a.type,a,!0),this._fire(b)||(c=new i("pre"+a.type,a,!0),d=new i(a.type,a,!0),this._fire(c)||this._fire(d)||this._fire(new i("after"+a.type,a,!1)),~"mousedown mouseup keydown keyup".indexOf(a.type)&&this._interactChange(a))},_interactChange:function(){var a=this;clearTimeout(this._interactTimeout),this._interactTimeout=setTimeout(function(){var b=a._fire(new i("beforeinteractchange"));b||(a._fire(new i("preinteractchange")),a._fire(new i("interactchange")))},20)},_listen:function(a,b){var c=this._eventCallbacks[a]||(this._eventCallbacks[a]=[]);c.push(b)},_fire:function(a){var b=this.getStatus(),c=this._eventCallbacks[a.type.toLowerCase()]||[];if(b&&(c=c.concat(this._eventCallbacks[b+"."+a.type.toLowerCase()]||[])),0!==c.length){for(var d=this.getStatus(),e=0;e<c.length&&(c[e].call(this,a),this.getStatus()==d&&!a.shouldStopPropagationImmediately());e++);return a.shouldStopPropagation()}},on:function(a,b){var c=this;return f.each(a.split(/\s+/),function(a,d){c._listen(d.toLowerCase(),b)}),this},off:function(a,b){var c,d,e,f,g=a.split(/\s+/);for(c=0;c<g.length;c++)if(e=this._eventCallbacks[g[c].toLowerCase()]){for(f=null,d=0;d<e.length;d++)e[d]==b&&(f=d);null!==f&&e.splice(f,1)}},fire:function(a,b){var c=new i(a,b);return this._fire(c),this}}),a.extendClass(j,{_initModules:function(){var a=e.getModules(),b=this._options.modules||Utils.keys(a);this._commands={},this._query={},this._modules={},this._rendererClasses={};var c,d,f,g,h,i,j,k=this;for(c=0;c<b.length;c++)if(d=b[c],a[d]){g="function"==typeof a[d]?a[d].call(k):a[d],this._modules[d]=g,g.init&&g.init.call(k,this._options),h=g.commands;for(d in h)this._commands[d.toLowerCase()]=new h[d];if(i=g.events)for(f in i)k.on(f,i[f]);if(j=g.renderers)for(f in j)this._rendererClasses[f]=this._rendererClasses[f]||[],Utils.isArray(j[f])?this._rendererClasses[f]=this._rendererClasses[f].concat(j[f]):this._rendererClasses[f].push(j[f]);g.defaultOptions&&this.setDefaultOptions(g.defaultOptions),g.addShortcutKeys&&this.addShortcutKeys(g.addShortcutKeys),g.contextmenu&&this.addContextmenu(g.contextmenu)}},_garbage:function(){for(this.clearSelect();this._root.getChildren().length;)this._root.removeChild(0)},destroy:function(){var a=this._modules;this._resetEvents(),this._garbage();for(var b in a)a[b].destroy&&a[b].destroy.call(this)},reset:function(){var a=this._modules;this._garbage();for(var b in a)a[b].reset&&a[b].reset.call(this)}}),a.extendClass(j,{_getCommand:function(a){return this._commands[a.toLowerCase()]},_queryCommand:function(a,b,c){var d=this._getCommand(a);if(d){var e=d["query"+b];if(e)return e.apply(d,[this].concat(c))}return 0},queryCommandState:function(a){return this._queryCommand(a,"State",Utils.argsToArray(1))},queryCommandValue:function(a){return this._queryCommand(a,"Value",Utils.argsToArray(1))},execCommand:function(a){a=a.toLowerCase();var b,c,d,e,f=Utils.argsToArray(arguments,1),g=this;return b=this._getCommand(a),e={command:b,commandName:a.toLowerCase(),commandArgs:f},b?(!this._hasEnterExecCommand&&b.isNeedUndo()?(this._hasEnterExecCommand=!0,c=this._fire(new i("beforeExecCommand",e,!0)),c||(this._fire(new i("saveScene")),this._fire(new i("preExecCommand",e,!1)),d=b.execute.apply(b,[g].concat(f)),this._fire(new i("execCommand",e,!1)),this._fire(new i("saveScene")),b.isContentChanged()&&this._firePharse(new i("contentchange")),b.isSelectionChanged()&&this._firePharse(new i("selectionchange")),this._firePharse(new i("interactchange"))),this._hasEnterExecCommand=!1):(d=b.execute.apply(b,[g].concat(f)),this._hasEnterExecCommand||(b.isSelectionChanged()&&this._firePharse(new i("selectionchange")),this._firePharse(new i("interactchange")))),void 0===d?null:d):!1}}),a.extendClass(j,{getRoot:function(){return this._root},setRoot:function(a){this._root=a,a.minder=this},createNode:function(a,b,c){var d=new h(a);return this.fire("nodecreate",{node:d}),this.appendNode(d,b,c),d},appendNode:function(a,b,c){return b&&b.insertChild(a,c),this.attachNode(a),this},removeNode:function(a){a.parent&&(a.parent.removeChild(a),this.detachNode(a),this.fire("noderemove",{node:a}))},attachNode:function(a){var b=this._rc;a.traverse(function(a){a.attached=!0,b.addShape(a.getRenderContainer())}),b.addShape(a.getRenderContainer()),this.fire("nodeattach",{node:a})},detachNode:function(a){var b=this._rc;a.traverse(function(a){a.attached=!1,b.removeShape(a.getRenderContainer())}),this.fire("nodedetach",{node:a})},getMinderTitle:function(){return this.getRoot().getText()}}),a.extendClass(h,{getMinder:function(){return this.getRoot().minder}}),a.extendClass(j,{_initSelection:function(){this._selectedNodes=[]},renderChangedSelection:function(a){var b=this.getSelectedNodes(),c=[],d=0;for(b.forEach(function(b){-1==a.indexOf(b)&&(c.push(b),b.setTmpData("selected",!0))}),a.forEach(function(a){-1==b.indexOf(a)&&(c.push(a),a.setTmpData("selected",!1))});d<c.length;)c[d++].render()},getSelectedNodes:function(){return this._selectedNodes},getSelectedNode:function(){return this.getSelectedNodes()[0]||null},removeAllSelectedNodes:function(){var a=this._selectedNodes.splice(0);return this._selectedNodes=[],this.renderChangedSelection(a),this.fire("selectionclear")},removeSelectedNodes:function(a){var b=this,c=this._selectedNodes.slice(0);return a=Utils.isArray(a)?a:[a],Utils.each(a,function(a,c){var d;-1!==(d=b._selectedNodes.indexOf(c))&&b._selectedNodes.splice(d,1)}),this.renderChangedSelection(c),this},select:function(a,b){var c=this.getSelectedNodes().slice(0);b&&(this._selectedNodes=[]);var d=this;return a=Utils.isArray(a)?a:[a],Utils.each(a,function(a,b){-1===d._selectedNodes.indexOf(b)&&d._selectedNodes.push(b)}),this.renderChangedSelection(c),this},toggleSelect:function(a){return Utils.isArray(a)?a.forEach(this.toggleSelect.bind(this)):a.isSelected()?this.removeSelectedNodes(a):this.select(a),this},isSingleSelect:function(){return 1==this._selectedNodes.length},getSelectedAncestors:function(a){function b(a,b){for(var c=a.length-1;c>=0;--c)if(a[c].isAncestorOf(b))return!0;return!1}var c,d=this.getSelectedNodes().slice(0),e=[],f=d.indexOf(this.getRoot());for(~f&&!a&&d.splice(f,1),d.sort(function(a,b){return a.getLevel()-b.getLevel()});c=d.pop();)b(d,c)||e.push(c);return e}}),a.extendClass(h,{isSelected:function(){return this.getTmpData("selected")},clearSelectedFlag:function(){this.setTmpData("selected")},setSelectedFlag:function(){this.setTmpData("selected",!0)}});var l=e.keymap=function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c],b[c.toLowerCase()]=a[c]);return b}({Backspace:8,Tab:9,Enter:13,Shift:16,Control:17,Alt:18,CapsLock:20,Esc:27,Spacebar:32,PageUp:33,PageDown:34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,direction:{37:1,38:1,39:1,40:1},Insert:45,Del:46,NumLock:144,Cmd:91,CmdFF:224,F2:113,F3:114,F4:115,"=":187,"-":189,b:66,i:73,z:90,y:89,v:86,x:88,c:67,s:83,n:78,"/":191,".":190,controlKeys:{16:1,17:1,18:1,20:1,91:1,224:1},notContentChange:{13:1,9:1,33:1,34:1,35:1,36:1,16:1,17:1,18:1,20:1,91:1,37:1,38:1,39:1,40:1,113:1,114:1,115:1,144:1,27:1},isSelectedNodeKey:{37:1,38:1,39:1,40:1,13:1,9:1},a:65});a.extendClass(j,{getLang:function(a){var b=KM.LANG[this.getOptions("lang")];if(!b)throw Error("not import language file");a=(a||"").split(".");for(var c,d=0;(c=a[d++])&&(b=b[c],b););return b}}),KM.defaultOptions={zIndex:1e3,lang:"zh-cn",readyOnly:!1},a.extendClass(j,function(){var a="kityminder_preference",c=function(){var a=b.localStorage;return{saveLocalData:function(b,c){return a&&c?(a.setItem(b,c),!0):!1},getLocalData:function(b){return a?a.getItem(b):null},removeItem:function(b){a&&a.removeItem(b)}}}();return{setPreferences:function(b,d){var e={};Utils.isString(b)?e[b]=d:e=b;var g=c.getLocalData(a);g?(g=JSON.parse(g),f.extend(g,e)):g=e,c.saveLocalData(a,JSON.stringify(g))},getPreferences:function(b){var d=c.getLocalData(a);return d?(d=JSON.parse(d),b?d[b]:d):null},resetPreferences:function(a){var b=a?JSON.stringify(a):"";c.saveLocalData(b)}}}());{var m=e.browser=function(){var a=navigator.userAgent.toLowerCase(),c=b.opera,d={ie:/(msie\s|trident.*rv:)([\w.]+)/.test(a),opera:!!c&&c.version,webkit:a.indexOf(" applewebkit/")>-1,mac:a.indexOf("macintosh")>-1,quirks:"BackCompat"==document.compatMode,ipad:a.indexOf("ipad")>-1};d.gecko="Gecko"==navigator.product&&!d.webkit&&!d.opera&&!d.ie;var e=0;if(d.ie){var f=a.match(/(?:msie\s([\w.]+))/),g=a.match(/(?:trident.*rv:([\w.]+))/);e=f&&g&&f[1]&&g[1]?Math.max(1*f[1],1*g[1]):f&&f[1]?1*f[1]:g&&g[1]?1*g[1]:0,d.ie11Compat=11==document.documentMode,d.ie9Compat=9==document.documentMode,d.ie8=!!document.documentMode,d.ie8Compat=8==document.documentMode,d.ie7Compat=7==e&&!document.documentMode||7==document.documentMode,d.ie6Compat=7>e||d.quirks,d.ie9above=e>8,d.ie9below=9>e}if(d.gecko){var h=a.match(/rv:([\d\.]+)/);h&&(h=h[1].split("."),e=1e4*h[0]+100*(h[1]||0)+1*(h[2]||0))}return/chrome\/(\d+\.\d)/i.test(a)&&(d.chrome=+RegExp.$1),/(\d+\.\d)?(?:\.\d)?\s+safari\/?(\d+\.\d+)?/i.test(a)&&!/chrome/i.test(a)&&(d.safari=+(RegExp.$1||RegExp.$2)),d.opera&&(e=parseFloat(c.version())),d.webkit&&(e=parseFloat(a.match(/ applewebkit\/(\d+)/)[1])),d.version=e,d.isCompatible=!d.mobile&&(d.ie&&e>=6||d.gecko&&e>=10801||d.opera&&e>=9.5||d.air&&e>=1||d.webkit&&e>=522||!1),d}();m.ie,m.webkit,m.gecko,m.opera}Utils.extend(e,{_layout:{},registerLayout:function(a,b){e._layout[a]=b,e._defaultLayout||(e._defaultLayout=a)}}),a.extendClass(h,{getLayout:function(){var a=this.getData("layout");return a=a||(this.isRoot()?e._defaultLayout:this.parent.getLayout())},getOrder:function(){return this.getData("order")||this.getIndex()},setOrder:function(a){return this.setData("order",a)},getOrderHint:function(){return this.parent.getLayoutInstance().getOrderHint(this)},getExpandPosition:function(){return this.getLayoutInstance().getExpandPosition()},getLayoutInstance:function(){var a=e._layout[this.getLayout()],b=new a;return b},setLayoutTransform:function(a){this._layoutTransform=a},getLayoutTransform:function(){return this._layoutTransform||new a.Matrix},setLayoutVector:function(a){return this._layoutVector=a,this},getLayoutVector:function(){return this._layoutVector||new a.Vector},getGlobalLayoutTransform:function(){return this._lastLayoutTransform||new a.Matrix},getLayoutBox:function(){var a=this.getGlobalLayoutTransform();return a.transformBox(this.getContentBox())},getLayoutPoint:function(){var b=this.getGlobalLayoutTransform();return b.transformPoint(new a.Point)},getLayoutOffset:function(){var b=this.getData("layout_"+this.getLayout()+"_offset");return b?new a.Point(b.x,b.y):new a.Point},setLayoutOffset:function(a){return this.setData("layout_"+this.getLayout()+"_offset",a?{x:a.x,y:a.y}:null),this},setVertexIn:function(a){this._vertexIn=a},setVertexOut:function(a){this._vertexOut=a},getVertexIn:function(){return this._vertexIn||new a.Point},getVertexOut:function(){return this._vertexOut||new a.Point},getLayoutVertexIn:function(){return this.getGlobalLayoutTransform().transformPoint(this.getVertexIn())},getLayoutVertexOut:function(){return this.getGlobalLayoutTransform().transformPoint(this.getVertexOut())},getLayoutRoot:function(){return this.isLayoutRoot()?this:this.parent.getLayoutRoot()},isLayoutRoot:function(){return this.getData("layout")||this.isRoot()},layout:function(a,b){return a&&("inherit"==a?this.setData("layout"):this.setData("layout",a)),this.getMinder().layout(b),this}}),a.extendClass(j,{layout:function(a){function b(a){a.isExpanded()&&a.children.forEach(function(a){b(a)});var c=a.getLayoutInstance();c.doLayout(a)}return this.getRoot().traverse(function(a){a.setLayoutTransform(null)}),b(this.getRoot()),this.applyLayoutResult(this.getRoot(),a),this.fire("layout")},refresh:function(a){return this.getRoot().renderTree(),this.layout(a).fire("contentchange").fire("interactchange"),this},applyLayoutResult:function(b,c){function d(a,b){a.getRenderContainer().setMatrix(a._lastLayoutTransform=b),f.fire("layoutapply",{node:a,matrix:b})}function e(b,g){var h=b.getLayoutTransform().merge(g),i=b._lastLayoutTransform||new a.Matrix,j=b.getLayoutOffset();h.translate(j.x,j.y),h.m.e=Math.round(h.m.e),h.m.f=Math.round(h.m.f),h.equals(i)||(b._layoutTimeline&&(b._layoutTimeline.stop(),b._layoutTimeline=null),c?b._layoutTimeline=new a.Animator(i,h,d).start(b,c+300,"ease").on("finish",function(){a.Timeline.requestFrame(function(){d(b,h),f.fire("layoutfinish",{node:b,matrix:h})})}):(d(b,h),f.fire("layoutfinish",{node:b,matrix:h})));for(var k=0;k<b.children.length;k++)e(b.children[k],h)}b=b||this.getRoot();var f=this;return e(b,b.parent?b.parent.getGlobalLayoutTransform():new a.Matrix),this}});var n=a.createClass("Layout",{doLayout:function(){throw new Error("Not Implement: Layout.doLayout()")},getBranchBox:function(a){var b,c,d,f,g={x:0,y:0,height:0,width:0},h=e.Geometry;for(b=0;b<a.length;b++)c=a[b],d=c.getLayoutTransform(),f=c.getContentBox(),g=h.mergeBox(g,d.transformBox(f));return g},getTreeBox:function(a){var b,c,d,f,g=e.Geometry,h={x:0,y:0,height:0,width:0};for(a instanceof Array||(a=[a]),b=0;b<a.length;b++)c=a[b],d=c.getLayoutTransform(),f=c.getContentBox(),c.children.length&&(f=g.mergeBox(f,this.getTreeBox(c.children))),h=g.mergeBox(h,d.transformBox(f));return h},getOrderHint:function(){return[]}});f.extend(e,{_connectProviders:{},_defaultConnectProvider:function(a,b,c){c.setPathData(["M",b.getLayoutPoint(),"L",a.getLayoutPoint()])},registerConnectProvider:function(a,b){e._connectProviders[a]=b},getConnectProvider:function(a){return e._connectProviders[a]||e._defaultConnectProvider}}),a.extendClass(j,{createConnect:function(b){if(!b.isRoot()){var c=new a.Path;b._connection=c,this._connectContainer||(this._connectContainer=(new a.Group).setId(e.uuid("minder_connect_group")),this.getRenderContainer().prependShape(this._connectContainer)),this._connectContainer.addShape(c),this.updateConnect(b)}},removeConnect:function(a){var b=this;a.traverse(function(a){b._connectContainer.removeShape(a._connection)})},updateConnect:function(a){var b=a._connection,c=a.parent;if(c){if(c.isCollapsed())return void b.setVisible(!1);b.setVisible(!0);var d=e.getConnectProvider(c.getLayout()),f=a.getStyle("connect-color")||"white",g=a.getStyle("connect-width")||2;b.stroke(f,g),d(a,c,b,g,f)}}}),e.registerModule("Connect",{events:{nodeattach:function(a){this.createConnect(a.node)},nodedetach:function(a){this.removeConnect(a.node)},"layoutapply noderender":function(a){this.updateConnect(a.node)}}});var o=e.Renderer=a.createClass("Renderer",{constructor:function(a){this.node=a},create:function(){throw new Error("Not implement: Renderer.create()")},shouldRender:function(){return!0},update:function(){throw new Error("Not implement: Renderer.update()")},getRenderShape:function(){return this._renderShape||null},setRenderShape:function(a){this._renderShape=a}});a.extendClass(j,function(){function b(a,b){var c=[];["center","left","right","top","bottom","outline","outside"].forEach(function(a){var d="before"+a,e="after"+a;b[d]&&(c=c.concat(b[d])),b[a]&&(c=c.concat(b[a])),b[e]&&(c=c.concat(b[e]))}),a._renderers=c.map(function(b){return new b(a)})}return{renderNodeBatch:function(c){var d,e,f,g,h=this._rendererClasses,i=[],j=0;if(c.length){for(e=0;e<c.length;e++)g=c[e],g._renderers||b(g,h),g._contentBox=new a.Box,this.fire("beforerender",{node:g});
for(j=c[0]._renderers.length,d=0;j>d;d++){for(e=0;e<c.length;e++)"function"==typeof i[e]&&(i[e]=i[e]()),i[e]instanceof a.Box||(i[e]=new a.Box(i[e]));for(e=0;e<c.length;e++)g=c[e],f=g._renderers[d],i[e]&&(g._contentBox=g._contentBox.merge(i[e])),f.shouldRender(g)?(f.getRenderShape()||(f.setRenderShape(f.create(g)),f.bringToBack?g.getRenderContainer().prependShape(f.getRenderShape()):g.getRenderContainer().appendShape(f.getRenderShape())),f.getRenderShape().setVisible(!0),i[e]=f.update(f.getRenderShape(),g,g._contentBox)):f.getRenderShape()&&(f.getRenderShape().setVisible(!1),i[e]=null)}for(e=0;e<c.length;e++)this.fire("afterrender",{node:g})}},renderNode:function(a){var c,d=this._rendererClasses,f=e.Geometry;a._renderers||b(a,d),this.fire("beforerender",{node:a}),a._contentBox=f.wrapBox({left:0,right:0,top:0,bottom:0}),a._renderers.forEach(function(b){b.shouldRender(a)?(b.getRenderShape()||(b.setRenderShape(b.create(a)),b.bringToBack?a.getRenderContainer().prependShape(b.getRenderShape()):a.getRenderContainer().appendShape(b.getRenderShape())),b.getRenderShape().setVisible(!0),c=b.update(b.getRenderShape(),a,a._contentBox),"function"==typeof c&&(c=c()),c&&(a._contentBox=f.mergeBox(a._contentBox,c))):b.getRenderShape()&&b.getRenderShape().setVisible(!1)}),this.fire("noderender",{node:a})}}}()),a.extendClass(h,{render:function(){return this.attached?(this.getMinder().renderNode(this),this):void 0},renderTree:function(){if(this.attached){var a=[];return this.traverse(function(b){a.push(b)}),this.getMinder().renderNodeBatch(a),this}},getRenderer:function(a){for(var b=this._renderers,c=0;c<b.length;c++)if(b[c].getType()==a)return b[c];return null},getContentBox:function(){return this.parent&&this.parent.isCollapsed()?new a.Box:this._contentBox||new a.Box}});var p={left:function(a){return 3 in a&&a[3]||1 in a&&a[1]||a[0]},right:function(a){return 1 in a&&a[1]||a[0]},top:function(a){return a[0]},bottom:function(a){return 2 in a&&a[2]||a[0]}};Utils.extend(e,{_themes:{},registerTheme:function(a,b){e._themes[a]=b},getThemeList:function(){return e._themes}}),a.extendClass(j,{useTheme:function(a){return this.setTheme(a),this.refresh(800),!0},setTheme:function(a){this._theme=a||null,this.getPaper().getContainer().style.background=this.getStyle("background")},getTheme:function(){return this._theme||this.getOptions("defaultTheme")},getThemeItems:function(a){this.getTheme(a);return e._themes[this.getTheme(a)]},getStyle:function(a,b){var c,d,e,f,g=this.getThemeItems(b);if(a in g)return g[a];if(c=a.split("-"),c.length<2)return null;if(d=c.pop(),a=c.join("-"),a in g){if(e=g[a],Utils.isArray(e)&&(f=p[d]))return f(e);if(!isNaN(e))return e}return null},getNodeStyle:function(a,b){var c=this.getStyle(a.getType()+"-"+b,a);return null!==c?c:this.getStyle(b,a)}}),a.extendClass(h,{getStyle:function(a){return this.getMinder().getNodeStyle(this,a)}}),e.registerModule("Theme",{defaultOptions:{defaultTheme:"fresh-blue"},commands:{theme:a.createClass("ThemeCommand",{base:g,execute:function(a,b){return a.useTheme(b)},queryValue:function(a){return a.getTheme()||"default"}})}}),f.extend(e,{_templates:{},registerTemplate:function(a,b){e._templates[a]=b},getTemplateList:function(){return e._templates}}),e.registerTemplate("default",{}),a.extendClass(j,function(){var a=j.prototype.getTheme;return{useTemplate:function(a,b){this.setTemplate(a),this.refresh(b||800)},getTemplate:function(){return this._template||null},setTemplate:function(a){this._template=a||null},getTemplateSupports:function(){return e._templates[this._template]||null},getTheme:function(b){var c=this.getTemplateSupports();return c&&c.getTheme?c.getTheme(b):a.call(this,b)}}}()),a.extendClass(h,function(){var a=h.prototype.getLayout;return{getLayout:function(){var b=this.getMinder().getTemplateSupports();return b&&b.getLayout?b.getLayout(this):a.call(this)}}}()),e.registerModule("TemplateModule",{commands:{template:a.createClass("TemplateCommand",{base:g,execute:function(a,b){a.useTemplate(b)},queryValue:function(a){return a.getTemplate()||"default"}})}}),e.registerLayout("default",a.createClass({base:n,doLayout:function(a){var b=this;a.isLayoutRoot()?this.doLayoutRoot(a):this.arrange(a,a.children,b.getSide(a))},getSide:function(a){for(;!a.parent.isLayoutRoot();)a=a.parent;var b=a.getIndex(),c=a.parent.children.length;return c/2>b?"right":"left"},doLayoutRoot:function(a){var b=a.getChildren(),c={left:[],right:[]},d=this;b.forEach(function(a){c[d.getSide(a)].push(a)}),this.arrange(a,c.left,"left"),this.arrange(a,c.right,"right")},arrange:function(b,c,d){if(c.length){var e,f,g,h,i,j,k,l=this,m=0,n=c.map(function(a,b,c){var d=l.getTreeBox([a]);return m+=d.height,b>0&&(m+=c[b-1].getStyle("margin-bottom"),m+=a.getStyle("margin-top")),d}),o=b.getContentBox();for(g=-m/2,"left"!=d?(b.setVertexOut(new a.Point(o.right,o.cy)),b.setLayoutVector(new a.Vector(1,0))):(b.setVertexOut(new a.Point(o.left,o.cy)),b.setLayoutVector(new a.Vector(-1,0))),e=0;e<c.length;e++)h=c[e],i=n[e],j=h.getContentBox(),j.height&&("right"==d?(f=o.right-j.left,f+=b.getStyle("margin-right")+h.getStyle("margin-left")):(f=o.left-j.right,f-=b.getStyle("margin-left")+h.getStyle("margin-right")),e>0&&(g+=c[e].getStyle("margin-top")),g-=i.top,k=(new a.Matrix).translate(f,g),h.setLayoutTransform(k),g+=i.bottom+h.getStyle("margin-bottom"));if(b.isRoot()){var p=this.getBranchBox(c),q=p.cy-o.cy;c.forEach(function(a){a.getLayoutTransform().translate(0,-q)})}}},getOrderHint:function(a){var b=[],c=a.getLayoutBox(),d=5;return b.push({type:"up",node:a,area:{x:c.x,y:c.top-a.getStyle("margin-top")-d,width:c.width,height:a.getStyle("margin-top")},path:["M",c.x,c.top-d,"L",c.right,c.top-d]}),b.push({type:"down",node:a,area:{x:c.x,y:c.bottom+d,width:c.width,height:a.getStyle("margin-bottom")},path:["M",c.x,c.bottom+d,"L",c.right,c.bottom+d]}),b}}));var q=(new a.Marker).pipe(function(){var b=7,c=new a.Circle(b-1);this.addShape(c),this.setRef(b-1,0).setViewBox(-b,-b,b+b,b+b).setWidth(b).setHeight(b),this.dot=c,this.node.setAttribute("markerUnits","userSpaceOnUse")});e.registerConnectProvider("default",function(b,c,d,e,f){var g,h,i,j=b.getLayoutBox(),k=c.getLayoutBox(),l=Math.abs,m=[],n=j.x>k.x?"right":"left";switch(b.getMinder().getPaper().addResource(q),b.getType()){case"main":g=new a.Point(k.cx,k.cy),h="left"==n?new a.Point(j.right+2,j.cy):new a.Point(j.left-2,j.cy),i=a.Vector.fromPoints(g,h),m.push("M",g),m.push("A",l(i.x),l(i.y),0,0,i.x*i.y>0?0:1,h),d.setMarker(q),q.dot.fill(f);break;case"sub":var o,p,r,s,t=(b.getStyle("connect-radius"),j.bottom+3),u="sub"==c.getType()?k.bottom+3:k.cy;"right"==n?(o=new a.Point(k.right+10,u),p=new a.Point(j.left,t),r=new a.Point(j.right+10,t)):(o=new a.Point(k.left-10,u),p=new a.Point(j.right,t),r=new a.Point(j.left-10,t)),s=(o.x+p.x)/2,e%2===0&&(o.y+=.5,p.y+=.5,r.y+=.5),m.push("M",o),m.push("C",s,o.y,s,p.y,p),m.push("L",r),d.setMarker(null)}d.setPathData(m)}),b.layoutSwitch=!0,e.registerLayout("bottom",a.createClass({base:n,doLayout:function(b){var c=b.getChildren();if(!c.length)return!1;var d,e,f,g,h,i,j,k,l=b.getContentBox();for(e=f=l.left,d=0;d<c.length;d++)h=c[d],j=h.getContentBox(),i=this.getTreeBox(h),k=new a.Matrix,j.width&&(d>0&&(f+=h.getStyle("margin-left")),f-=i.left,k.translate(f,0),f+=i.right,d<c.length-1&&(f+=h.getStyle("margin-right")),g=l.bottom-i.top+b.getStyle("margin-bottom")+h.getStyle("margin-top"),k.translate(0,g),h.setLayoutTransform(k),h.setVertexIn(new a.Point(j.cx,j.top)));b.setLayoutVector(new a.Vector(0,1)),b.setVertexOut(new a.Point(l.cx,l.bottom));var m=(f-e-l.width)/2;c.forEach(function(a){a.getLayoutTransform().translate(-m,0)})},getOrderHint:function(a){var b=[],c=a.getLayoutBox(),d=3;return b.push({type:"up",node:a,area:{x:c.left-a.getStyle("margin-left")-d,y:c.top,width:a.getStyle("margin-left"),height:c.height},path:["M",c.left-d,c.top,"L",c.left-d,c.bottom]}),b.push({type:"down",node:a,area:{x:c.right+d,y:c.top,width:a.getStyle("margin-right"),height:c.height},path:["M",c.right+d,c.top,"L",c.right+d,c.bottom]}),b}})),e.registerConnectProvider("bottom",function(b,c,d){var e=c.getLayoutVertexOut(),f=b.getLayoutVertexIn(),g=[],h=Math.round;g.push("M",new a.Point(h(e.x),e.y)),g.push("L",new a.Point(h(e.x),e.y+c.getStyle("margin-bottom"))),g.push("L",new a.Point(h(f.x),e.y+c.getStyle("margin-bottom"))),g.push("L",new a.Point(h(f.x),f.y)),d.setMarker(null),d.setPathData(g)}),b.layoutSwitch=!0,e.registerLayout("filetree",a.createClass({base:n,doLayout:function(a){a.isLayoutRoot()?this.doLayoutRoot(a):this.arrange(a)},doLayoutRoot:function(a){this.arrange(a)},arrange:function(b){var c=b.getChildren(),d=this;if(!c.length)return!1;var e,f,g,h,i,j,k=c.map(function(a){var b=d.getTreeBox([a]);return b}),l=b.getContentBox(),m=new a.Matrix;for(b.setVertexOut(new a.Point(0,l.bottom)),b.setLayoutVector(new a.Vector(0,1)),g=l.bottom+b.getStyle("margin-bottom"),e=0;e<c.length;e++)h=c[e],i=k[e],j=h.getContentBox(),f=h.getStyle("margin-left")-j.left,j.width&&(g+=h.getStyle("margin-top"),g-=i.top,m=(new a.Matrix).translate(f,g),h.setLayoutTransform(m),g+=i.bottom+h.getStyle("margin-bottom"))},getOrderHint:function(a){var b=[],c=a.getLayoutBox(),d=a.getLevel()>1?3:5;return b.push({type:"up",node:a,area:{x:c.x,y:c.top-a.getStyle("margin-top")-d,width:c.width,height:a.getStyle("margin-top")},path:["M",c.x,c.top-d,"L",c.right,c.top-d]}),b.push({type:"down",node:a,area:{x:c.x,y:c.bottom+d,width:c.width,height:a.getStyle("margin-bottom")},path:["M",c.x,c.bottom+d,"L",c.right,c.bottom+d]}),b}})),e.registerConnectProvider("filetree",function(b,c,d){var e=b.getLayoutBox(),f=c.getLayoutBox(),g=[],h=c.getLayoutPoint().x,i=Math.round;g.push("M",new a.Point(i(h),i(f.bottom))),g.push("L",new a.Point(i(h),i(e.cy))),g.push("L",new a.Point(i(e.left),i(e.cy))),d.setPathData(g)}),e.registerTheme("classic",{background:"#3A4144 url(themes/default/images/grid.png) repeat","root-color":"#430","root-background":"#e9df98","root-stroke":"#e9df98","root-font-size":24,"root-padding":[15,25],"root-margin":[30,100],"root-radius":30,"root-space":10,"root-shadow":"rgba(0, 0, 0, .25)","main-color":"#333","main-background":"#a4c5c0","main-stroke":"#a4c5c0","main-font-size":16,"main-padding":[6,20],"main-margin":20,"main-radius":10,"main-space":5,"main-shadow":"rgba(0, 0, 0, .25)","sub-color":"white","sub-background":"none","sub-stroke":"none","sub-font-size":12,"sub-padding":[5,10],"sub-margin":[15,20],"sub-tree-margin":30,"sub-radius":5,"sub-space":5,"connect-color":"white","connect-width":2,"connect-radius":5,"selected-background":"rgb(254, 219, 0)","selected-stroke":"rgb(254, 219, 0)","selected-color":"black","marquee-background":"rgba(255,255,255,.3)","marquee-stroke":"white","drop-hint-color":"yellow","sub-drop-hint-width":2,"main-drop-hint-width":4,"root-drop-hint-width":4,"order-hint-area-color":"rgba(0, 255, 0, .5)","order-hint-path-color":"#0f0","order-hint-path-width":1,"text-selection-color":"rgb(27,171,255)"}),e.registerTheme("snow",{background:"#3A4144 url(themes/default/images/grid.png) repeat","root-color":"#430","root-background":"#e9df98","root-stroke":"#e9df98","root-font-size":24,"root-padding":[15,25],"root-margin":30,"root-radius":5,"root-space":10,"root-shadow":"rgba(0, 0, 0, .25)","main-color":"#333","main-background":"#a4c5c0","main-stroke":"#a4c5c0","main-font-size":16,"main-padding":[6,20],"main-margin":[20,40],"main-radius":5,"main-space":5,"main-shadow":"rgba(0, 0, 0, .25)","sub-color":"black","sub-background":"white","sub-stroke":"white","sub-font-size":12,"sub-padding":[5,10],"sub-margin":[10,20],"sub-radius":5,"sub-space":5,"connect-color":"white","connect-width":2,"connect-radius":5,"selected-background":"rgb(254, 219, 0)","selected-stroke":"rgb(254, 219, 0)","marquee-background":"rgba(255,255,255,.3)","marquee-stroke":"white","drop-hint-color":"yellow","drop-hint-width":4,"order-hint-area-color":"rgba(0, 255, 0, .5)","order-hint-path-color":"#0f0","order-hint-path-width":1,"text-selection-color":"rgb(27,171,255)"}),function(){function b(b,c,d){return a.Color.createHSL(b,c,d)}function c(a){return{background:"#fbfbfb","root-color":"white","root-background":b(a,37,60),"root-stroke":b(a,37,60),"root-font-size":16,"root-padding":[12,24],"root-margin":[30,100],"root-radius":5,"root-space":10,"main-color":"black","main-background":b(a,33,95),"main-stroke":b(a,37,60),"main-stroke-width":1,"main-font-size":14,"main-padding":[6,20],"main-margin":20,"main-radius":3,"main-space":5,"sub-color":"black","sub-background":"none","sub-stroke":"none","sub-font-size":12,"sub-padding":[5,10],"sub-margin":[15,20],"sub-tree-margin":30,"sub-radius":5,"sub-space":5,"connect-color":b(a,37,60),"connect-width":1,"connect-radius":5,"selected-stroke":b(a,26,30),"selected-stroke-width":"3","marquee-background":b(a,100,80).set("a",.1),"marquee-stroke":b(a,37,60),"drop-hint-color":b(a,26,35),"drop-hint-width":5,"order-hint-area-color":b(a,100,30).set("a",.5),"order-hint-path-color":b(a,100,25),"order-hint-path-width":1,"text-selection-color":b(a,100,20)}}var d={red:0,soil:25,green:122,blue:204,purple:246,pink:334};for(var f in d)e.registerTheme("fresh-"+f,c(d[f]))}(),e.registerTemplate("structure",{getLayout:function(){return"bottom"}}),e.registerTemplate("filetree",{getLayout:function(a){return a.getData("layout")?a.getData("layout"):a.isRoot()?"bottom":"filetree"}});var r=a.createClass("AppendChildCommand",{base:g,execute:function(a,b){var c=a.getSelectedNode();if(!c)return null;c.expand();var d=a.createNode(b,c);a.select(d,!0),d.render(),d._lastLayoutTransform=c._lastLayoutTransform,a.layout(300)},queryState:function(a){var b=a.getSelectedNode();return b?0:-1}}),s=a.createClass("AppendSiblingCommand",{base:g,execute:function(a,b){var c=a.getSelectedNode(),d=c.parent;if(!d)return a.execCommand("AppendChildNode",b);var e=a.createNode(b,d,c.getIndex()+1);a.select(e,!0),e.render(),e._lastLayoutTransform=c._lastLayoutTransform,a.layout(300)},queryState:function(a){var b=a.getSelectedNode();return b?0:-1}}),t=a.createClass("RemoverNodeCommand",{base:g,execute:function(a){var b=a.getSelectedNodes(),c=h.getCommonAncestor.apply(null,b);b.forEach(function(b){b.isRoot()||a.removeNode(b)}),a.select(c||a.getRoot(),!0),a.layout(300)},queryState:function(a){var b=a.getSelectedNode();return b?0:-1}}),u=a.createClass("EditNodeCommand",{base:g,execute:function(a){var b=a.getSelectedNode();return b?(a.select(b,!0),void a.textEditNode(b)):null},queryState:function(a){var b=a.getSelectedNode();return b?0:-1},isNeedUndo:function(){return!1}});e.registerModule("NodeModule",function(){return{commands:{AppendChildNode:r,AppendSiblingNode:s,RemoveNode:t,EditNode:u},contextmenu:[{label:this.getLang("node.appendsiblingnode"),exec:function(){this.execCommand("AppendSiblingNode",this.getLang("topic"))},cmdName:"appendsiblingnode"},{label:this.getLang("node.appendchildnode"),exec:function(){this.execCommand("AppendChildNode",this.getLang("topic"))},cmdName:"appendchildnode"},{label:this.getLang("node.editnode"),exec:function(){this.execCommand("EditNode")},cmdName:"editnode"},{label:this.getLang("node.removenode"),cmdName:"RemoveNode"},{divider:1}]}});var v=e.TextRenderer=a.createClass("TextRenderer",{base:o,create:function(){return(new a.Text).setId(e.uuid("node_text")).setVerticalAlign("middle").setAttr("text-rendering","default")},update:function(b,c){this.setTextStyle(c,b.setContent(c.getText()));var d=b.getBoundaryBox(),e=Math.round;return a.Browser.ie&&(d.y+=1),function(){return new a.Box(e(d.x),e(d.y),e(d.width),e(d.height))}},setTextStyle:function(a,b){var c=v._styleHooks;c.forEach(function(c){c(a,b)})}});f.extend(v,{_styleHooks:[],registerStyleHook:function(a){v._styleHooks.push(a)}}),a.extendClass(h,{getTextShape:function(){return this.getRenderer("TextRenderer").getRenderShape()}}),e.registerModule("text",{renderers:{center:v}}),e.registerModule("Expand",function(){function b(a,b){return function(c,e,f,g){var h,i,j;for(c.setData(d,e),g=g||1,h=c.getChildren(),j=0;j<h.length;j++)i=h[j],a>=g?f(i,e,f,g+1):b&&b(i,e,f,g+1)}}function c(a,b,c){c=c||j.KEEP_STATE,c(a,b,c),a.traverse(function(a){a.render()}),a.getMinder().layout(100)}var d="expandState",f="expand",i="collapse",j=h.EXPAND_POLICY={KEEP_STATE:function(a,b){a.setData(d,b)},generateDeepPolicy:b,DEEP_TO_CHILD:b(2),DEEP_TO_LEAF:b(Number.MAX_VALUE)};a.extendClass(h,{expand:function(a){return c(this,f,a),this},collapse:function(a){return c(this,i,a),this},isExpanded:function(){var a=this.getData(d)!==i;return a&&(this.isRoot()||this.parent.isExpanded())},isCollapsed:function(){return!this.isExpanded()}});var k=a.createClass("ExpandNodeCommand",{base:g,execute:function(a){var b=a.getRoot().getChildren();b.forEach(function(a){a.expand(j.DEEP_TO_LEAF)})},queryState:function(){return 0}}),m=a.createClass("CollapseNodeCommand",{base:g,execute:function(a){var b=a.getRoot().getChildren();b.forEach(function(a){a.collapse()})},queryState:function(){return 0}}),n=a.createClass("Expander",{base:a.Group,constructor:function(b){this.callBase(),this.radius=5,this.outline=new a.Circle(this.radius).stroke("gray").fill("white"),this.sign=(new a.Path).stroke("black"),this.addShapes([this.outline,this.sign]),this.initEvent(b),this.setId(e.uuid("node_expander")),this.setStyle("cursor","pointer")},initEvent:function(a){this.on("mousedown",function(b){a.isExpanded()?a.collapse():a.expand(),b.stopPropagation(),b.preventDefault()}),this.on("dblclick click mouseup",function(a){a.stopPropagation(),a.preventDefault()})},setState:function(a){if("hide"==a)return void this.setVisible(!1);this.setVisible(!0);var b=["M",1.5-this.radius,0,"L",this.radius-1.5,0];a==i&&b.push(["M",0,1.5-this.radius,"L",0,this.radius-1.5]),this.sign.setPathData(b)}}),p=a.createClass("ExpanderRenderer",{base:o,create:function(a){return a.isRoot()?void 0:(this.expander=new n(a),a.getRenderContainer().prependShape(this.expander),a.expanderRenderer=this,this.node=a,this.expander)},shouldRender:function(a){return!a.isRoot()},update:function(a,b){if(b.parent){var c=b.parent.isExpanded();a.setState(c&&b.children.length?b.getData(d):"hide");var e=b.getLayoutVector().normalize(a.radius+b.getStyle("stroke-width")),f=b.getVertexOut().offset(e);this.expander.setTranslate(f)}}});return{commands:{ExpandNode:k,CollapseNode:m},events:{layoutapply:function(a){var b=a.node.getRenderer("ExpanderRenderer");b.getRenderShape()&&b.update(b.getRenderShape(),a.node)},beforerender:function(a){var b=a.node,c=!b.parent||b.parent.isExpanded();b.getRenderContainer().setVisible(c),c||a.stopPropagation()},"normal.keydown":function(a){if("textedit"!=this.getStatus()&&a.originEvent.keyCode==l["/"]){var b=this.getSelectedNode().isExpanded();this.getSelectedNodes().forEach(function(a){b?a.collapse():a.expand()}),a.preventDefault(),a.stopPropagationImmediately()}}},renderers:{outside:p}}});var w=a.createClass("OutlineRenderer",{base:o,create:function(){var b=(new a.Rect).setId(e.uuid("node_outline"));return this.bringToBack=!0,b},update:function(a,b,c){var d=b.getStyle("padding-left"),e=b.getStyle("padding-right"),f=b.getStyle("padding-top"),g=b.getStyle("padding-bottom"),h={x:c.x-d,y:c.y-f,width:c.width+d+e,height:c.height+f+g},i=b.isSelected()?"selected-":"";return a.setPosition(h.x,h.y).setSize(h.width,h.height).setRadius(b.getStyle("radius")).fill(b.getStyle(i+"background")||b.getStyle("background")).stroke(b.getStyle(i+"stroke"||b.getStyle("stroke")),b.getStyle(i+"stroke-width")),h}}),x=a.createClass("ShadowRenderer",{base:o,create:function(){return this.bringToBack=!0,new a.Rect},shouldRender:function(a){return a.getStyle("shadow")},update:function(a,b,c){a.setPosition(c.x+4,c.y+5).setSize(c.width,c.height).fill(b.getStyle("shadow")).setRadius(b.getStyle("radius"))}}),y=/wire/.test(b.location.href),z=a.createClass("WireframeRenderer",{base:o,create:function(){var b=new a.Group,c=this.oxy=(new a.Path).stroke("#f6f").setPathData("M0,-50L0,50M-50,0L50,0"),d=this.wireframe=(new a.Rect).stroke("lightgreen");return b.addShapes([c,d])},shouldRender:function(){return y},update:function(a,b,c){this.wireframe.setPosition(c.x,c.y).setSize(c.width,c.height)}});e.registerModule("OutlineModule",function(){return{renderers:{outline:w,outside:[x,z]}}}),e.Geometry=function(){function b(a){return a.width=a.right-a.left,a.height=a.bottom-a.top,a.x=a.left,a.y=a.top,a.cx=a.x+a.width/2,a.cy=a.y+a.height/2,a}function c(a){"x"in a&&(a.left=a.x,a.right=a.x+a.width,a.top=a.y,a.bottom=a.y+a.height)}var d={},e=Math.min,g=Math.max,h=(Math.abs,Object.prototype.hasOwnProperty);return d.isNumberInRange=function(a,b){return a>b[0]&&a<b[1]},d.getDistance=function(b,c){return a.Vector.fromPoints(b,c).length()},d.wrapBox=b,d.getBox=function(a,c){return b({left:e(a.x,c.x),right:g(a.x,c.x),top:e(a.y,c.y),bottom:g(a.y,c.y)})},d.mergeBox=function(a,d){return c(a),c(d),b({left:e(a.left,d.left),right:g(a.right,d.right),top:e(a.top,d.top),bottom:g(a.bottom,d.bottom)})},d.getBoxRange=function(a){return{x:[a.left,a.right],y:[a.top,a.bottom]}},d.getBoxVertex=function(a){return{leftTop:{x:a.left,y:a.top},rightTop:{x:a.right,y:a.top},leftBottom:{x:a.left,y:a.bottom},rightBottom:{x:a.right,y:a.bottom}}},d.isPointInsideBox=function(a,b){c(b);var e=d.getBoxRange(b);return d.isNumberInRange(a.x,e.x)&&d.isNumberInRange(a.y,e.y)},d.getIntersectBox=function(a,d){c(a),c(d);var f=g(a.left,d.left),h=g(a.top,d.top),i=e(a.right,d.right),j=e(a.bottom,d.bottom);return i>f&&j>h?b({left:f,right:i,top:h,bottom:j}):null},d.snapToSharp=function(a){return f.isNumber(a)?(0|a)+.5:f.isArray(a)?a.map(d.snapToSharp):(["x","y","left","top","right","bottom"].forEach(function(b){h.call(a,b)&&(a[b]=d.snapToSharp(a[b]))}),a)},d.expandBox=function(a,c,d){return void 0===d&&(d=c),b({left:a.left-c,top:a.top-d,right:a.right+c,bottom:a.bottom+d})},d}(),e.registerModule("HistoryModule",function(){var b=this,c=a.createClass("Scene",{constructor:function(a,b){this.data=a.clone(),this.inputStatus=b},getData:function(){return this.data},cloneData:function(){return this.getData().clone()},equals:function(a){return this.getData().equals(a.getData())},isInputStatus:function(){return this.inputStatus},setInputStatus:function(a){this.inputStatus=a}}),d=a.createClass("HistoryManager",{constructor:function(a){this.list=[],this.index=0,this.hasUndo=!1,this.hasRedo=!1,this.km=a},undo:function(){if(this.hasUndo){var a=this.list[this.index];if(a&&a.isInputStatus())return this.saveScene(),this.restore(--this.index),void a.setInputStatus(!1);if(1==this.list.length)return void this.restore(0);if(!this.list[this.index-1]&&1==this.list.length)return void this.reset();for(;this.list[this.index].equals(this.list[this.index-1]);)if(this.index--,0===this.index)return this.restore(0);this.restore(--this.index)}},redo:function(){if(this.hasRedo){for(;this.list[this.index].equals(this.list[this.index+1]);)if(this.index++,this.index==this.list.length-1)return this.restore(this.index);this.restore(++this.index)}},partialRenewal:function(a){function c(a,b){return a.getText()!=b.getText()?!1:f.compareObject(a.getData(),b.getData())===!1?!1:f.compareObject(a.getTmpData(),b.getTmpData())===!1?!1:!0}function d(a,c){c.isSelected()&&g.push(c),b.appendNode(c,a),c._lastLayoutTransform=a._lastLayoutTransform,c.render();for(var e,h=f.cloneArr(c.children),i=0;e=h[i++];)d(c,e)}function e(a,f){c(a,f)===!1&&a.setValue(f),a.render(),a.isSelected()&&g.push(a);for(var h,i,j=0,k=0;h=a.children[j],i=f.children[k],h||i;j++,k++)h&&!i?(j--,b.removeNode(h)):!h&&i?(k--,d(a,i)):e(h,i)}var g=[];e(b.getRoot(),a),b.layout(200),b.select(g,!0),g=[]},restore:function(a){a=void 0===a?this.index:a;var b=this.list[a];this.partialRenewal(b.cloneData()),this.update(),this.km.fire("restoreScene"),this.km.fire("contentChange")},getScene:function(a){return new c(this.km.getRoot(),a)},saveScene:function(a){var b=this.getScene(a),c=this.list[this.index];return c&&c.equals(b)?void(a&&(c.setInputStatus(!0),this.update())):(this.list=this.list.slice(0,this.index+1),this.list.push(b),this.list.length>this.km.getOptions("maxUndoCount")&&this.list.shift(),this.index=this.list.length-1,void this.update())},update:function(){this.hasRedo=!!this.list[this.index+1],this.hasUndo=!!this.list[this.index-1];var a=this.list[this.index];a&&a.isInputStatus()&&(this.hasUndo=!0)},reset:function(){this.list=[],this.index=0,this.hasUndo=!1,this.hasRedo=!1}});return this.historyManager=new d(this),{defaultOptions:{maxUndoCount:20,maxInputCount:20},commands:{undo:a.createClass("UndoCommand",{base:g,execute:function(a){a.historyManager.undo()},queryState:function(a){return a.historyManager.hasUndo?0:-1},isNeedUndo:function(){return!1}}),redo:a.createClass("RedoCommand",{base:g,execute:function(a){a.historyManager.redo()},queryState:function(a){return a.historyManager.hasRedo?0:-1},isNeedUndo:function(){return!1}})},addShortcutKeys:{Undo:"ctrl+z",Redo:"ctrl+y"},events:{saveScene:function(a){this.historyManager.saveScene(a.inputStatus)},"import":function(){this.historyManager.reset()}}}}),e.registerModule("ProgressModule",function(){var b="progress",c=a.createClass("ProgressIcon",{base:a.Group,constructor:function(a){this.callBase(),this.setSize(20),this.create(),this.setValue(a),this.setId(e.uuid("node_progress"))},setSize:function(a){this.width=this.height=a},create:function(){var b=new a.Circle(8).stroke("#29A6BD",2).fill("white"),c=new a.Pie(6,0,-90).fill("#29A6BD"),d=(new a.Path).getDrawer().moveTo(-3,-1).lineTo(-1,2).lineTo(3,-3).getPath().stroke("white",2).setVisible(!1);this.addShapes([b,c,d]),this.circle=b,this.pie=c,this.check=d},setValue:function(a){this.pie.setAngle(360*(a-1)/8),this.check.setVisible(9==a)}}),d=a.createClass("ProgressCommand",{base:g,execute:function(a,c){for(var d=a.getSelectedNodes(),e=0;e<d.length;e++)d[e].setData(b,c).render();a.layout()},queryValue:function(a){for(var c,d=a.getSelectedNodes(),e=0;e<d.length&&!(c=d[e].getData(b));e++);return c},queryState:function(a){return a.getSelectedNodes().length?0:-1}});return{commands:{progress:d},renderers:{left:a.createClass("ProgressRenderer",{base:e.Renderer,create:function(){return new c},shouldRender:function(a){return a.getData(b)},update:function(a,c,d){var e,f,g=c.getData(b),h=c.getStyle("space-left");return a.setValue(g),e=d.left-a.width-h,f=-a.height/2,a.setTranslate(e+a.width/2,f+a.height/2),{x:e,y:f,width:a.width,height:a.height}}})}}}),e.registerModule("PriorityModule",function(){var b=["","#A92E24","#29A6BD","#1E8D54","#eb6100","#876DDA","#828282","#828282","#828282","#828282"],c="priority",d=a.createClass("PriorityIcon",{base:a.Group,constructor:function(){this.callBase(),this.setSize(20),this.create(),this.setId(e.uuid("node_priority"))},setSize:function(a){this.width=this.height=a},create:function(){var b,c;b=(new a.Rect).setRadius(3).setPosition(.5,.5).setSize(this.width,this.height),c=(new a.Text).setX(this.width/2+.5).setY(this.height/2-.5).setTextAnchor("middle").setVerticalAlign("middle").setFontSize(12).fill("white"),c.mark="hello",this.addShapes([b,c]),this.bg=b,this.number=c},setValue:function(a){var c=this.bg,d=this.number;b[a]&&(c.fill(b[a]),d.setContent(a))}}),f=a.createClass("SetPriorityCommand",{base:g,execute:function(a,b){for(var d=a.getSelectedNodes(),e=0;e<d.length;e++)d[e].setData(c,b).render();a.layout()},queryValue:function(a){for(var b,d=a.getSelectedNodes(),e=0;e<d.length&&!(b=d[e].getData(c));e++);return b},queryState:function(a){return a.getSelectedNodes().length?0:-1}});return{commands:{priority:f},renderers:{left:a.createClass("PriorityRenderer",{base:e.Renderer,create:function(){return new d},shouldRender:function(a){return a.getData(c)},update:function(a,b,d){var e,f,g=b.getData(c),h=b.getStyle("space-left");return a.setValue(g),e=d.left-a.width-h,f=-a.height/2,a.setTranslate(e,f),{x:e,y:f,width:a.width,height:a.height}}})}}}),e.registerModule("image",function(){function b(a,b){var c=document.createElement("img");c.onload=function(){b(c.width,c.height)},c.onerror=function(){b(null)},c.src=a}function c(a,b,c,d){var e=a/b,f=c/d;return e>f&&a>c?(a=c,b=c/e):b>d&&(b=d,a=d/e),{width:0|a,height:0|b}}var d=a.createClass("ImageCommand",{base:g,execute:function(a,d){var e=a.getSelectedNodes();b(d,function(b,g){b&&(f.each(e,function(e,f){var h=c(b,g,a.getOptions("maxImageWidth"),a.getOptions("maxImageHeight"));f.setData("image",d),f.setData("imageSize",h),f.render()}),a.fire("saveScene"),a.layout(300))})},queryState:function(a){var b=a.getSelectedNodes(),c=0;return 0===b.length?-1:(f.each(b,function(a,b){return b&&b.getData("image")?(c=0,!1):void 0}),c)},queryValue:function(a){var b=a.getSelectedNode();return b.getData("image")}}),h=a.createClass("RemoveImageCommand",{base:g,execute:function(a){var b=a.getSelectedNodes();f.each(b,function(a,b){b.setData("image").render()}),a.layout(300)},queryState:function(a){var b=a.getSelectedNodes();if(0===b.length)return-1;var c=!1;return f.each(b,function(a,b){return b.getData("image")?(c=!0,!1):void 0}),c?0:-1}}),i=a.createClass("ImageRenderer",{base:e.Renderer,create:function(b){return new a.Image(b.getData("image"))},shouldRender:function(a){return a.getData("image")},update:function(b,c,d){var e=c.getData("image"),f=c.getData("imageSize"),g=c.getStyle("space-top");if(f){var h=d.cx-f.width/2,i=d.y-f.height-g;return b.setUrl(e).setX(0|h).setY(0|i).setWidth(0|f.width).setHeight(0|f.height),new a.Box(0|h,0|i,0|f.width,0|f.height)}}});return{defaultOptions:{maxImageWidth:200,maxImageHeight:200},commands:{image:d,removeimage:h},renderers:{top:i}}}),e.registerModule("Resource",function(){var b=[51,303,75,200,157,0,26,254].map(function(b){return a.Color.createHSL(b,100,85)}),c=a.Color.createHSL(0,0,95);a.extendClass(j,{getResourceColor:function(a){var d,e=this._getResourceColorIndexMapping();return e.hasOwnProperty(a)||(d=this._getNextResourceColorIndex(),e[a]=d),b[e[a]]||c},getUsedResource:function(){var a,b=this._getResourceColorIndexMapping(),c=[];for(a in b)b.hasOwnProperty(a)&&c.push(a);return c},_getNextResourceColorIndex:function(){var a,c,d,e=this._getResourceColorIndexMapping();c=[];for(a in e)e.hasOwnProperty(a)&&c.push(e[a]);for(d=0;d<b.length;d++)if(!~c.indexOf(d))return d;return-1},_getResourceColorIndexMapping:function(){return this._resourceColorMapping||(this._resourceColorMapping={})}});var d=a.createClass("ResourceCommand",{base:g,execute:function(a,b){var c=a.getSelectedNodes();"string"==typeof b&&(b=[b]),c.forEach(function(a){a.setData("resource",b).render()}),a.layout(200)},queryValue:function(a){var b=a.getSelectedNodes(),c=[];return b.forEach(function(a){var b=a.getData("resource");b&&b.forEach(function(a){~c.indexOf(a)||c.push(a)})}),c},queryState:function(a){return a.getSelectedNode()?0:-1}}),f=a.createClass("ResourceOverlay",{base:a.Group,constructor:function(){this.callBase();var b,c;c=this.rect=(new a.Rect).setRadius(4),b=this.text=(new a.Text).setFontSize(12).setVerticalAlign("middle"),this.addShapes([c,b])},setValue:function(a,b){var c,d,e,f=8,g=4;c=this.text,a==this.lastResourceName?d=this.lastBox:(c.setContent(a),d=c.getBoundaryBox(),this.lastResourceName=a,this.lastBox=d),c.setX(f).fill(b.dec("l",70)),e=this.rect,e.setPosition(0,d.y-g),this.width=Math.round(d.width+2*f),this.height=Math.round(d.height+2*g),e.setSize(this.width,this.height),e.fill(b)}}),h=a.createClass("ResourceRenderer",{base:e.Renderer,create:function(){return this.overlays=[],new a.Group},shouldRender:function(a){return a.getData("resource")&&a.getData("resource").length},update:function(a,b,c){var d,e,g,h=b.getStyle("space-right"),i=this.overlays,j=b.getData("resource"),k=b.getMinder();for(g=0,d=0;d<j.length;d++)g+=h,e=i[d],e||(e=new f,i.push(e),a.addShape(e)),e.setVisible(!0),e.setValue(j[d],k.getResourceColor(j[d])),e.setTranslate(g,-1),g+=e.width;for(;e=i[d++];)e.setVisible(!1);return a.setTranslate(c.right,0),{x:c.right,y:Math.round(-i[0].height/2),width:g,height:i[0].height}}});return{commands:{resource:d},renderers:{right:h}}});var A=a.createClass("ViewDragger",{constructor:function(a){this._minder=a,this._enabled=!1,this._bind()},isEnabled:function(){return this._enabled},setEnabled:function(a){var b=this._minder.getPaper();
b.setStyle("cursor",a?"pointer":"default"),b.setStyle("cursor",a?"-webkit-grab":"default"),this._enabled=a},move:function(a,b){b?this._minder.getRenderContainer().fxTranslate(0|a.x,0|a.y,b,"easeOutCubic"):this._minder.getRenderContainer().translate(0|a.x,0|a.y)},_bind:function(){var b=this,c=!1,d=null,e=null;this._minder.on("normal.mousedown normal.touchstart readonly.mousedown readonly.touchstart",function(a){2==a.originEvent.button&&a.originEvent.preventDefault(),(a.getTargetNode()==this.getRoot()||2==a.originEvent.button)&&(d=a.getPosition(),c=!0)}).on("normal.mousemove normal.touchmove readonly.touchmove readonly.mousemove",function(b){if(c){var e=a.Vector.fromPoints(d,b.getPosition());e.length()>3&&this.setStatus("hand")}}).on("hand.beforemousedown hand.beforetouchstart",function(a){b.isEnabled()&&(d=a.getPosition(),a.stopPropagation())}).on("hand.beforemousemove hand.beforetouchmove",function(c){if(d){e=c.getPosition();var f=a.Vector.fromPoints(d,e);b.move(f),c.stopPropagation(),c.preventDefault(),c.originEvent.preventDefault(),d=e}}).on("mouseup touchend",function(){d=null,c&&(b.setEnabled(!1),c=!1,this.rollbackStatus())})}});e.registerModule("View",function(){var b=a.createClass("ToggleHandCommand",{base:g,execute:function(a){"hand"!=a.getStatus()?a.setStatus("hand"):a.rollbackStatus(),this.setContentChanged(!1)},queryState:function(a){return"hand"==a.getStatus()?1:0},enableReadOnly:!1}),c=a.createClass("CameraCommand",{base:g,execute:function(b,c,d){c=c||b.getRoot();var e=b.getPaper().getViewPort(),f=c.getRenderContainer().getRenderBox("view"),g=e.center.x-f.x-f.width/2,h=e.center.y-f.y,i=b._viewDragger;i.move(new a.Point(g,h),d),this.setContentChanged(!1)},enableReadOnly:!1}),d=a.createClass("MoveCommand",{base:g,execute:function(b,c){var d=this._viewDragger,e=b._lastClientSize;switch(c){case"up":d.move(new a.Point(0,-e.height/2));break;case"down":d.move(new a.Point(0,e.height/2));break;case"left":d.move(new a.Point(-e.width/2,0));break;case"right":d.move(new a.Point(e.width/2,0))}}});return{init:function(){this._viewDragger=new A(this)},commands:{hand:b,camera:c,move:d},events:{keyup:function(a){a.originEvent.keyCode==l.Spacebar&&0===this.getSelectedNodes().length&&(this.execCommand("hand"),a.preventDefault())},statuschange:function(a){this._viewDragger.setEnabled("hand"==a.currentStatus)},mousewheel:function(a){var b,c;a=a.originEvent,a.ctrlKey||a.shiftKey||("wheelDeltaX"in a?(b=a.wheelDeltaX||0,c=a.wheelDeltaY||0):(b=0,c=a.wheelDelta),this._viewDragger.move({x:b/2.5,y:c/2.5}),a.preventDefault())},"normal.dblclick readonly.dblclick":function(b){b.kityEvent.targetShape instanceof a.Paper&&this.execCommand("camera",this.getRoot(),800)},ready:function(){this.execCommand("camera",null,0),this._lastClientSize={width:this.getRenderTarget().clientWidth,height:this.getRenderTarget().clientHeight}},resize:function(){var a={width:this.getRenderTarget().clientWidth,height:this.getRenderTarget().clientHeight},b=this._lastClientSize;this.getRenderContainer().translate((a.width-b.width)/2|0,(a.height-b.height)/2|0),this._lastClientSize=a}}}});var B=e.Geometry,C=a.createClass("MoveToParentCommand",{base:g,execute:function(a,b,c){for(var d,e=b.length-1;e>=0;e--)d=b[e],d.parent&&(d.parent.removeChild(d),c.appendChild(d),d.render());c.expand(),a.select(b,!0)}}),D=a.createClass("DropHinter",{base:a.Group,constructor:function(){this.callBase(),this.rect=new a.Rect,this.addShape(this.rect)},render:function(a){this.setVisible(!!a),a&&(this.rect.setBox(a.getLayoutBox()).setRadius(a.getStyle("radius")||0).stroke(a.getStyle("drop-hint-color")||"yellow",a.getStyle("drop-hint-width")||2),this.bringTop())}}),E=a.createClass("OrderHinter",{base:a.Group,constructor:function(){this.callBase(),this.area=new a.Rect,this.path=new a.Path,this.addShapes([this.area,this.path])},render:function(a){this.setVisible(!!a),a&&(this.area.setBox(a.area),this.area.fill(a.node.getStyle("order-hint-area-color")||"rgba(0, 255, 0, .5)"),this.path.setPathData(a.path),this.path.stroke(a.node.getStyle("order-hint-path-color")||"#0f0",a.node.getStyle("order-hint-path-width")||1))}}),F=a.createClass("TreeDragger",{constructor:function(a){this._minder=a,this._dropHinter=new D,this._orderHinter=new E,a.getRenderContainer().addShapes([this._dropHinter,this._orderHinter])},dragStart:function(a){this._startPosition=a},dragMove:function(b){var c=10;if(this._startPosition){if(this._dragPosition=b,!this._dragMode){if(B.getDistance(this._dragPosition,this._startPosition)<c)return;if(!this._enterDragMode())return}for(var d=a.Vector.fromPoints(this._startPosition,this._dragPosition),e=this._minder,f=0;f<this._dragSources.length;f++)this._dragSources[f].setLayoutOffset(this._dragSourceOffsets[f].offset(d)),e.applyLayoutResult(this._dragSources[f]);this._dropTest()?this._renderOrderHint(this._orderSucceedHint=null):this._orderTest()}},dragEnd:function(){if(this._startPosition=null,this._dragMode){if(this._dropSucceedTarget)this._dragSources.forEach(function(a){a.setLayoutOffset(null)}),this._minder.execCommand("movetoparent",this._dragSources,this._dropSucceedTarget);else if(this._orderSucceedHint){var a=this._orderSucceedHint,b=a.node.getIndex(),c=this._dragSources.map(function(a){return a.setLayoutOffset(null),a.getIndex()}),d=Math.max.apply(Math,c),e=Math.min.apply(Math,c);e>b&&"down"==a.type&&b++,b>d&&"up"==a.type&&b--,a.node.setLayoutOffset(null),this._minder.execCommand("arrange",this._dragSources,b),this._renderOrderHint(null)}else this._minder.fire("savescene");this._leaveDragMode(),this._minder.fire("contentchange")}},_enterDragMode:function(){return this._calcDragSources(),this._dragSources.length?(this._fadeDragSources(.5),this._calcDropTargets(),this._calcOrderHints(),this._dragMode=!0,!0):(this._startPosition=null,!1)},_calcDragSources:function(){this._dragSources=this._minder.getSelectedAncestors(),this._dragSourceOffsets=this._dragSources.map(function(a){return a.getLayoutOffset()})},_fadeDragSources:function(a){var b=this._minder;this._dragSources.forEach(function(c){c.getRenderContainer().fxOpacity(a,200),c.traverse(function(c){1>a?b.detachNode(c):b.attachNode(c)},!0)})},_calcDropTargets:function(){function a(b,c){var d,e=[];return e.push(c),c.getChildren().forEach(function(c){for(d=0;d<b.length;d++)if(b[d]==c)return;e=e.concat(a(b,c))}),e}this._dropTargets=a(this._dragSources,this._minder.getRoot()),this._dropTargetBoxes=this._dropTargets.map(function(a){return a.getLayoutBox()})},_calcOrderHints:function(){var a=this._dragSources,b=h.getCommonAncestor(a);if(b==a[0]&&(b=a[0].parent),0===a.length||b!=a[0].parent)return void(this._orderHints=[]);var c=b.children;this._orderHints=c.reduce(function(b,c){return-1==a.indexOf(c)&&(b=b.concat(c.getOrderHint())),b},[])},_leaveDragMode:function(){this._fadeDragSources(1),this._dragMode=!1,this._dropSucceedTarget=null,this._orderSucceedHint=null,this._renderDropHint(null),this._renderOrderHint(null)},_drawForDragMode:function(){this._text.setContent(this._dragSources.length+" items"),this._text.setPosition(this._startPosition.x,this._startPosition.y+5),this._minder.getRenderContainer().addShape(this)},_boxTest:function(a,b,c){var d,e,f,g,h,i=this._dragSources.map(function(a){return a.getLayoutBox()});for(c=c||function(a){return a},d=0;d<a.length;d++)for(f=a[d],h=b.call(this,f,d),e=0;e<i.length;e++){g=i[e];var j=B.getIntersectBox(g,h);if(c(j,g,h))return f}return null},_dropTest:function(){return this._dropSucceedTarget=this._boxTest(this._dropTargets,function(a,b){return this._dropTargetBoxes[b]},function(a,b,c){function d(a){return a.width*a.height}return a?d(a)>.5*Math.min(d(b),d(c))?!0:a.width+1>=Math.min(b.width,c.width)?!0:a.height+1>=Math.min(b.height,c.height)?!0:!1:!1}),this._renderDropHint(this._dropSucceedTarget),!!this._dropSucceedTarget},_orderTest:function(){return this._orderSucceedHint=this._boxTest(this._orderHints,function(a){return a.area}),this._renderOrderHint(this._orderSucceedHint),!!this._orderSucceedHint},_renderDropHint:function(a){this._dropHinter.render(a)},_renderOrderHint:function(a){this._orderHinter.render(a)},preventDragMove:function(){this._startPosition=null}});e.registerModule("DragTree",function(){var a;return{init:function(){a=new F(this)},events:{"normal.mousedown inputready.mousedown":function(b){b.originEvent.button||b.getTargetNode()&&b.getTargetNode()!=this.getRoot()&&a.dragStart(b.getPosition(this.getRenderContainer()))},"normal.mousemove":function(b){a.dragMove(b.getPosition(this.getRenderContainer()))},"normal.mouseup":function(b){a.dragEnd(b.getPosition(this.getRenderContainer())),b.stopPropagation(),this.fire("contentchange")},statuschange:function(b){"textedit"==b.lastStatus&&"normal"==b.currentStatus&&a.preventDragMove()}},commands:{movetoparent:C}}}),e.registerModule("DropFile",function(){function c(){var a=this.getPaper().getContainer();a.addEventListener("dragover",d),a.addEventListener("drop",e.bind(this))}function d(a){a.preventDefault(),a.stopPropagation(),a.dataTransfer.dropEffect="copy"}function e(b){b.preventDefault(),b.stopPropagation();var c=this;if(a.Browser.ie&&Number(a.Browser.version)<10)return void alert(" IE  10 ");var d=b.dataTransfer.files;if(d){var e=d[0];f(c,e)}}function f(a,b,c){if(b){var d=/(.)\w+$/.exec(b.name);if(!d)return alert("");d=d[0],/xmind/g.test(d)?h(a,b,"xmind"):/mmap/g.test(d)?h(a,b,"mindmanager"):/mm/g.test(d)?i(a,b,"freemind",c):/km/.test(d)?i(a,b,"json",c):/txt/.test(d)?i(a,b,"plain",c):alert("!")}}function g(){n&&(k(this),l.setRemotePath(null,!1),this.execCommand("camera",this.getRoot(),800),setTimeout(function(){l.watchChanges(!0)},10),n=!1)}function h(a,c,d){l=l||b.social,l.watchChanges(!1),n=!0,a.importData(c,d)}function i(a,b,c,d){var e=new FileReader;e.onload=function(b){h(a,b.target.result,c)},e.readAsText(b,d||"utf8")}function k(a){m=b.draftManager||(b.draftManager=new b.DraftManager(a)),m.create()}var l,m,n=!1;return a.extendClass(j,{importFile:function(a,b){return f(this,a,b),this}}),{events:{ready:c,"import":g}}}),e.registerModule("KeyboardModule",function(){function b(a){var b,c=[];a.traverse(function(a){b=a.getLayoutBox(),b.width&&b.height&&c.push({left:b.x,top:b.y,right:b.x+b.width,bottom:b.y+b.height,width:b.width,height:b.height,node:a,text:a.getText()})});for(var e=0;e<c.length;e++)d(c,e)}function c(a,b){var c,d,e,f,g,k,l;return c=h(a.left,b.left),d=i(a.right,b.right),e=h(a.top,b.top),f=i(a.bottom,b.bottom),g=d-c-a.width-b.width,k=f-e-a.height-b.height,l=0>g?k:0>k?g:j(g*g+k*k),{cx:l,cy:l}}function d(a,b){for(var d,e,f=a[b],g={},h=0;h<a.length;h++)h!=b&&(d=a[h],e=c(d,f),d.right<f.left&&(!g.left||e.cx<g.left.dist)&&(g.left={dist:e.cx,node:d.node}),d.left>f.right&&(!g.right||e.cx<g.right.dist)&&(g.right={dist:e.cx,node:d.node}),d.bottom<f.top&&(!g.top||e.cy<g.top.dist)&&(g.top={dist:e.cy,node:d.node}),d.top>f.bottom&&(!g.down||e.cy<g.down.dist)&&(g.down={dist:e.cy,node:d.node}));f.node._nearestNodes={right:g.right&&g.right.node||null,top:g.top&&g.top.node||null,left:g.left&&g.left.node||null,down:g.down&&g.down.node||null}}function f(a,c){var d=a.getSelectedNode();if(!d)return a.select(a.getRoot()),void b(a.getRoot());var e=d._nearestNodes[c];e&&a.select(e,!0)}{var g,h=Math.min,i=Math.max,j=(Math.abs,Math.sqrt);Math.exp}return{events:{contentchange:function(){function c(){b(d)}var d=this.getRoot();a.Timeline.releaseFrame(g),g=a.Timeline.requestFrame(c)},"normal.keydown":function(a){var b=e.keymap,c=a.getTargetNode(),d=this.getLang();this.receiver&&(this.receiver.keydownNode=c);var g=a.originEvent;if(!(g.altKey||g.ctrlKey||g.metaKey||g.shiftKey))switch(g.keyCode){case b.Enter:this.execCommand("AppendSiblingNode",d.topic),a.preventDefault();break;case b.Tab:this.execCommand("AppendChildNode",d.topic),a.preventDefault();break;case b.Backspace:case b.Del:a.preventDefault(),this.execCommand("RemoveNode");break;case b.F2:a.preventDefault(),this.execCommand("EditNode");break;case b.Left:f(this,"left"),a.preventDefault();break;case b.Up:f(this,"top"),a.preventDefault();break;case b.Right:f(this,"right"),a.preventDefault();break;case b.Down:f(this,"down"),a.preventDefault()}},"normal.keyup":function(a){if(m.ipad){var b=e.keymap,c=a.getTargetNode(),d=this.getLang();this.receiver&&(this.receiver.keydownNode=c);var f=a.originEvent;if(f.altKey||f.ctrlKey||f.metaKey||f.shiftKey)return;switch(f.keyCode){case b.Enter:this.execCommand("AppendSiblingNode",d.topic),a.preventDefault();break;case b.Backspace:case b.Del:a.preventDefault(),this.execCommand("RemoveNode")}}}}}}),e.registerModule("Select",function(){var c=this,d=c.getRenderContainer(),f=e.Geometry,g=function(){var e=null,g=new a.Path,h=!1,i=10;return{selectStart:function(a){return a.originEvent.button?void 0:e?this.selectEnd():void(e=f.snapToSharp(a.getPosition(d)))},selectMove:function(a){if("textedit"!=c.getStatus()&&e){var j=e,k=a.getPosition(d);if(!h){if(f.getDistance(j,k)<i)return;h=!0,d.addShape(g),g.fill(c.getStyle("marquee-background")).stroke(c.getStyle("marquee-stroke")).setOpacity(.8).getDrawer().clear()}var l=f.getBox(j,k),m=[];l.left=Math.round(l.left),l.top=Math.round(l.top),l.right=Math.round(l.right),l.bottom=Math.round(l.bottom),g.getDrawer().pipe(function(){this.clear(),this.moveTo(l.left,l.top),this.lineTo(l.right,l.top),this.lineTo(l.right,l.bottom),this.lineTo(l.left,l.bottom),this.close()}),c.getRoot().traverse(function(a){var b=a.getLayoutBox();f.getIntersectBox(b,l)&&m.push(a)}),c.select(m,!0),b.getSelection().removeAllRanges()}},selectEnd:function(){e&&(e=null),h&&(g.fadeOut(200,"ease",0,function(){g.remove&&g.remove()}),h=!1)}}}(),h=null,i=null;return{init:function(){b.addEventListener("mouseup",function(){g.selectEnd()})},events:{"normal.mousedown textedit.mousedown inputready.mousedown":function(a){var b=a.getTargetNode();b?a.originEvent.shiftKey?this.toggleSelect(b):b.isSelected()?this.isSingleSelect()||(h=b,i=a.getPosition(this.getRenderContainer())):this.select(b,!0):(this.removeAllSelectedNodes(),g.selectStart(a),this.setStatus("normal"))},"normal.mousemove textedit.mousemove inputready.mousemove":g.selectMove,"normal.mouseup textedit.mouseup inputready.mouseup":function(b){var c=b.getTargetNode();if(c&&c==h){var d=b.getPosition(this.getRenderContainer()),e=a.Vector.fromPoints(i,d);e.length()<1&&this.select(h,!0),h=null}g.selectEnd(b)},"normal.keydown inputready.keydown":function(a){var b=a.originEvent;if((b.ctrlKey||b.metaKey)&&l.a==b.keyCode){var c=[];this.getRoot().traverse(function(a){c.push(a)}),this.select(c,!0),a.preventDefault()}}}}}),e.registerModule("TextEditModule",function(){function a(a){if(a&&b.isSingleSelect()&&a.isSelected()){var f=a.getStyle("text-selection-color"),g=a.getTextShape();if(c.setHide().setStartOffset(0).setEndOffset(g.getContent().length).setColor(f),e.setMinderNode(a).updateContainerRangeBySel(),m.ie)var h=setInterval(function(){var a=d.nativeSel.getRangeAt(0);!a||a.collapsed?d.select():clearInterval(h)});e.minderNode.setTmpData("_lastTextContent",e.textShape.getContent()),b.setStatus("inputready")}}var b=this,c=new j.Selection,d=new j.Range,e=new j.Receiver(this,c,d);this.receiver=e;var f,g=!1,h=1,i=!1;return b.textEditNode=function(c){a(c),b.setStatus("textedit"),e.updateSelectionShow()},{events:{ready:function(){document.body.appendChild(e.container)},"normal.beforemousedown textedit.beforemousedown inputready.beforemousedown":function(a){if(!a.isRightMB()){if(e.minderNode){var h=e.minderNode.getTextShape();h&&0===h.getOpacity()&&(e.minderNode.setText(e.minderNode.getTmpData("_lastTextContent")),e.minderNode.render(),e.minderNode.getTextShape().setOpacity(1),b.layout(300))}g=!0,i=c.isShow(),c.setHide();var j=a.getTargetNode();if(!j){var k=a.kityEvent.targetShape;k&&"Selection"==k.getType()&&(j=e.getMinderNode(),a.stopPropagationImmediately())}if(j){var h=j.getTextShape();if(h.setStyle("cursor","default"),this.isSingleSelect()&&j.isSelected())return c.collapse(!0),c.setColor(j.getStyle("text-selection-color")),e.setMinderNode(j).setCurrentIndex(a.getPosition(this.getRenderContainer())).setRange(d).setReady(),f=a.getPosition(this.getRenderContainer()),void(i&&(h.setStyle("cursor","text"),e.updateSelection(),setTimeout(function(){c.setShow()},200),b.setStatus("textedit")))}e.clearReady(),e.clear()}},"inputready.keyup":function(){c.isHide()&&a(this.getSelectedNode())},"normal.keyup":function(b){var d=this.getSelectedNode();if(d&&this.isSingleSelect()&&d.isSelected()&&!c.isShow()){var e=b.originEvent,f=e.keyCode;!l.isSelectedNodeKey[f]||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||a(d)}},"normal.mouseup textedit.mouseup inputready.mouseup":function(d){g=!1;var h=d.getTargetNode();return h&&!i&&e.isReady()?(c.collapse(!0),c.setColor(h.getStyle("text-selection-color")),h.getTextShape().setStyle("cursor","text"),e.updateSelection(),m.ipad&&e.focus(),setTimeout(function(){c.setShow()},200),f=d.getPosition(this.getRenderContainer()),void b.setStatus("textedit")):void(c.isHide()?a(d.getTargetNode()):c.collapsed||e.updateContainerRangeBySel())},"textedit.beforemousemove inputready.beforemousemove":function(a){if(!m.ipad)if(g&&e.isReady()&&i){a.stopPropagationImmediately();var c=a.getPosition(this.getRenderContainer());h=c.x>f.x?1:c.x<f.x?-1:h,e.updateSelectionByMousePosition(c,h).updateSelectionShow(h).updateContainerRangeBySel(),f=a.getPosition(this.getRenderContainer())}else g&&!i&&(b.setStatus("normal"),e.clearReady())},"normal.dblclick textedit.dblclick inputready.dblclick":function(c){var d=c.getTargetNode();d&&(a(c.getTargetNode()),b.setStatus("textedit"),e.updateSelectionShow())},restoreScene:function(){e.clear(),a(this.getSelectedNode())},stopTextEdit:function(){e.clear(),b.setStatus("normal")},resize:function(){c.setHide()},execCommand:function(d){var f={appendchildnode:1,appendsiblingnode:1,editnode:1};return f[d.commandName]?(a(b.getSelectedNode()),void e.updateSelectionShow()):void(c.isShow()&&e.updateTextOffsetData().updateSelection())},layoutfinish:function(a){a.node!==e.minderNode||"textedit"!=this.getStatus()&&"inputready"!=this.getStatus()||e.setBaseOffset().setContainerStyle()},selectionclear:function(){var c=b.getSelectedNode();c?a(c):(b.setStatus("normal"),e.clear())},blur:function(){e.clear()},"textedit.import":function(){b.setStatus("normal"),e.clear()},"textedit.mousewheel":function(){e.setContainerStyle()}}}}),j.Range=a.createClass("Range",{constructor:function(){this.nativeRange=document.createRange(),this.nativeSel=b.getSelection()},hasNativeRange:function(){return 0!==this.nativeSel.rangeCount},select:function(){var a=this.nativeRange.startContainer;if(1==a.nodeType&&0===a.childNodes.length){var b=document.createTextNode("");a.appendChild(b),this.nativeRange.setStart(b,1),this.nativeRange.collapse(!0)}try{this.nativeSel.removeAllRanges()}catch(c){}return this.nativeSel.addRange(this.nativeRange),this},setStart:function(a,b){try{this.nativeRange.setStart(a,b)}catch(c){console.log(c)}return this},setEnd:function(a,b){return this.nativeRange.setEnd(a,b),this},getStart:function(){var a=this.nativeSel.getRangeAt(0);return{startContainer:a.startContainer,startOffset:a.startOffset}},getStartOffset:function(){return this.nativeRange.startOffset},getEndOffset:function(){return this.nativeRange.endOffset},collapse:function(a){return this.nativeRange.collapse(a===!0),this},isCollapsed:function(){return this.nativeRange.collapsed},insertNode:function(a){return this.nativeRange.insertNode(a),this},updateNativeRange:function(){return this.nativeRange=this.nativeSel.getRangeAt(0),this}}),j.Receiver=a.createClass("Receiver",{clear:function(){return this.container.innerHTML="",this.selection&&this.selection.setHide(),this.range&&this.range.nativeSel.removeAllRanges(),this.index=0,this.isTypeText=!1,this.lastMinderNode=null,this},constructor:function(a,b,c){var d=this;this.setKityMinder(a);var e=document.createElement("div");e.setAttribute("contenteditable",!0),e.className="km_receiver",this.container=e,m.ipad&&f.listen(this.container,"keydown keypress keyup input",function(a){d.keyboardEvents.call(d,new i("keyup"==a.type?"beforekeyup":a.type,a)),"keyup"==a.type&&"normal"==d.km.getStatus()&&d.km.fire("keyup",a)}),f.addCssRule("km_receiver_css"," .km_receiver{white-space:nowrap;position:absolute;padding:0;margin:0;word-wrap:break-word;"+(/\?debug#?/.test(location.href)?"":"clip:rect(1em 1em 1em 1em);")),this.km.on("inputready.beforekeyup inputready.beforekeydown textedit.beforekeyup normal.keydown normal.keyup textedit.beforekeydown textedit.keypress textedit.paste",f.proxy(this.keyboardEvents,this)),this.timer=null,this.index=0,this.selection=b,this.range=c},setRange:function(a,b){this.index=b||this.index;var c=this.container.firstChild;this.range=a,a.setStart(c||this.container,this.index),a.collapse(!0);var d=this;return setTimeout(function(){d.container.focus(),a.select()}),this},setTextShape:function(b){return b||(b=new a.Text),this.textShape=b,b._lastContent!=b.getContent()&&(this.container.innerHTML=f.unhtml(b.getContent()),b._lastContent=b.getContent()),this},setTextShapeSize:function(a){return this.textShape.setSize(a),this},getTextShapeHeight:function(){return this.textShape.getRenderBox().height},setKityMinder:function(a){return this.km=a,this},setMinderNode:function(a){return this.minderNode=a,this._addSelection(),this.setTextShape(a.getTextShape()),this.setBaseOffset(),this.setContainerStyle(),this.updateTextOffsetData(),this.setSelectionHeight(),this.setContainerTxt(),this},_addSelection:function(){this.selection.container&&this.selection.remove(),this.minderNode.getRenderContainer().addShape(this.selection)},getMinderNode:function(){return this.minderNode},keyboardEvents:function(a){function b(){if(clearTimeout(d.timer),d.range.hasNativeRange()&&!l.controlKeys[g]){d.lastMinderNode===d.minderNode||l.notContentChange[g]||(d.km.fire("saveScene",{inputStatus:!0}),d.lastMinderNode=d.minderNode);var a=d.container.textContent.replace(/[\u200b\t\r\n]/g,"");m.gecko&&/\s$/.test(a)&&(a+=""),(0!==a.length||0!==d.textShape.getOpacity())&&(0===a.length?(d.minderNode.setTmpData("_lastTextContent",d.textShape.getContent()),d.minderNode.setText("a")):(d.minderNode.setText(a),0===d.textShape.getOpacity()&&d.textShape.setOpacity(1)),d.setContainerStyle(),d.minderNode.getRenderContainer().bringTop(),d.minderNode.render(),l.notContentChange[g]||(clearTimeout(d.inputTextTimer),d.inputTextTimer=setTimeout(function(){d.km.layout(300)},250)),d.textShape=d.minderNode.getRenderer("TextRenderer").getRenderShape(),0===a.length&&d.textShape.setOpacity(0),d.setBaseOffset(),d.updateTextOffsetData(),d.updateRange(),d.updateSelectionByRange(),d.updateSelectionShow(),d.timer=setTimeout(function(){d.selection.isShow()&&d.selection.setShow()},200),d.km.setStatus("textedit"))}}function c(){if(d.minderNode){var a=d.minderNode.getTextShape();a&&0===a.getOpacity()&&(d.minderNode.setText(d.minderNode.getTmpData("_lastTextContent")),d.minderNode.render(),d.minderNode.getTextShape().setOpacity(1),d.km.layout(300))}}var d=this,e=a.originEvent,g=e.keyCode;switch(a.type){case"input":m.ipad&&setTimeout(function(){b()});break;case"beforekeydown":switch(this.isTypeText=229==g||0===g,g){case l.Enter:case l.Tab:return this.selection.isShow()?(this.clear(),this.km.setStatus("inputready"),clearTimeout(d.inputTextTimer),a.preventDefault()):(this.km.setStatus("normal"),this.km.fire("contentchange")),void c();case l.left:case l.right:case l.up:case l.down:case l.Backspace:case l.Del:case l["/"]:if(this.selection.isHide())return c(),void this.km.setStatus("normal");break;case l.Control:case l.Alt:case l.Cmd:case l.F2:if(this.selection.isHide()&&"inputready"!=this.km.getStatus())return void this.km.setStatus("normal")}if(a.originEvent.ctrlKey||a.originEvent.metaKey){if(this.selection.isHide()&&{86:1,88:1,67:1}[g])return c(),void this.km.setStatus("normal");if(g==l.v)return void setTimeout(function(){d.range.updateNativeRange().insertNode($("<span>$$_kityminder_bookmark_$$</span>")[0]),d.container.innerHTML=f.unhtml(d.container.textContent.replace(/[\u200b\t\r\n]/g,""));var a=d.container.textContent.indexOf("$$_kityminder_bookmark_$$");d.container.textContent=d.container.textContent.replace("$$_kityminder_bookmark_$$",""),d.range.setStart(d.container.firstChild,a).collapse(!0).select(),b(g)},100);if(g==l.x)return void setTimeout(function(){b(g)},100)}(l.Del==g||l.Backspace==g)&&b(g);break;case"beforekeyup":switch(g){case l.Enter:case l.Tab:case l.F2:return m.ipad?(this.selection.isShow()?(this.clear(),this.km.setStatus("inputready"),clearTimeout(d.inputTextTimer),a.preventDefault()):(this.km.setStatus("normal"),this.km.fire("contentchange")),void c()):(l.Enter==g&&(this.isTypeText||m.mac&&m.gecko)&&b(g),this.keydownNode===this.minderNode&&(this.rollbackStatus(),this.clear()),void a.preventDefault());case l.Del:case l.Backspace:case l.Spacebar:return m.ipad&&this.selection.isHide()?void this.km.setStatus("normal"):void b(g)}return this.isTypeText?void b(g):m.mac&&m.gecko?void b(g):(b(g),!0);case"keyup":var h=this.km.getSelectedNode();if("normal"==this.km.getStatus()&&h&&this.selection.isHide()&&h&&this.km.isSingleSelect()&&h.isSelected()){var i=h.getStyle("text-selection-color"),j=h.getTextShape();if(this.selection.setHide().setStartOffset(0).setEndOffset(j.getContent().length).setColor(i),this.setMinderNode(h).updateContainerRangeBySel(),m.ie)var k=setInterval(function(){var a=this.range.nativeSel.getRangeAt(0);!a||a.collapsed?this.range.select():clearInterval(k)});this.minderNode.setTmpData("_lastTextContent",this.textShape.getContent()),this.km.setStatus("inputready")}}},updateIndex:function(){return this.index=this.range.getStart().startOffset,this},updateTextOffsetData:function(){return this.textShape.textData=this.getTextOffsetData(),this},setSelection:function(a){return this.selection=a,this},updateSelection:function(){return this.selection.setShowHold(),this.selection.bringTop(),this.selection.setStartOffset(this.index).collapse(!0),this.selection.setPosition(this.index==this.textData.length?0===this.index?this.getBaseOffset():{x:this.textData[this.index-1].x+this.textData[this.index-1].width,y:this.textData[this.index-1].y}:this.textData[this.index]),this},getBaseOffset:function(a){return this.textShape.getRenderBox(a||this.km.getRenderContainer())},setBaseOffset:function(){return this.offset=this.textShape.getRenderBox(this.km.getRenderContainer()),this},setContainerStyle:function(){var a=this.getBaseOffset("screen");return this.container.style.cssText=";left:"+(m.ipad?"-":"")+a.x+"px;top:"+(a.y+(/\?debug#?/.test(location.href)?30:0))+"px;width:"+a.width+"px;height:"+a.height+"px;",this},getTextOffsetData:function(){var a,b=this.textShape.getContent();this.textData=[];for(var c=0,d=b.length;d>c;c++){try{a=this.textShape.getExtentOfChar(c)}catch(e){console.log(e)}this.textData.push({x:a.x,y:a.y,width:a.width,height:a.height})}return this},setCurrentIndex:function(a){var b=this;this.getTextOffsetData();var c=!1;return this._getRelativeValue(a),f.each(this.textData,function(d,e){return 0===d&&a.x<=e.x?(b.index=0,!1):a.x>=e.x&&a.x<=e.x+e.width?(b.index=a.x-e.x>e.width/2?d+1:d,c=!0,!1):d==b.textData.length-1&&a.x>=e.x?(b.index=b.textData.length,!1):void 0}),this},setSelectionHeight:function(){return this.selection.setHeight(this.getTextShapeHeight()),this},_getRelativeValue:function(a){a.x=a.x-this.offset.x,a.y=a.y-this.offset.y},updateSelectionByMousePosition:function(a,b){this._getRelativeValue(a);var c=this;return f.each(this.textData,function(d,e){return 0===d&&a.x<=e.x?(c.selection.setStartOffset(0),!1):d==c.textData.length-1&&a.x>=e.x?(c.selection.setEndOffset(c.textData.length),!1):a.x>=e.x&&a.x<=e.x+e.width?(c.index==d?(0===d&&c.selection.setStartOffset(d),a.x<=e.x+e.width/2?c.selection.collapse(!0):c.selection.setEndOffset(d+((c.selection.endOffset>d||1==b)&&d!=c.textData.length-1?1:0))):d>c.index?(c.selection.setStartOffset(c.index),c.selection.setEndOffset(d+1)):(c.selection.setStartOffset(1==b?d+(a.x>=e.x+e.width/2&&d!=c.textData.length-1?1:0):d),c.selection.setEndOffset(c.index)),!1):void 0}),this},updateSelectionShow:function(){var a=this.textData[this.selection.startOffset],b=this.textData[this.selection.endOffset],c=0;if(this.selection.collapsed){if(void 0===a){var d=this.textData[this.textData.length-1];d=f.clone(d),d.x=d.x+d.width,a=d}return this.selection.updateShow(a,2),this}if(b)c=b.x-a.x;else try{var e=this.textData[this.textData.length-1];c=e.x-a.x+e.width}catch(g){console.log(g)}return this.selection.updateShow(a,c),this},updateRange:function(){return this.range.updateNativeRange(),this},updateContainerRangeBySel:function(){var a=this,b=this.container.firstChild;return this.range.setStart(b,this.selection.startOffset),this.range.setEnd(b,this.selection.endOffset),m.gecko?(this.container.focus(),setTimeout(function(){a.range.select()})):this.range.select(),this},updateSelectionByRange:function(){return this.selection.setStartOffset(this.range.getStartOffset()),this.selection.setEndOffset(this.range.getEndOffset()),this},setIndex:function(a){return this.index=a,this},setContainerTxt:function(a){return this.container.textContent=a||this.textShape.getContent(),this},setReady:function(){this._ready=!0},clearReady:function(){this._ready=!1},isReady:function(){return this._ready},focus:function(){this.container.focus()}}),j.Selection=a.createClass("Selection",{base:a.Rect,constructor:function(a){this.callBase(),this.height=a||20,this.setAttr("id","_kity_selection"),this.width=2,this.fill("rgb(27,171,255)"),this.setHide(),this.timer=null,this.collapsed=!0,this.startOffset=this.endOffset=0,this.setOpacity(.5),this.setStyle("cursor","text"),this._show=!1},setColor:function(a){this.fill(a)},collapse:function(a){return this.setOpacity(1),this.width=2,this.collapsed=!0,a?this.endOffset=this.startOffset:this.startOffset=this.endOffset,this},setStartOffset:function(a){return this.startOffset=a,this.startOffset>=this.endOffset?(this.collapse(!0),this):(this.collapsed=!1,this.setOpacity(.5),this)},setEndOffset:function(a){return this.endOffset=a,this.endOffset<=this.startOffset?(this.startOffset=a,this.collapse(!0),this):(this.collapsed=!1,this.setOpacity(.5),this)},updateShow:function(a,b){return b&&this.setShowHold(),this.setPosition(a).setWidth(b),this.bringTop(),this},setPosition:function(a){try{this.x=Math.round(a.x)-.5,this.y=Math.round(a.y)-1.5}catch(b){console.log(b)}return this.update(),this},setHeight:function(a){return this.height=Math.round(a)+2,this},setHide:function(){return clearInterval(this.timer),this.setStyle("display","none"),this._show=!1,this},setShowHold:function(){return clearInterval(this.timer),this.setStyle("display",""),this._show=!0,this},setShow:function(){clearInterval(this.timer);var a=this,b="";return a.setStyle("display",""),a._show=!0,this.collapsed&&(a.setOpacity(1),this.timer=setInterval(function(){a.setStyle("display",b),b=b?"":"none"},400)),this},isShow:function(){return this._show},isHide:function(){return!this._show}}),e.registerModule("basestylemodule",function(){function b(a,b){return a.getData(b)||a.getStyle(b)}var c=this;return e.TextRenderer.registerStyleHook(function(a,c){c.setFont({weight:b(a,"font-weight"),style:b(a,"font-style")})}),{commands:{bold:a.createClass("boldCommand",{base:g,execute:function(a){var b=a.getSelectedNodes();1==this.queryState("bold")?f.each(b,function(a,b){b.setData("font-weight").render()}):f.each(b,function(a,b){b.setData("font-weight","bold").render()}),a.layout()},queryState:function(){var a=c.getSelectedNodes(),b=0;return 0===a.length?-1:(f.each(a,function(a,c){return c&&c.getData("font-weight")?(b=1,!1):void 0}),b)}}),italic:a.createClass("italicCommand",{base:g,execute:function(a){var b=a.getSelectedNodes();1==this.queryState("italic")?f.each(b,function(a,b){b.setData("font-style").render()}):f.each(b,function(a,b){b.setData("font-style","italic").render()}),a.layout()},queryState:function(){var a=c.getSelectedNodes(),b=0;return 0===a.length?-1:(f.each(a,function(a,c){return c&&c.getData("font-style")?(b=1,!1):void 0
}),b)}})},addShortcutKeys:{bold:"ctrl+b",italic:"ctrl+i"}}}),e.registerModule("fontmodule",function(){function b(a,b){return a.getData(b)||a.getStyle(b)}return e.TextRenderer.registerStyleHook(function(a,c){var d=a.getData("color"),e=a.getStyle("selected-color"),f=a.getStyle("color");c.fill(d||(a.isSelected()&&e?e:f)),c.setFont({family:b(a,"font-family"),size:b(a,"font-size")})}),{defaultOptions:{fontfamily:[{name:"songti",val:",SimSun"},{name:"yahei",val:",Microsoft YaHei"},{name:"kaiti",val:",_GB2312, SimKai"},{name:"heiti",val:", SimHei"},{name:"lishu",val:", SimLi"},{name:"andaleMono",val:"andale mono"},{name:"arial",val:"arial, helvetica,sans-serif"},{name:"arialBlack",val:"arial black,avant garde"},{name:"comicSansMs",val:"comic sans ms"},{name:"impact",val:"impact,chicago"},{name:"timesNewRoman",val:"times new roman"},{name:"sans-serif",val:"sans-serif"}],fontsize:[10,12,16,18,24,32,48]},commands:{forecolor:a.createClass("fontcolorCommand",{base:g,execute:function(a,b){var c=a.getSelectedNodes();f.each(c,function(a,c){c.setData("color",b),c.render()})},queryState:function(a){return 0==a.getSelectedNodes().length?-1:0},queryValue:function(a){return 1==a.getSelectedNodes().length?a.getSelectedNodes()[0].getData("color"):"mixed"}}),backgroundcolor:a.createClass("backgroudcolorCommand",{base:g,execute:function(a,b){var c=a.getSelectedNodes();f.each(c,function(a,c){c.setData("background",b),c.render()})},queryState:function(a){return 0==a.getSelectedNodes().length?-1:0},queryValue:function(a){return 1==a.getSelectedNodes().length?a.getSelectedNodes()[0].getData("background"):"mixed"}}),fontfamily:a.createClass("fontfamilyCommand",{base:g,execute:function(a,b){var c=a.getSelectedNodes();f.each(c,function(c,d){d.setData("font-family",b),d.render(),a.layout()})},queryState:function(a){return 0==a.getSelectedNodes().length?-1:0}}),fontsize:a.createClass("fontsizeCommand",{base:g,execute:function(a,b){var c=a.getSelectedNodes();f.each(c,function(c,d){d.setData("font-size",b),d.render(),a.layout(300)})},queryState:function(a){return 0==a.getSelectedNodes().length?-1:0}})}}}),e.registerModule("Zoom",function(){function b(b){var c=b.shapeNode,d=c.getCTM(),e=new a.Matrix(d.a,d.b,d.c,d.d,(0|d.e)+.5,(0|d.f)+.5);c.setAttribute("transform","matrix("+e.toString()+")")}function c(b,c){function e(a){b.getRoot().traverse(function(b){b.getTextShape().setAttr("text-rendering",a)})}{var f=b.getPaper();f.getViewPort()}if(c){var g=new a.Animator({beginValue:b._zoomValue,finishValue:c,setter:function(a,b){a.zoom(b)}});b._zoomValue=c,d&&d.pause(),e(c>=100?"optimize-speed":"geometricPrecision"),d=g.start(b,300,"easeInOutSine",function(){})}}var d,e=this;e.setDefaultOptions("zoom",[10,20,30,50,80,100,120,150,200]),a.extendClass(j,{zoom:function(a){var c=this.getPaper(),d=c.getViewPort();d.zoom=a/100,d.center={x:d.center.x,y:d.center.y},c.setViewPort(d),100==a&&b(c)}});var f=a.createClass("Zoom",{base:g,execute:c,queryValue:function(a){return a._zoomValue}}),h=a.createClass("ZoomInCommand",{base:g,execute:function(a){c(a,this.nextValue(a))},queryState:function(a){return~this.nextValue(a)},nextValue:function(a){var b,c=a.getOptions("zoom");for(b=0;b<c.length;b++)if(c[b]>a._zoomValue)return c[b];return 0},enableReadOnly:!1}),i=a.createClass("ZoomOutCommand",{base:g,execute:function(a){c(a,this.nextValue(a))},queryState:function(a){return~this.nextValue(a)},nextValue:function(a){var b,c=a.getOptions("zoom");for(b=c.length-1;b>=0;b--)if(c[b]<a._zoomValue)return c[b];return 0},enableReadOnly:!1});return{init:function(){this._zoomValue=100},commands:{"zoom-in":h,"zoom-out":i,zoom:f},events:{"normal.keydown":function(a){var b=this,c=a.originEvent,d=c.keyCode||c.which;l["="]==d&&(b.execCommand("zoom-in"),a.stopPropagation(),a.preventDefault()),l["-"]==d&&(b.execCommand("zoom-out"),a.stopPropagation(),a.preventDefault())},"normal.mousewheel readonly.mousewheel":function(b){if(b.originEvent.ctrlKey){var c=b.originEvent.wheelDelta,d=this;a.Browser.mac||(c=-c),Math.abs(c)>100&&(clearTimeout(this._wheelZoomTimeout),this._wheelZoomTimeout=setTimeout(function(){d.getPaper()._zoom||1;0>c?d.execCommand("zoom-in"):c>0&&d.execCommand("zoom-out")},100),b.originEvent.preventDefault())}}}}}),e.registerModule("hyperlink",function(){var b="M16.614,10.224h-1.278c-1.668,0-3.07-1.07-3.599-2.556h4.877c0.707,0,1.278-0.571,1.278-1.278V3.834 c0-0.707-0.571-1.278-1.278-1.278h-4.877C12.266,1.071,13.668,0,15.336,0h1.278c2.116,0,3.834,1.716,3.834,3.834V6.39 C20.448,8.508,18.73,10.224,16.614,10.224z M5.112,5.112c0-0.707,0.573-1.278,1.278-1.278h7.668c0.707,0,1.278,0.571,1.278,1.278 S14.765,6.39,14.058,6.39H6.39C5.685,6.39,5.112,5.819,5.112,5.112z M2.556,3.834V6.39c0,0.707,0.573,1.278,1.278,1.278h4.877 c-0.528,1.486-1.932,2.556-3.599,2.556H3.834C1.716,10.224,0,8.508,0,6.39V3.834C0,1.716,1.716,0,3.834,0h1.278 c1.667,0,3.071,1.071,3.599,2.556H3.834C3.129,2.556,2.556,3.127,2.556,3.834z";return{commands:{hyperlink:a.createClass("hyperlink",{base:g,execute:function(a,b){var c=a.getSelectedNodes();f.each(c,function(a,c){c.setData("hyperlink",b),c.render()}),a.layout()},queryState:function(a){var b=a.getSelectedNodes(),c=0;return 0===b.length?-1:(f.each(b,function(a,b){return b&&b.getData("hyperlink")?(c=0,!1):void 0}),c)},queryValue:function(a){var b=a.getSelectedNode();return b.getData("hyperlink")}}),unhyperlink:a.createClass("hyperlink",{base:g,execute:function(a){var b=a.getSelectedNodes();f.each(b,function(a,b){b.setData("hyperlink"),b.render()}),a.layout()},queryState:function(a){var b=a.getSelectedNodes();if(0===b.length)return-1;var c=!1;return f.each(b,function(a,b){return b.getData("hyperlink")?(c=!0,!1):void 0}),c?0:-1}})},renderers:{right:a.createClass("hyperlinkrender",{base:e.Renderer,create:function(){var c=new a.HyperLink,d=new a.Path,e=new a.Rect(24,22,-2,-6,4).fill("rgba(255, 255, 255, 0)");return d.setPathData(b).fill("#666"),c.addShape(e),c.addShape(d),c.setTarget("_blank"),c.setStyle("cursor","pointer"),c.on("mouseover",function(){e.fill("rgba(255, 255, 200, .8)")}).on("mouseout",function(){e.fill("rgba(255, 255, 255, 0)")}),c},shouldRender:function(a){return a.getData("hyperlink")},update:function(a,b,c){var d=b.getData("hyperlink");a.setHref(d),a.setAttr("xlink:title",d);var e=b.getStyle("space-right");return a.setTranslate(c.right+e+2,-5),{x:c.right+e,y:-11,width:24,height:22}}})}}}),a.extendClass(h,{arrange:function(a){var b=this.parent;if(b){var c=b.children;if(!(0>a||a>=c.length))return c.splice(this.getIndex(),1),c.splice(a,0,this),this}}});var G=a.createClass("ArrangeUpCommand",{base:g,execute:function(a){var b=a.getSelectedNodes();b.sort(c);var d=b.map(function(a){return a.getIndex()});b.forEach(function(a,b){a.arrange(d[b]-1)}),a.layout(300)}}),H=a.createClass("ArrangeUpCommand",{base:g,execute:function(a){var b=a.getSelectedNodes();b.sort(d);var c=b.map(function(a){return a.getIndex()});b.forEach(function(a,b){a.arrange(c[b]+1)}),a.layout(300)}}),I=a.createClass("ArrangeCommand",{base:g,execute:function(a,b,c){if(b=b&&b.slice()||a.getSelectedNodes().slice(),b.length){var d=h.getCommonAncestor(b);if(d==b[0].parent){var e=b.map(function(a){return{index:a.getIndex(),node:a}}),f=Math.min.apply(Math,e.map(function(a){return a.index}))>=c;e.sort(function(a,b){return f?b.index-a.index:a.index-b.index}),e.forEach(function(a){a.node.arrange(c)}),a.layout(300)}}}});e.registerModule("ArrangeModule",{commands:{arrangeup:G,arrangedown:H,arrange:I},addShortcutKeys:{arrangeup:"alt+Up",arrangedown:"alt+Down"}}),e.registerModule("pasteModule",function(){function a(b,d){g.push(d),c.appendNode(d,b),d.render(),d.setLayoutOffset(null);for(var e,h=f.cloneArr(d.children),i=0;e=h[i++];)a(d,e)}function b(a,b){d=[];for(var e,f=0;e=a[f++];)d.push(e.clone()),b&&!e.isRoot()&&c.removeNode(e)}var c=this,d=[],g=[],h=!1,i=!1;return{events:{"normal.keydown":function(f){var j=e.keymap,k=f.originEvent;if(k.ctrlKey||k.metaKey)switch(k.keyCode){case j.c:b(c.getSelectedAncestors(!0)),h=!0;break;case j.x:b(c.getSelectedAncestors(),!0),c.layout(300),i=!0;break;case j.v:if(d.length){var l=c.getSelectedNode();if(l){c.fire("saveScene");for(var m,n=0;m=d[n++];)a(l,m.clone());c.layout(300),c.select(g,!0),g=[],c.fire("saveScene")}}}}}}}),function(a,b){function c(b,c){var e,f,g,h=b.nodeName.toLowerCase();return"area"===h?(e=b.parentNode,f=e.name,b.href&&f&&"map"===e.nodeName.toLowerCase()?(g=a("img[usemap=#"+f+"]")[0],!!g&&d(g)):!1):(/input|select|textarea|button|object/.test(h)?!b.disabled:"a"===h?b.href||c:c)&&d(b)}function d(b){return a.expr.filters.visible(b)&&!a(b).parents().addBack().filter(function(){return"hidden"===a.css(this,"visibility")}).length}var e=0,f=/^ui-id-\d+$/;a.ui=a.ui||{},a.extend(a.ui,{version:"1.10.4",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),a.fn.extend({focus:function(b){return function(c,d){return"number"==typeof c?this.each(function(){var b=this;setTimeout(function(){a(b).focus(),d&&d.call(b)},c)}):b.apply(this,arguments)}}(a.fn.focus),scrollParent:function(){var b;return b=a.ui.ie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?this.parents().filter(function(){return/(relative|absolute|fixed)/.test(a.css(this,"position"))&&/(auto|scroll)/.test(a.css(this,"overflow")+a.css(this,"overflow-y")+a.css(this,"overflow-x"))}).eq(0):this.parents().filter(function(){return/(auto|scroll)/.test(a.css(this,"overflow")+a.css(this,"overflow-y")+a.css(this,"overflow-x"))}).eq(0),/fixed/.test(this.css("position"))||!b.length?a(document):b},zIndex:function(c){if(c!==b)return this.css("zIndex",c);if(this.length)for(var d,e,f=a(this[0]);f.length&&f[0]!==document;){if(d=f.css("position"),("absolute"===d||"relative"===d||"fixed"===d)&&(e=parseInt(f.css("zIndex"),10),!isNaN(e)&&0!==e))return e;f=f.parent()}return 0},uniqueId:function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++e)})},removeUniqueId:function(){return this.each(function(){f.test(this.id)&&a(this).removeAttr("id")})}}),a.extend(a.expr[":"],{data:a.expr.createPseudo?a.expr.createPseudo(function(b){return function(c){return!!a.data(c,b)}}):function(b,c,d){return!!a.data(b,d[3])},focusable:function(b){return c(b,!isNaN(a.attr(b,"tabindex")))},tabbable:function(b){var d=a.attr(b,"tabindex"),e=isNaN(d);return(e||d>=0)&&c(b,!e)}}),a("<a>").outerWidth(1).jquery||a.each(["Width","Height"],function(c,d){function e(b,c,d,e){return a.each(f,function(){c-=parseFloat(a.css(b,"padding"+this))||0,d&&(c-=parseFloat(a.css(b,"border"+this+"Width"))||0),e&&(c-=parseFloat(a.css(b,"margin"+this))||0)}),c}var f="Width"===d?["Left","Right"]:["Top","Bottom"],g=d.toLowerCase(),h={innerWidth:a.fn.innerWidth,innerHeight:a.fn.innerHeight,outerWidth:a.fn.outerWidth,outerHeight:a.fn.outerHeight};a.fn["inner"+d]=function(c){return c===b?h["inner"+d].call(this):this.each(function(){a(this).css(g,e(this,c)+"px")})},a.fn["outer"+d]=function(b,c){return"number"!=typeof b?h["outer"+d].call(this,b):this.each(function(){a(this).css(g,e(this,b,!0,c)+"px")})}}),a.fn.addBack||(a.fn.addBack=function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}),a("<a>").data("a-b","a").removeData("a-b").data("a-b")&&(a.fn.removeData=function(b){return function(c){return arguments.length?b.call(this,a.camelCase(c)):b.call(this)}}(a.fn.removeData)),a.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()),a.support.selectstart="onselectstart"in document.createElement("div"),a.fn.extend({disableSelection:function(){return this.bind((a.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(a){a.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),a.extend(a.ui,{plugin:{add:function(b,c,d){var e,f=a.ui[b].prototype;for(e in d)f.plugins[e]=f.plugins[e]||[],f.plugins[e].push([c,d[e]])},call:function(a,b,c){var d,e=a.plugins[b];if(e&&a.element[0].parentNode&&11!==a.element[0].parentNode.nodeType)for(d=0;e.length>d;d++)a.options[e[d][0]]&&e[d][1].apply(a.element,c)}},hasScroll:function(b,c){if("hidden"===a(b).css("overflow"))return!1;var d=c&&"left"===c?"scrollLeft":"scrollTop",e=!1;return b[d]>0?!0:(b[d]=1,e=b[d]>0,b[d]=0,e)}})}(jQuery),function(a,b){var c=0,d=Array.prototype.slice,e=a.cleanData;a.cleanData=function(b){for(var c,d=0;null!=(c=b[d]);d++)try{a(c).triggerHandler("remove")}catch(f){}e(b)},a.widget=function(c,d,e){var f,g,h,i,j={},k=c.split(".")[0];c=c.split(".")[1],f=k+"-"+c,e||(e=d,d=a.Widget),a.expr[":"][f.toLowerCase()]=function(b){return!!a.data(b,f)},a[k]=a[k]||{},g=a[k][c],h=a[k][c]=function(a,c){return this._createWidget?(arguments.length&&this._createWidget(a,c),b):new h(a,c)},a.extend(h,g,{version:e.version,_proto:a.extend({},e),_childConstructors:[]}),i=new d,i.options=a.widget.extend({},i.options),a.each(e,function(c,e){return a.isFunction(e)?(j[c]=function(){var a=function(){return d.prototype[c].apply(this,arguments)},b=function(a){return d.prototype[c].apply(this,a)};return function(){var c,d=this._super,f=this._superApply;return this._super=a,this._superApply=b,c=e.apply(this,arguments),this._super=d,this._superApply=f,c}}(),b):(j[c]=e,b)}),h.prototype=a.widget.extend(i,{widgetEventPrefix:g?i.widgetEventPrefix||c:c},j,{constructor:h,namespace:k,widgetName:c,widgetFullName:f}),g?(a.each(g._childConstructors,function(b,c){var d=c.prototype;a.widget(d.namespace+"."+d.widgetName,h,c._proto)}),delete g._childConstructors):d._childConstructors.push(h),a.widget.bridge(c,h)},a.widget.extend=function(c){for(var e,f,g=d.call(arguments,1),h=0,i=g.length;i>h;h++)for(e in g[h])f=g[h][e],g[h].hasOwnProperty(e)&&f!==b&&(c[e]=a.isPlainObject(f)?a.isPlainObject(c[e])?a.widget.extend({},c[e],f):a.widget.extend({},f):f);return c},a.widget.bridge=function(c,e){var f=e.prototype.widgetFullName||c;a.fn[c]=function(g){var h="string"==typeof g,i=d.call(arguments,1),j=this;return g=!h&&i.length?a.widget.extend.apply(null,[g].concat(i)):g,this.each(h?function(){var d,e=a.data(this,f);return e?a.isFunction(e[g])&&"_"!==g.charAt(0)?(d=e[g].apply(e,i),d!==e&&d!==b?(j=d&&d.jquery?j.pushStack(d.get()):d,!1):b):a.error("no such method '"+g+"' for "+c+" widget instance"):a.error("cannot call methods on "+c+" prior to initialization; attempted to call method '"+g+"'")}:function(){var b=a.data(this,f);b?b.option(g||{})._init():a.data(this,f,new e(g,this))}),j}},a.Widget=function(){},a.Widget._childConstructors=[],a.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:!1,create:null},_createWidget:function(b,d){d=a(d||this.defaultElement||this)[0],this.element=a(d),this.uuid=c++,this.eventNamespace="."+this.widgetName+this.uuid,this.options=a.widget.extend({},this.options,this._getCreateOptions(),b),this.bindings=a(),this.hoverable=a(),this.focusable=a(),d!==this&&(a.data(d,this.widgetFullName,this),this._on(!0,this.element,{remove:function(a){a.target===d&&this.destroy()}}),this.document=a(d.style?d.ownerDocument:d.document||d),this.window=a(this.document[0].defaultView||this.document[0].parentWindow)),this._create(),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:a.noop,_getCreateEventData:a.noop,_create:a.noop,_init:a.noop,destroy:function(){this._destroy(),this.element.unbind(this.eventNamespace).removeData(this.widgetName).removeData(this.widgetFullName).removeData(a.camelCase(this.widgetFullName)),this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled ui-state-disabled"),this.bindings.unbind(this.eventNamespace),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")},_destroy:a.noop,widget:function(){return this.element},option:function(c,d){var e,f,g,h=c;if(0===arguments.length)return a.widget.extend({},this.options);if("string"==typeof c)if(h={},e=c.split("."),c=e.shift(),e.length){for(f=h[c]=a.widget.extend({},this.options[c]),g=0;e.length-1>g;g++)f[e[g]]=f[e[g]]||{},f=f[e[g]];if(c=e.pop(),1===arguments.length)return f[c]===b?null:f[c];f[c]=d}else{if(1===arguments.length)return this.options[c]===b?null:this.options[c];h[c]=d}return this._setOptions(h),this},_setOptions:function(a){var b;for(b in a)this._setOption(b,a[b]);return this},_setOption:function(a,b){return this.options[a]=b,"disabled"===a&&(this.widget().toggleClass(this.widgetFullName+"-disabled ui-state-disabled",!!b).attr("aria-disabled",b),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")),this},enable:function(){return this._setOption("disabled",!1)},disable:function(){return this._setOption("disabled",!0)},_on:function(c,d,e){var f,g=this;"boolean"!=typeof c&&(e=d,d=c,c=!1),e?(d=f=a(d),this.bindings=this.bindings.add(d)):(e=d,d=this.element,f=this.widget()),a.each(e,function(e,h){function i(){return c||g.options.disabled!==!0&&!a(this).hasClass("ui-state-disabled")?("string"==typeof h?g[h]:h).apply(g,arguments):b}"string"!=typeof h&&(i.guid=h.guid=h.guid||i.guid||a.guid++);var j=e.match(/^(\w+)\s*(.*)$/),k=j[1]+g.eventNamespace,l=j[2];l?f.delegate(l,k,i):d.bind(k,i)})},_off:function(a,b){b=(b||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,a.unbind(b).undelegate(b)},_delay:function(a,b){function c(){return("string"==typeof a?d[a]:a).apply(d,arguments)}var d=this;return setTimeout(c,b||0)},_hoverable:function(b){this.hoverable=this.hoverable.add(b),this._on(b,{mouseenter:function(b){a(b.currentTarget).addClass("ui-state-hover")},mouseleave:function(b){a(b.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(b){this.focusable=this.focusable.add(b),this._on(b,{focusin:function(b){a(b.currentTarget).addClass("ui-state-focus")},focusout:function(b){a(b.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(b,c,d){var e,f,g=this.options[b];if(d=d||{},c=a.Event(c),c.type=(b===this.widgetEventPrefix?b:this.widgetEventPrefix+b).toLowerCase(),c.target=this.element[0],f=c.originalEvent)for(e in f)e in c||(c[e]=f[e]);return this.element.trigger(c,d),!(a.isFunction(g)&&g.apply(this.element[0],[c].concat(d))===!1||c.isDefaultPrevented())}},a.each({show:"fadeIn",hide:"fadeOut"},function(b,c){a.Widget.prototype["_"+b]=function(d,e,f){"string"==typeof e&&(e={effect:e});var g,h=e?e===!0||"number"==typeof e?c:e.effect||c:b;e=e||{},"number"==typeof e&&(e={duration:e}),g=!a.isEmptyObject(e),e.complete=f,e.delay&&d.delay(e.delay),g&&a.effects&&a.effects.effect[h]?d[b](e):h!==b&&d[h]?d[h](e.duration,e.easing,f):d.queue(function(c){a(this)[b](),f&&f.call(d[0]),c()})}})}(jQuery),function(a){var b=!1;a(document).mouseup(function(){b=!1}),a.widget("ui.mouse",{version:"1.10.4",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var b=this;this.element.bind("mousedown."+this.widgetName,function(a){return b._mouseDown(a)}).bind("click."+this.widgetName,function(c){return!0===a.data(c.target,b.widgetName+".preventClickEvent")?(a.removeData(c.target,b.widgetName+".preventClickEvent"),c.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&a(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(c){if(!b){this._mouseStarted&&this._mouseUp(c),this._mouseDownEvent=c;var d=this,e=1===c.which,f="string"==typeof this.options.cancel&&c.target.nodeName?a(c.target).closest(this.options.cancel).length:!1;return e&&!f&&this._mouseCapture(c)?(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){d.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(c)&&this._mouseDelayMet(c)&&(this._mouseStarted=this._mouseStart(c)!==!1,!this._mouseStarted)?(c.preventDefault(),!0):(!0===a.data(c.target,this.widgetName+".preventClickEvent")&&a.removeData(c.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(a){return d._mouseMove(a)},this._mouseUpDelegate=function(a){return d._mouseUp(a)},a(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),c.preventDefault(),b=!0,!0)):!0}},_mouseMove:function(b){return a.ui.ie&&(!document.documentMode||9>document.documentMode)&&!b.button?this._mouseUp(b):this._mouseStarted?(this._mouseDrag(b),b.preventDefault()):(this._mouseDistanceMet(b)&&this._mouseDelayMet(b)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,b)!==!1,this._mouseStarted?this._mouseDrag(b):this._mouseUp(b)),!this._mouseStarted)},_mouseUp:function(b){return a(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,b.target===this._mouseDownEvent.target&&a.data(b.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(b)),!1},_mouseDistanceMet:function(a){return Math.max(Math.abs(this._mouseDownEvent.pageX-a.pageX),Math.abs(this._mouseDownEvent.pageY-a.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}})}(jQuery),function(a){a.widget("ui.draggable",a.ui.mouse,{version:"1.10.4",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1,drag:null,start:null,stop:null},_create:function(){"original"!==this.options.helper||/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative"),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._mouseInit()},_destroy:function(){this.element.removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._mouseDestroy()},_mouseCapture:function(b){var c=this.options;return this.helper||c.disabled||a(b.target).closest(".ui-resizable-handle").length>0?!1:(this.handle=this._getHandle(b),this.handle?(a(c.iframeFix===!0?"iframe":c.iframeFix).each(function(){a("<div class='ui-draggable-iframeFix' style='background: #fff;'></div>").css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e3}).css(a(this).offset()).appendTo("body")}),!0):!1)},_mouseStart:function(b){var c=this.options;return this.helper=this._createHelper(b),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),a.ui.ddmanager&&(a.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(),this.offsetParent=this.helper.offsetParent(),this.offsetParentCssPosition=this.offsetParent.css("position"),this.offset=this.positionAbs=this.element.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},this.offset.scroll=!1,a.extend(this.offset,{click:{left:b.pageX-this.offset.left,top:b.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.originalPosition=this.position=this._generatePosition(b),this.originalPageX=b.pageX,this.originalPageY=b.pageY,c.cursorAt&&this._adjustOffsetFromHelper(c.cursorAt),this._setContainment(),this._trigger("start",b)===!1?(this._clear(),!1):(this._cacheHelperProportions(),a.ui.ddmanager&&!c.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b),this._mouseDrag(b,!0),a.ui.ddmanager&&a.ui.ddmanager.dragStart(this,b),!0)},_mouseDrag:function(b,c){if("fixed"===this.offsetParentCssPosition&&(this.offset.parent=this._getParentOffset()),this.position=this._generatePosition(b),this.positionAbs=this._convertPositionTo("absolute"),!c){var d=this._uiHash();if(this._trigger("drag",b,d)===!1)return this._mouseUp({}),!1;this.position=d.position}return this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),a.ui.ddmanager&&a.ui.ddmanager.drag(this,b),!1},_mouseStop:function(b){var c=this,d=!1;return a.ui.ddmanager&&!this.options.dropBehaviour&&(d=a.ui.ddmanager.drop(this,b)),this.dropped&&(d=this.dropped,this.dropped=!1),"original"!==this.options.helper||a.contains(this.element[0].ownerDocument,this.element[0])?("invalid"===this.options.revert&&!d||"valid"===this.options.revert&&d||this.options.revert===!0||a.isFunction(this.options.revert)&&this.options.revert.call(this.element,d)?a(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){c._trigger("stop",b)!==!1&&c._clear()}):this._trigger("stop",b)!==!1&&this._clear(),!1):!1},_mouseUp:function(b){return a("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)}),a.ui.ddmanager&&a.ui.ddmanager.dragStop(this,b),a.ui.mouse.prototype._mouseUp.call(this,b)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(b){return this.options.handle?!!a(b.target).closest(this.element.find(this.options.handle)).length:!0},_createHelper:function(b){var c=this.options,d=a.isFunction(c.helper)?a(c.helper.apply(this.element[0],[b])):"clone"===c.helper?this.element.clone().removeAttr("id"):this.element;return d.parents("body").length||d.appendTo("parent"===c.appendTo?this.element[0].parentNode:c.appendTo),d[0]===this.element[0]||/(fixed|absolute)/.test(d.css("position"))||d.css("position","absolute"),d},_adjustOffsetFromHelper:function(b){"string"==typeof b&&(b=b.split(" ")),a.isArray(b)&&(b={left:+b[0],top:+b[1]||0}),"left"in b&&(this.offset.click.left=b.left+this.margins.left),"right"in b&&(this.offset.click.left=this.helperProportions.width-b.right+this.margins.left),"top"in b&&(this.offset.click.top=b.top+this.margins.top),"bottom"in b&&(this.offset.click.top=this.helperProportions.height-b.bottom+this.margins.top)},_getParentOffset:function(){var b=this.offsetParent.offset();return"absolute"===this.cssPosition&&this.scrollParent[0]!==document&&a.contains(this.scrollParent[0],this.offsetParent[0])&&(b.left+=this.scrollParent.scrollLeft(),b.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]===document.body||this.offsetParent[0].tagName&&"html"===this.offsetParent[0].tagName.toLowerCase()&&a.ui.ie)&&(b={top:0,left:0}),{top:b.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:b.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"===this.cssPosition){var a=this.element.position();return{top:a.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:a.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var c,d,e,f=this.options;return f.containment?"window"===f.containment?void(this.containment=[a(b).scrollLeft()-this.offset.relative.left-this.offset.parent.left,a(b).scrollTop()-this.offset.relative.top-this.offset.parent.top,a(b).scrollLeft()+a(b).width()-this.helperProportions.width-this.margins.left,a(b).scrollTop()+(a(b).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]):"document"===f.containment?void(this.containment=[0,0,a(document).width()-this.helperProportions.width-this.margins.left,(a(document).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]):f.containment.constructor===Array?void(this.containment=f.containment):("parent"===f.containment&&(f.containment=this.helper[0].parentNode),d=a(f.containment),e=d[0],void(e&&(c="hidden"!==d.css("overflow"),this.containment=[(parseInt(d.css("borderLeftWidth"),10)||0)+(parseInt(d.css("paddingLeft"),10)||0),(parseInt(d.css("borderTopWidth"),10)||0)+(parseInt(d.css("paddingTop"),10)||0),(c?Math.max(e.scrollWidth,e.offsetWidth):e.offsetWidth)-(parseInt(d.css("borderRightWidth"),10)||0)-(parseInt(d.css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(c?Math.max(e.scrollHeight,e.offsetHeight):e.offsetHeight)-(parseInt(d.css("borderBottomWidth"),10)||0)-(parseInt(d.css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relative_container=d))):void(this.containment=null)},_convertPositionTo:function(b,c){c||(c=this.position);var d="absolute"===b?1:-1,e="absolute"!==this.cssPosition||this.scrollParent[0]!==document&&a.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent;return this.offset.scroll||(this.offset.scroll={top:e.scrollTop(),left:e.scrollLeft()}),{top:c.top+this.offset.relative.top*d+this.offset.parent.top*d-("fixed"===this.cssPosition?-this.scrollParent.scrollTop():this.offset.scroll.top)*d,left:c.left+this.offset.relative.left*d+this.offset.parent.left*d-("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():this.offset.scroll.left)*d}},_generatePosition:function(b){var c,d,e,f,g=this.options,h="absolute"!==this.cssPosition||this.scrollParent[0]!==document&&a.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,i=b.pageX,j=b.pageY;return this.offset.scroll||(this.offset.scroll={top:h.scrollTop(),left:h.scrollLeft()}),this.originalPosition&&(this.containment&&(this.relative_container?(d=this.relative_container.offset(),c=[this.containment[0]+d.left,this.containment[1]+d.top,this.containment[2]+d.left,this.containment[3]+d.top]):c=this.containment,b.pageX-this.offset.click.left<c[0]&&(i=c[0]+this.offset.click.left),b.pageY-this.offset.click.top<c[1]&&(j=c[1]+this.offset.click.top),b.pageX-this.offset.click.left>c[2]&&(i=c[2]+this.offset.click.left),b.pageY-this.offset.click.top>c[3]&&(j=c[3]+this.offset.click.top)),g.grid&&(e=g.grid[1]?this.originalPageY+Math.round((j-this.originalPageY)/g.grid[1])*g.grid[1]:this.originalPageY,j=c?e-this.offset.click.top>=c[1]||e-this.offset.click.top>c[3]?e:e-this.offset.click.top>=c[1]?e-g.grid[1]:e+g.grid[1]:e,f=g.grid[0]?this.originalPageX+Math.round((i-this.originalPageX)/g.grid[0])*g.grid[0]:this.originalPageX,i=c?f-this.offset.click.left>=c[0]||f-this.offset.click.left>c[2]?f:f-this.offset.click.left>=c[0]?f-g.grid[0]:f+g.grid[0]:f)),{top:j-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.scrollParent.scrollTop():this.offset.scroll.top),left:i-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():this.offset.scroll.left)}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]===this.element[0]||this.cancelHelperRemoval||this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1},_trigger:function(b,c,d){return d=d||this._uiHash(),a.ui.plugin.call(this,b,[c,d]),"drag"===b&&(this.positionAbs=this._convertPositionTo("absolute")),a.Widget.prototype._trigger.call(this,b,c,d)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),a.ui.plugin.add("draggable","connectToSortable",{start:function(b,c){var d=a(this).data("ui-draggable"),e=d.options,f=a.extend({},c,{item:d.element});
d.sortables=[],a(e.connectToSortable).each(function(){var c=a.data(this,"ui-sortable");c&&!c.options.disabled&&(d.sortables.push({instance:c,shouldRevert:c.options.revert}),c.refreshPositions(),c._trigger("activate",b,f))})},stop:function(b,c){var d=a(this).data("ui-draggable"),e=a.extend({},c,{item:d.element});a.each(d.sortables,function(){this.instance.isOver?(this.instance.isOver=0,d.cancelHelperRemoval=!0,this.instance.cancelHelperRemoval=!1,this.shouldRevert&&(this.instance.options.revert=this.shouldRevert),this.instance._mouseStop(b),this.instance.options.helper=this.instance.options._helper,"original"===d.options.helper&&this.instance.currentItem.css({top:"auto",left:"auto"})):(this.instance.cancelHelperRemoval=!1,this.instance._trigger("deactivate",b,e))})},drag:function(b,c){var d=a(this).data("ui-draggable"),e=this;a.each(d.sortables,function(){var f=!1,g=this;this.instance.positionAbs=d.positionAbs,this.instance.helperProportions=d.helperProportions,this.instance.offset.click=d.offset.click,this.instance._intersectsWith(this.instance.containerCache)&&(f=!0,a.each(d.sortables,function(){return this.instance.positionAbs=d.positionAbs,this.instance.helperProportions=d.helperProportions,this.instance.offset.click=d.offset.click,this!==g&&this.instance._intersectsWith(this.instance.containerCache)&&a.contains(g.instance.element[0],this.instance.element[0])&&(f=!1),f})),f?(this.instance.isOver||(this.instance.isOver=1,this.instance.currentItem=a(e).clone().removeAttr("id").appendTo(this.instance.element).data("ui-sortable-item",!0),this.instance.options._helper=this.instance.options.helper,this.instance.options.helper=function(){return c.helper[0]},b.target=this.instance.currentItem[0],this.instance._mouseCapture(b,!0),this.instance._mouseStart(b,!0,!0),this.instance.offset.click.top=d.offset.click.top,this.instance.offset.click.left=d.offset.click.left,this.instance.offset.parent.left-=d.offset.parent.left-this.instance.offset.parent.left,this.instance.offset.parent.top-=d.offset.parent.top-this.instance.offset.parent.top,d._trigger("toSortable",b),d.dropped=this.instance.element,d.currentItem=d.element,this.instance.fromOutside=d),this.instance.currentItem&&this.instance._mouseDrag(b)):this.instance.isOver&&(this.instance.isOver=0,this.instance.cancelHelperRemoval=!0,this.instance.options.revert=!1,this.instance._trigger("out",b,this.instance._uiHash(this.instance)),this.instance._mouseStop(b,!0),this.instance.options.helper=this.instance.options._helper,this.instance.currentItem.remove(),this.instance.placeholder&&this.instance.placeholder.remove(),d._trigger("fromSortable",b),d.dropped=!1)})}}),a.ui.plugin.add("draggable","cursor",{start:function(){var b=a("body"),c=a(this).data("ui-draggable").options;b.css("cursor")&&(c._cursor=b.css("cursor")),b.css("cursor",c.cursor)},stop:function(){var b=a(this).data("ui-draggable").options;b._cursor&&a("body").css("cursor",b._cursor)}}),a.ui.plugin.add("draggable","opacity",{start:function(b,c){var d=a(c.helper),e=a(this).data("ui-draggable").options;d.css("opacity")&&(e._opacity=d.css("opacity")),d.css("opacity",e.opacity)},stop:function(b,c){var d=a(this).data("ui-draggable").options;d._opacity&&a(c.helper).css("opacity",d._opacity)}}),a.ui.plugin.add("draggable","scroll",{start:function(){var b=a(this).data("ui-draggable");b.scrollParent[0]!==document&&"HTML"!==b.scrollParent[0].tagName&&(b.overflowOffset=b.scrollParent.offset())},drag:function(c){var d=a(this).data("ui-draggable"),e=d.options,f=!1;d.scrollParent[0]!==document&&"HTML"!==d.scrollParent[0].tagName?(e.axis&&"x"===e.axis||(d.overflowOffset.top+d.scrollParent[0].offsetHeight-c.pageY<e.scrollSensitivity?d.scrollParent[0].scrollTop=f=d.scrollParent[0].scrollTop+e.scrollSpeed:c.pageY-d.overflowOffset.top<e.scrollSensitivity&&(d.scrollParent[0].scrollTop=f=d.scrollParent[0].scrollTop-e.scrollSpeed)),e.axis&&"y"===e.axis||(d.overflowOffset.left+d.scrollParent[0].offsetWidth-c.pageX<e.scrollSensitivity?d.scrollParent[0].scrollLeft=f=d.scrollParent[0].scrollLeft+e.scrollSpeed:c.pageX-d.overflowOffset.left<e.scrollSensitivity&&(d.scrollParent[0].scrollLeft=f=d.scrollParent[0].scrollLeft-e.scrollSpeed))):(e.axis&&"x"===e.axis||(c.pageY-a(document).scrollTop()<e.scrollSensitivity?f=a(document).scrollTop(a(document).scrollTop()-e.scrollSpeed):a(b).height()-(c.pageY-a(document).scrollTop())<e.scrollSensitivity&&(f=a(document).scrollTop(a(document).scrollTop()+e.scrollSpeed))),e.axis&&"y"===e.axis||(c.pageX-a(document).scrollLeft()<e.scrollSensitivity?f=a(document).scrollLeft(a(document).scrollLeft()-e.scrollSpeed):a(b).width()-(c.pageX-a(document).scrollLeft())<e.scrollSensitivity&&(f=a(document).scrollLeft(a(document).scrollLeft()+e.scrollSpeed)))),f!==!1&&a.ui.ddmanager&&!e.dropBehaviour&&a.ui.ddmanager.prepareOffsets(d,c)}}),a.ui.plugin.add("draggable","snap",{start:function(){var b=a(this).data("ui-draggable"),c=b.options;b.snapElements=[],a(c.snap.constructor!==String?c.snap.items||":data(ui-draggable)":c.snap).each(function(){var c=a(this),d=c.offset();this!==b.element[0]&&b.snapElements.push({item:this,width:c.outerWidth(),height:c.outerHeight(),top:d.top,left:d.left})})},drag:function(b,c){var d,e,f,g,h,i,j,k,l,m,n=a(this).data("ui-draggable"),o=n.options,p=o.snapTolerance,q=c.offset.left,r=q+n.helperProportions.width,s=c.offset.top,t=s+n.helperProportions.height;for(l=n.snapElements.length-1;l>=0;l--)h=n.snapElements[l].left,i=h+n.snapElements[l].width,j=n.snapElements[l].top,k=j+n.snapElements[l].height,h-p>r||q>i+p||j-p>t||s>k+p||!a.contains(n.snapElements[l].item.ownerDocument,n.snapElements[l].item)?(n.snapElements[l].snapping&&n.options.snap.release&&n.options.snap.release.call(n.element,b,a.extend(n._uiHash(),{snapItem:n.snapElements[l].item})),n.snapElements[l].snapping=!1):("inner"!==o.snapMode&&(d=p>=Math.abs(j-t),e=p>=Math.abs(k-s),f=p>=Math.abs(h-r),g=p>=Math.abs(i-q),d&&(c.position.top=n._convertPositionTo("relative",{top:j-n.helperProportions.height,left:0}).top-n.margins.top),e&&(c.position.top=n._convertPositionTo("relative",{top:k,left:0}).top-n.margins.top),f&&(c.position.left=n._convertPositionTo("relative",{top:0,left:h-n.helperProportions.width}).left-n.margins.left),g&&(c.position.left=n._convertPositionTo("relative",{top:0,left:i}).left-n.margins.left)),m=d||e||f||g,"outer"!==o.snapMode&&(d=p>=Math.abs(j-s),e=p>=Math.abs(k-t),f=p>=Math.abs(h-q),g=p>=Math.abs(i-r),d&&(c.position.top=n._convertPositionTo("relative",{top:j,left:0}).top-n.margins.top),e&&(c.position.top=n._convertPositionTo("relative",{top:k-n.helperProportions.height,left:0}).top-n.margins.top),f&&(c.position.left=n._convertPositionTo("relative",{top:0,left:h}).left-n.margins.left),g&&(c.position.left=n._convertPositionTo("relative",{top:0,left:i-n.helperProportions.width}).left-n.margins.left)),!n.snapElements[l].snapping&&(d||e||f||g||m)&&n.options.snap.snap&&n.options.snap.snap.call(n.element,b,a.extend(n._uiHash(),{snapItem:n.snapElements[l].item})),n.snapElements[l].snapping=d||e||f||g||m)}}),a.ui.plugin.add("draggable","stack",{start:function(){var b,c=this.data("ui-draggable").options,d=a.makeArray(a(c.stack)).sort(function(b,c){return(parseInt(a(b).css("zIndex"),10)||0)-(parseInt(a(c).css("zIndex"),10)||0)});d.length&&(b=parseInt(a(d[0]).css("zIndex"),10)||0,a(d).each(function(c){a(this).css("zIndex",b+c)}),this.css("zIndex",b+d.length))}}),a.ui.plugin.add("draggable","zIndex",{start:function(b,c){var d=a(c.helper),e=a(this).data("ui-draggable").options;d.css("zIndex")&&(e._zIndex=d.css("zIndex")),d.css("zIndex",e.zIndex)},stop:function(b,c){var d=a(this).data("ui-draggable").options;d._zIndex&&a(c.helper).css("zIndex",d._zIndex)}})}(jQuery),function(a){function c(b,c,d){if(b.prototype=a.extend2(a.extend({},c),(KM.ui[d]||g).prototype,!0),b.prototype.supper=(KM.ui[d]||g).prototype,KM.ui[d]&&KM.ui[d].prototype.defaultOpt){var e=KM.ui[d].prototype.defaultOpt,f=b.prototype.defaultOpt;b.prototype.defaultOpt=a.extend({},e,f||{})}return b}function d(b,c){a[h+c]=b,a.fn[h+c]=function(c){var d,e=Array.prototype.slice.call(arguments,1);return this.each(function(f,g){var h=a(g),i=h.kmui();if(i||(b(c&&a.isPlainObject(c)?c:{},h),h.kmui(i)),"string"==a.type(c))if("this"==c)d=i;else{if(d=i[c].apply(i,e),d!==i&&void 0!==d)return!1;d=null}}),null!==d?d:this}}a.parseTmpl=function(a,b){var c="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(a,b){return"',"+b.replace(/\\'/g,"'")+",'"}).replace(/<%([\s\S]+?)%>/g,function(a,b){return"');"+b.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",d=new Function("obj",c);return b?d(b):d},a.extend2=function(b){for(var c=arguments,d="boolean"==a.type(c[c.length-1])?c[c.length-1]:!1,e="boolean"==a.type(c[c.length-1])?c.length-1:c.length,f=1;e>f;f++){var g=c[f];for(var h in g)d&&b.hasOwnProperty(h)||(b[h]=g[h])}return b},a.IE6=!!b.ActiveXObject&&6==parseFloat(navigator.userAgent.match(/msie (\d+)/i)[1]);var e=[],g=function(){},h="kmui";g.prototype={on:function(b,c){return this.root().on(b,a.proxy(c,this)),this},off:function(b,c){return this.root().off(b,a.proxy(c,this)),this},trigger:function(a,b){return this.root().trigger(a,b)===!1?!1:this},root:function(a){return this._$el||(this._$el=a)},destroy:function(){},data:function(a,b){return void 0!==b?(this.root().data(h+a,b),this):this.root().data(h+a)},register:function(b,c,d){e.push({evtname:b,$els:a.isArray(c)?c:[c],handler:a.proxy(d,c)})}},a.fn.kmui=function(a){return a?this.data("kmuiwidget",a):this.data("kmuiwidget")};var i=1;KM.ui={define:function(b,e,g){var j=KM.ui[b]=c(function(c,d){var e=function(){};a.extend(e.prototype,j.prototype,{guid:b+i++,widgetName:b});var g=new e;if("string"==a.type(c))return g.init&&g.init({}),g.root().kmui(g),g.root().find("a").click(function(a){a.preventDefault()}),g.root()[h+b].apply(g.root(),arguments);d&&g.root(d),g.init&&g.init(f.clonePlainObject(!c||a.isPlainObject(c)?a.extend2(c||{},g.defaultOpt||{},!0):c));try{g.root().find("a").click(function(a){a.preventDefault()})}catch(k){}return g.root().kmui(g)},e,g);d(j,b)}},a(function(){a(document).on("click mouseup mousedown dblclick mouseover",function(b){a.each(e,function(c,d){d.evtname==b.type&&a.each(d.$els,function(c,e){e[0]===b.target||a.contains(e[0],b.target)||d.handler(b)})})})})}(jQuery),KM.ui.define("button",{tpl:'<<%if(!texttype){%>div class="kmui-btn kmui-btn-<%=icon%> <%if(name){%>kmui-btn-name-<%=name%><%}%>" unselectable="on" onmousedown="return false" <%}else{%>a class="kmui-text-btn"<%}%><% if(title) {%> data-original-title="<%=title%>" <%};%>> <% if(icon) {%><div unselectable="on" class="kmui-icon-<%=icon%> kmui-icon"></div><% }; %><%if(text) {%><span unselectable="on" onmousedown="return false" class="kmui-button-label"><%=text%></span><%}%><%if(caret && text){%><span class="kmui-button-spacing"></span><%}%><% if(caret) {%><span unselectable="on" onmousedown="return false" class="kmui-caret"></span><% };%></<%if(!texttype){%>div<%}else{%>a<%}%>>',defaultOpt:{text:"",title:"",icon:"",width:"",caret:!1,texttype:!1,click:function(){}},init:function(a){var b=this;return b.root($($.parseTmpl(b.tpl,a))).click(function(c){b.wrapclick(a.click,c)}),b.root().hover(function(){b.root().hasClass("kmui-disabled")||b.root().toggleClass("kmui-hover")}),b},wrapclick:function(a,b){return this.disabled()||(this.root().trigger("wrapclick"),$.proxy(a,this,b)()),this},label:function(a){return void 0===a?this.root().find(".kmui-button-label").text():(this.root().find(".kmui-button-label").text(a),this)},disabled:function(a){return void 0===a?this.root().hasClass("kmui-disabled"):(this.root().toggleClass("kmui-disabled",a),this.root().hasClass("kmui-disabled")&&this.root().removeClass("kmui-hover"),this)},active:function(a){return void 0===a?this.root().hasClass("kmui-active"):(this.root().toggleClass("kmui-active",a),this)},mergeWith:function(a){var b=this;b.data("$mergeObj",a),a.kmui().data("$mergeObj",b.root()),$.contains(document.body,a[0])||a.appendTo(b.root()),b.on("click",function(){b.wrapclick(function(){a.kmui().show()})}).register("click",b.root(),function(){a.hide()})}}),function(){KM.ui.define("toolbar",{tpl:'<div class="kmui-toolbar"  ><div class="kmui-btn-toolbar" unselectable="on" onmousedown="return false"  ></div></div>',init:function(){var a=this.root($(this.tpl));this.data("$btnToolbar",a.find(".kmui-btn-toolbar"))},appendToBtnmenu:function(a){var b=this.data("$btnToolbar");a=$.isArray(a)?a:[a],$.each(a,function(a,c){b.append(c)})}})}(),KM.ui.define("menu",{show:function(a,b,c,d,e){c=c||"position",this.trigger("beforeshow")!==!1&&(this.root().css($.extend({display:"block"},a?{top:a[c]().top+("right"==b?0:a.outerHeight())-(d||0),left:a[c]().left+("right"==b?a.outerWidth():0)-(e||0)}:{})),this.trigger("aftershow"),a.addClass("active"))},hide:function(a){var b;if(this.trigger("beforehide")!==!1){(b=this.root().data("parentmenu"))&&(b.data("parentmenu")||a)&&b.kmui().hide(),this.root().css("display","none"),this.trigger("afterhide");var c=this.data("$mergeObj");c&&c.removeClass("active")}},attachTo:function(a){var b=this;a.data("$mergeObj")||(a.data("$mergeObj",b.root()),a.kmui()?a.on("wrapclick",function(){b.supper.show.call(b,a,"","offset",15)}):a.on("click",function(){b.supper.show.call(b,a,"","offset",15)}),b.register("click",a,function(){b.hide()}),b.data("$mergeObj",a))}}),KM.ui.define("dropmenu",{tmpl:'<ul class="kmui-dropdown-menu" aria-labelledby="dropdownMenu" ><%if(data && data.length){for(var i=0,ci;ci=data[i++];){%><%if(ci.divider){%><li class="kmui-divider"></li><%}else{%><li id="<%= ci.id%>" <%if(ci.active||ci.disabled){%>class="<%= ci.active|| \'\' %> <%=ci.disabled||\'\' %>" <%}%> data-value="<%= ci.value%>" data-label="<%= ci.label%>"><a href="#" tabindex="-1"><em class="kmui-dropmenu-checkbox"><i class="kmui-icon-ok"></i></em><%= ci.label%></a></li><%}}%><%}%></ul>',subTmpl:'<%if(data && data.length){for(var i=0,ci;ci=data[i++];){%><%if(ci.divider){%><li class="kmui-divider"></li><%}else{%><li <%if(ci.active||ci.disabled){%>class="<%= ci.active|| \'\' %> <%=ci.disabled||\'\' %>" <%}%> data-value="<%= ci.value%>" data-label="<%= ci.label%>"><a href="#" tabindex="-1"><em class="kmui-dropmenu-checkbox"><i class="kmui-icon-ok"></i></em><%= ci.label%></a></li><%}}%><%}%>',defaultOpt:{data:[],anchor:"top",click:function(){}},setData:function(a){return this.root().html($.parseTmpl(this.subTmpl,a)),this},position:function(a){return this.root().css({left:a.x,top:a.y}),this},show:function(){return this.trigger("beforeshow")!==!1?(this.root().css({display:"block"}),this.trigger("aftershow"),this):void 0},init:function(a){var b=this,c={click:1,mouseover:1,mouseout:1};this.root($($.parseTmpl(this.tmpl,a))).on("click",'li[class!="kmui-disabled kmui-divider kmui-dropdown-submenu"]',function(c){$.proxy(a.click,b,c,$(this).data("value"),$(this).data("label"),$(this))()}).find("li").each(function(d,e){var f=$(this);if(!f.hasClass("kmui-disabled kmui-divider kmui-dropdown-submenu")){var g=a.data[d];$.each(c,function(a){g[a]&&f[a](function(c){$.proxy(g[a],e)(c,g,b.root)})})}})},_initEvent:function(){this.root().on("mouseover",'li[class="kmui-dropdown-submenu',function(){var a=$(this).data("widget");a.kmui().show($(this),"right","position",5,2)})},disabled:function(a){$("li[class!=kmui-divider]",this.root()).each(function(){var b=$(this);a===!0?b.addClass("kmui-disabled"):$.isFunction(a)?b.toggleClass("kmui-disabled",a(b)):b.removeClass("kmui-disabled")})},val:function(a){var b;return $('li[class!="kmui-divider kmui-disabled kmui-dropdown-submenu"]',this.root()).each(function(){var c=$(this);if(void 0===a){if(c.find("em.kmui-dropmenu-checked").length)return b=c.data("value"),!1}else c.find("em").toggleClass("kmui-dropmenu-checked",c.data("value")==a)}),void 0===a?b:void 0},appendItem:function(a){var b='<%if(item.divider){%><li class="kmui-divider"></li><%}else{%><li id="<%= item.id%>" <%if(item.active||item.disabled){%>class="<%= item.active|| \'\' %> <%=item.disabled||\'\' %>" <%}%> data-value="<%= item.value%>" data-label="<%= item.label%>"><a href="#" tabindex="-1"><em class="kmui-dropmenu-checkbox"><i class="kmui-icon-ok"></i></em><%= item.label%></a></li><%}%>',c=$.parseTmpl(b,a),d=$(c).click(a.click);return this.root().append(d),d},addSubmenu:function(a,b,c){c=c||0;var d=$("li[class!=kmui-divider]",this.root()),e=$('<li class="kmui-dropdown-submenu"><a tabindex="-1" href="#">'+a+"</a></li>").append(b);e.data("widget",b),c>=0&&c<d.length?e.insertBefore(d[c]):0>c?e.insertBefore(d[0]):c>=d.length&&e.appendTo(d)}},"menu"),KM.ui.define("splitbutton",{tpl:'<div class="kmui-splitbutton <%if (name){%>kmui-splitbutton-<%= name %><%}%>"  unselectable="on" <%if(title){%>data-original-title="<%=title%>"<%}%>><div class="kmui-btn"  unselectable="on" ><%if(icon){%><div  unselectable="on" class="kmui-icon-<%=icon%> kmui-icon"></div><%}%><%if(text){%><%=text%><%}%></div><div  unselectable="on" class="kmui-btn kmui-dropdown-toggle" ><div  unselectable="on" class="kmui-caret"></div></div></div>',defaultOpt:{text:"",title:"",click:function(){}},init:function(a){var b=this;return b.root($($.parseTmpl(b.tpl,a))),b.root().find(".kmui-btn:first").click(function(){b.disabled()||$.proxy(a.click,b)()}),b.root().find(".kmui-dropdown-toggle").click(function(){b.disabled()||b.trigger("arrowclick")}),b.root().hover(function(){b.root().hasClass("kmui-disabled")||b.root().toggleClass("kmui-hover")}),b},wrapclick:function(a,b){return this.disabled()||$.proxy(a,this,b)(),this},disabled:function(a){return void 0===a?this.root().hasClass("kmui-disabled"):(this.root().toggleClass("kmui-disabled",a).find(".kmui-btn").toggleClass("kmui-disabled",a),this)},active:function(a){return void 0===a?this.root().hasClass("kmui-active"):(this.root().toggleClass("kmui-active",a).find(".kmui-btn:first").toggleClass("kmui-active",a),this)},mergeWith:function(a){var b=this;b.data("$mergeObj",a),a.kmui().data("$mergeObj",b.root()),$.contains(document.body,a[0])||a.appendTo(b.root()),b.root().delegate(".kmui-dropdown-toggle","click",function(){b.wrapclick(function(){a.kmui().show()})}),b.register("click",b.root().find(".kmui-dropdown-toggle"),function(){a.hide()})}}),KM.ui.define("colorsplitbutton",{tpl:'<div class="kmui-splitbutton <%if (name){%>kmui-splitbutton-<%= name %><%}%>"  unselectable="on" <%if(title){%>data-original-title="<%=title%>"<%}%>><div class="kmui-btn"  unselectable="on" ><%if(icon){%><div  unselectable="on" class="kmui-icon-<%=icon%> kmui-icon"></div><%}%><div class="kmui-splitbutton-color-label" <%if (color) {%>style="background: <%=color%>"<%}%>></div><%if(text){%><%=text%><%}%></div><div  unselectable="on" class="kmui-btn kmui-dropdown-toggle" ><div  unselectable="on" class="kmui-caret"></div></div></div>',defaultOpt:{color:""},init:function(a){var b=this;b.supper.init.call(b,a)},colorLabel:function(){return this.root().find(".kmui-splitbutton-color-label")}},"splitbutton"),KM.ui.define("popup",{tpl:'<div class="kmui-dropdown-menu kmui-popup"<%if(!<%=stopprop%>){%>onmousedown="return false"<%}%>><div class="kmui-popup-body" unselectable="on" onmousedown="return false"><%=subtpl%></div><div class="kmui-popup-caret"></div></div>',defaultOpt:{stopprop:!1,subtpl:"",width:"",height:""},init:function(a){return this.root($($.parseTmpl(this.tpl,a))),this},mergeTpl:function(a){return $.parseTmpl(this.tpl,{subtpl:a})},show:function(a,b){b||(b={});var c=b.fnname||"position";this.trigger("beforeshow")!==!1&&(this.root().css($.extend({display:"block"},a?{top:a[c]().top+("right"==b.dir?0:a.outerHeight())-(b.offsetTop||0),left:a[c]().left+("right"==b.dir?a.outerWidth():0)-(b.offsetLeft||0),position:"absolute"}:{})),this.root().find(".kmui-popup-caret").css({top:b.caretTop||0,left:b.caretLeft||0,position:"absolute"}).addClass(b.caretDir||"up"),this.trigger("aftershow"))},hide:function(){this.root().css("display","none"),this.trigger("afterhide")},attachTo:function(a,b){var c=this;a.data("$mergeObj")||(a.data("$mergeObj",c.root()),a.on("wrapclick",function(){c.show(a,b)}),c.register("click",a,function(){c.hide()}),c.data("$mergeObj",a))},getBodyContainer:function(){return this.root().find(".kmui-popup-body")}}),KM.ui.define("scale",{tpl:'<div class="kmui-scale" unselectable="on"><span class="kmui-scale-hand0"></span><span class="kmui-scale-hand1"></span><span class="kmui-scale-hand2"></span><span class="kmui-scale-hand3"></span><span class="kmui-scale-hand4"></span><span class="kmui-scale-hand5"></span><span class="kmui-scale-hand6"></span><span class="kmui-scale-hand7"></span></div>',defaultOpt:{$doc:$(document),$wrap:$(document)},init:function(a){return a.$doc&&(this.defaultOpt.$doc=a.$doc),a.$wrap&&(this.defaultOpt.$wrap=a.$wrap),this.root($($.parseTmpl(this.tpl,a))),this.initStyle(),this.startPos=this.prePos={x:0,y:0},this.dragId=-1,this},initStyle:function(){f.cssRule("kmui-style-scale",".kmui-scale{display:none;position:absolute;border:1px solid #38B2CE;cursor:hand;}.kmui-scale span{position:absolute;left:0;top:0;width:7px;height:7px;overflow:hidden;font-size:0px;display:block;background-color:#3C9DD0;}.kmui-scale .kmui-scale-hand0{cursor:nw-resize;top:0;margin-top:-4px;left:0;margin-left:-4px;}.kmui-scale .kmui-scale-hand1{cursor:n-resize;top:0;margin-top:-4px;left:50%;margin-left:-4px;}.kmui-scale .kmui-scale-hand2{cursor:ne-resize;top:0;margin-top:-4px;left:100%;margin-left:-3px;}.kmui-scale .kmui-scale-hand3{cursor:w-resize;top:50%;margin-top:-4px;left:0;margin-left:-4px;}.kmui-scale .kmui-scale-hand4{cursor:e-resize;top:50%;margin-top:-4px;left:100%;margin-left:-3px;}.kmui-scale .kmui-scale-hand5{cursor:sw-resize;top:100%;margin-top:-3px;left:0;margin-left:-4px;}.kmui-scale .kmui-scale-hand6{cursor:s-resize;top:100%;margin-top:-3px;left:50%;margin-left:-4px;}.kmui-scale .kmui-scale-hand7{cursor:se-resize;top:100%;margin-top:-3px;left:100%;margin-left:-3px;}")},_eventHandler:function(a){var b=this,c=b.defaultOpt.$doc;switch(a.type){case"mousedown":var d,d=a.target||a.srcElement;-1!=d.className.indexOf("kmui-scale-hand")&&(b.dragId=d.className.slice(-1),b.startPos.x=b.prePos.x=a.clientX,b.startPos.y=b.prePos.y=a.clientY,c.bind("mousemove",$.proxy(b._eventHandler,b)));break;case"mousemove":-1!=b.dragId&&(b.updateContainerStyle(b.dragId,{x:a.clientX-b.prePos.x,y:a.clientY-b.prePos.y}),b.prePos.x=a.clientX,b.prePos.y=a.clientY,b.updateTargetElement());break;case"mouseup":if(-1!=b.dragId){b.dragId=-1,b.updateTargetElement();var e=b.data("$scaleTarget");e.parent()&&b.attachTo(b.data("$scaleTarget"))}c.unbind("mousemove",$.proxy(b._eventHandler,b))}},updateTargetElement:function(){var a=this,b=a.root(),c=a.data("$scaleTarget");c.css({width:b.width(),height:b.height()}),a.attachTo(c)},updateContainerStyle:function(a,b){var c,d=this,e=d.root(),f=[[0,0,-1,-1],[0,0,0,-1],[0,0,1,-1],[0,0,-1,0],[0,0,1,0],[0,0,-1,1],[0,0,0,1],[0,0,1,1]];0!=f[a][0]&&(c=parseInt(e.offset().left)+b.x,e.css("left",d._validScaledProp("left",c))),0!=f[a][1]&&(c=parseInt(e.offset().top)+b.y,e.css("top",d._validScaledProp("top",c))),0!=f[a][2]&&(c=e.width()+f[a][2]*b.x,e.css("width",d._validScaledProp("width",c))),0!=f[a][3]&&(c=e.height()+f[a][3]*b.y,e.css("height",d._validScaledProp("height",c)))},_validScaledProp:function(a,b){var c=this.root(),d=this.defaultOpt.$doc,e=function(a,c,d){return a+c>d?d-c:b};switch(b=isNaN(b)?0:b,a){case"left":return 0>b?0:e(b,c.width(),d.width());case"top":return 0>b?0:e(b,c.height(),d.height());case"width":return 0>=b?1:e(b,c.offset().left,d.width());case"height":return 0>=b?1:e(b,c.offset().top,d.height())}},show:function(a){var b=this;a&&b.attachTo(a),b.root().bind("mousedown",$.proxy(b._eventHandler,b)),b.defaultOpt.$doc.bind("mouseup",$.proxy(b._eventHandler,b)),b.root().show(),b.trigger("aftershow")},hide:function(){var a=this;a.root().unbind("mousedown",$.proxy(a._eventHandler,a)),a.defaultOpt.$doc.unbind("mouseup",$.proxy(a._eventHandler,a)),a.root().hide(),a.trigger("afterhide")},attachTo:function(a){var b=this,c=a.offset(),d=b.root(),e=b.defaultOpt.$wrap,f=e.offset();b.data("$scaleTarget",a),b.root().css({position:"absolute",width:a.width(),height:a.height(),left:c.left-f.left-parseInt(e.css("border-left-width"))-parseInt(d.css("border-left-width")),top:c.top-f.top-parseInt(e.css("border-top-width"))-parseInt(d.css("border-top-width"))})},getScaleTarget:function(){return this.data("$scaleTarget")[0]}}),KM.ui.define("colorpicker",{tpl:function(a){for(var b="ffffff,000000,eeece1,1f497d,4f81bd,c0504d,9bbb59,8064a2,4bacc6,f79646,f2f2f2,7f7f7f,ddd9c3,c6d9f0,dbe5f1,f2dcdb,ebf1dd,e5e0ec,dbeef3,fdeada,d8d8d8,595959,c4bd97,8db3e2,b8cce4,e5b9b7,d7e3bc,ccc1d9,b7dde8,fbd5b5,bfbfbf,3f3f3f,938953,548dd4,95b3d7,d99694,c3d69b,b2a2c7,92cddc,fac08f,a5a5a5,262626,494429,17365d,366092,953734,76923c,5f497a,31859b,e36c09,7f7f7f,0c0c0c,1d1b10,0f243e,244061,632423,4f6128,3f3151,205867,974806,c00000,ff0000,ffc000,ffff00,92d050,00b050,00b0f0,0070c0,002060,7030a0,".split(","),c='<div unselectable="on" onmousedown="return false" class="kmui-colorpicker<%if (name){%> kmui-colorpicker-<%=name%><%}%>" ><table unselectable="on" onmousedown="return false"><tr><td colspan="10">'+a.lang_themeColor+'</td> </tr><tr class="kmui-colorpicker-firstrow" >',d=0;d<b.length;d++)d&&d%10===0&&(c+="</tr>"+(60==d?'<tr><td colspan="10">'+a.lang_standardColor+"</td></tr>":"")+"<tr"+(60==d?' class="kmui-colorpicker-firstrow"':"")+">"),c+=70>d?'<td><a unselectable="on" onmousedown="return false" title="'+b[d]+'" class="kmui-colorpicker-colorcell" data-color="#'+b[d]+'" style="background-color:#'+b[d]+";border:solid #ccc;"+(10>d||d>=60?"border-width:1px;":d>=10&&20>d?"border-width:1px 1px 0 1px;":"border-width:0 1px 0 1px;")+'"></a></td>':"";return c+="</tr></table></div>"},init:function(a){var b=this;b.root($($.parseTmpl(b.supper.mergeTpl(b.tpl(a)),a))),b.root().on("click",function(a){b.trigger("pickcolor",$(a.target).data("color"))})}},"popup"),function(){var a="combobox",b="kmui-combobox-item",c="kmui-combobox-item-hover",d="kmui-combobox-checked-icon",e="kmui-combobox-item-label";KM.ui.define(a,function(){return{tpl:'<ul class="dropdown-menu kmui-combobox-menu<%if (comboboxName!==\'\') {%> kmui-combobox-<%=comboboxName%><%}%>" unselectable="on" onmousedown="return false" role="menu" aria-labelledby="dropdownMenu"><%if(autoRecord) {%><%for( var i=0, len = recordStack.length; i<len; i++ ) {%><%var index = recordStack[i];%><li class="<%=itemClassName%><%if( selected == index ) {%> kmui-combobox-checked<%}%><%if( disabled[ index ] === true ) {%> kmui-combobox-item-disabled<%}%>" data-item-index="<%=index%>" unselectable="on" onmousedown="return false"><span class="kmui-combobox-icon" unselectable="on" onmousedown="return false"></span><label class="<%=labelClassName%>" style="<%=itemStyles[ index ]%>" unselectable="on" onmousedown="return false"><%=items[index]%></label></li><%}%><%if( i ) {%><li class="kmui-combobox-item-separator"></li><%}%><%}%><%for( var i=0, label; label = items[i]; i++ ) {%><li class="<%=itemClassName%><%if( selected == i && enabledSelected ) {%> kmui-combobox-checked<%}%> kmui-combobox-item-<%=i%><%if( disabled[ i ] === true ) {%> kmui-combobox-item-disabled<%}%>" data-item-index="<%=i%>" unselectable="on" onmousedown="return false"><span class="kmui-combobox-icon" unselectable="on" onmousedown="return false"></span><label class="<%=labelClassName%>" style="<%=itemStyles[ i ]%>" unselectable="on" onmousedown="return false"><%=label%></label></li><%}%></ul>',defaultOpt:{recordStack:[],items:[],value:[],comboboxName:"",selected:"",disabled:{},autoRecord:!0,recordCount:5,enabledRecord:!0,enabledSelected:!0},init:function(a){var c=this;$.extend(c._optionAdaptation(a),c._createItemMapping(a.recordStack,a.items),{itemClassName:b,iconClass:d,labelClassName:e}),this._transStack(a),c.root($($.parseTmpl(c.tpl,a))),this.data("options",a).initEvent()},initEvent:function(){var a=this;a.initSelectItem(),this.initItemActive()},setLabelWithDefaultValue:function(){var a=this.data("button");a.kmui().label(a.data("original-title"))},initSelectItem:function(){var a=this,c=a.data("options"),d="."+e;a.root().delegate("."+b,"click",function(){var b=$(this),e=b.attr("data-item-index");return c.disabled[e]?!1:(a.trigger("comboboxselect",{index:e,label:b.find(d).text(),value:a.data("options").value[e]}).select(e),a.hide(),a.trigger("aftercomboboxselect"),!1)})},initItemActive:function(){var a={mouseenter:"addClass",mouseleave:"removeClass"};$.IE6&&this.root().delegate("."+b,"mouseenter mouseleave",function(b){$(this)[a[b.type]](c)}).one("afterhide",function(){})},select:function(a){var b=this.data("options"),c=b.itemCount,d=b.autowidthitem;return d&&!d.length&&(d=b.items),b.disabled[a]?null:0==c?null:(0>a?a=c+a%c:a>=c&&(a=c-1),this.trigger("changebefore",d[a]),this._update(a),this.trigger("changeafter",d[a]),null)},selectItemByLabel:function(a){var b=this.data("options").itemMapping,c=this,d=null;!$.isArray(a)&&(a=[a]),$.each(a,function(a,e){return d=b[e],void 0!==d?(c.select(d),!1):void 0})},selectItemByValue:function(a){var b,c=this.data("options").value,d=this;for(b=0;b<c.length;b++)if(c[b]==a)return d.select(b);return!1},getItems:function(){return this.data("options").items},traverseItems:function(a){var b=this.data("options").value,c=this.data("options").items;return $.each(c,function(c,d){a(d,b[c])}),this},getItemMapping:function(){return this.data("options").itemMapping},disableItemByIndex:function(a){var b=this.data("options");b.disabled[a]=!0,this._repaint()},disableItemByLabel:function(a){var b=this.data("options").itemMapping,c=b[a];return"number"==typeof c?this.disableItemByIndex(c):!1},enableItemByIndex:function(a){var b=this.data("options");delete b.disabled[a],this._repaint()},enableItemByLabel:function(a){var b=this.data("options").itemMapping,c=b[a];return"number"==typeof c?this.enableItemByIndex(c):!1},_transStack:function(a){var b=[],c=-1,d=-1;$.each(a.recordStack,function(e,f){c=a.itemMapping[f],$.isNumeric(c)&&(b.push(c),f==a.selected&&(d=c))}),a.recordStack=b,a.selected=d,b=null},_optionAdaptation:function(a){if(!("itemStyles"in a)){a.itemStyles=[];for(var b=0,c=a.items.length;c>b;b++)a.itemStyles.push("")}return a.autowidthitem=a.autowidthitem||a.items,a.itemCount=a.items.length,a},_createItemMapping:function(a,b){var c={},d={recordStack:[],mapping:{}};return $.each(b,function(a,b){c[b]=a}),d.itemMapping=c,$.each(a,function(a,b){void 0!==c[b]&&(d.recordStack.push(c[b]),d.mapping[b]=c[b])}),d},_update:function(a){var b=this.data("options"),c=[];this.data("options").enabledRecord&&($.each(b.recordStack,function(b,d){d!=a&&c.push(d)}),c.unshift(a),c.length>b.recordCount&&(c.length=b.recordCount),b.recordStack=c),b.selected=a,this._repaint(),c=null},_repaint:function(){var a=$($.parseTmpl(this.tpl,this.data("options")));this.root().html(a.html()),a=null}}}(),"menu")}(),function(){var a="buttoncombobox";KM.ui.define(a,function(){return{defaultOpt:{label:"",title:""},init:function(a){var b=this,c=$.kmuibutton({caret:!0,name:a.comboboxName,title:a.title,text:a.label,click:function(){b.show(this.root())}});b.supper.init.call(b,a),b.on("changebefore",function(a,b){c.kmuibutton("label",b)}),b.data("button",c),b.attachTo(c)},button:function(){return this.data("button")}}}(),"combobox")}(),KM.ui.define("modal",{tpl:'<div class="kmui-modal" tabindex="-1" ><div class="kmui-modal-header"><div class="kmui-close" data-hide="modal"></div><h3 class="kmui-title"><%=title%></h3></div><div class="kmui-modal-body"  style="<%if(width){%>width:<%=width%>px;<%}%><%if(height){%>height:<%=height%>px;<%}%>"> </div><% if(cancellabel || oklabel) {%><div class="kmui-modal-footer"><div class="kmui-modal-tip"></div><%if(oklabel){%><div class="kmui-btn kmui-btn-primary" data-ok="modal"><%=oklabel%></div><%}%><%if(cancellabel){%><div class="kmui-btn" data-hide="modal"><%=cancellabel%></div><%}%></div><%}%></div>',defaultOpt:{title:"",cancellabel:"",oklabel:"",width:"",height:"",backdrop:!0,keyboard:!0},init:function(a){var b=this;
b.root($($.parseTmpl(b.tpl,a||{}))),b.data("options",a),a.okFn&&b.on("ok",$.proxy(a.okFn,b)),a.cancelFn&&b.on("beforehide",$.proxy(a.cancelFn,b)),b.root().delegate('[data-hide="modal"]',"click",$.proxy(b.hide,b)).delegate('[data-ok="modal"]',"click",$.proxy(b.ok,b)),$('[data-hide="modal"],[data-ok="modal"]',b.root()).hover(function(){$(this).toggleClass("kmui-hover")}),setTimeout(function(){$(".kmui-modal").draggable({handle:".kmui-modal-header"})},100)},toggle:function(){var a=this;return a[a.data("isShown")?"hide":"show"]()},show:function(){var a=this;a.trigger("beforeshow"),a.data("isShown")||(a.data("isShown",!0),a.escape(),a.backdrop(function(){a.autoCenter(),a.root().show().focus().trigger("aftershow")}),$(".kmui-modal").draggable({handle:".kmui-modal-header"}))},showTip:function(a){$(".kmui-modal-tip",this.root()).html(a).fadeIn()},hideTip:function(){$(".kmui-modal-tip",this.root()).fadeOut(function(){$(this).html("")})},autoCenter:function(){!$.IE6&&this.root().css("margin-left",-(this.root().width()/2))},hide:function(){var a=this;a.trigger("beforehide"),a.data("isShown")&&(a.data("isShown",!1),a.escape(),a.hideModal())},escape:function(){var a=this;a.data("isShown")&&a.data("options").keyboard?a.root().on("keyup",function(b){27==b.which&&a.hide()}):a.data("isShown")||a.root().off("keyup")},hideModal:function(){var a=this;a.root().hide(),a.backdrop(function(){a.removeBackdrop(),a.trigger("afterhide")})},removeBackdrop:function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},backdrop:function(a){var b=this;b.data("isShown")&&b.data("options").backdrop&&(b.$backdrop=$('<div class="kmui-modal-backdrop" />').click("static"==b.data("options").backdrop?$.proxy(b.root()[0].focus,b.root()[0]):$.proxy(b.hide,b))),b.trigger("afterbackdrop"),a&&a()},attachTo:function(a){var b=this;a.data("$mergeObj")||(a.data("$mergeObj",b.root()),a.on("wrapclick",function(){b.toggle(a)}),b.data("$mergeObj",a))},ok:function(){var a=this;a.trigger("beforeok"),a.trigger("ok",a)!==!1&&a.hide()},getBodyContainer:function(){return this.root().find(".kmui-modal-body")}}),KM.ui.define("tooltip",{tpl:'<div class="kmui-tooltip" unselectable="on" onmousedown="return false"><div class="kmui-tooltip-arrow" unselectable="on" onmousedown="return false"></div><div class="kmui-tooltip-inner" unselectable="on" onmousedown="return false"></div></div>',init:function(a){var b=this;b.root($($.parseTmpl(b.tpl,a||{})))},content:function(a){var b=this,c=$(a.currentTarget).attr("data-original-title");b.root().find(".kmui-tooltip-inner").text(c)},position:function(a){var b=this,c=$(a.currentTarget);b.root().css($.extend({display:"block"},c?{top:c.outerHeight(),left:(c.outerWidth()-b.root().outerWidth())/2}:{}))},show:function(a){if(!$(a.currentTarget).hasClass("kmui-disabled")){var b=this;b.content(a),b.root().appendTo($(a.currentTarget)),b.position(a),b.root().css("display","block")}},hide:function(){var a=this;a.root().css("display","none")},attachTo:function(a){function b(a){var b=this;$.contains(document.body,b.root()[0])||b.root().appendTo(a),b.data("tooltip",b.root()),a.each(function(){$(this).attr("data-original-title")&&$(this).on("mouseenter",$.proxy(b.show,b)).on("mouseleave click",$.proxy(b.hide,b))})}var c=this;"undefined"===$.type(a)?$("[data-original-title]").each(function(a,d){b.call(c,$(d))}):a.data("tooltip")||b.call(c,a)}}),KM.ui.define("tab",{init:function(a){var b=this,c=a.selector;$.type(c)&&(b.root($(c,a.context)),b.data("context",a.context),$(c,b.data("context")).on("click",function(a){b.show(a)}))},show:function(a){var b,c,d,a,e=this,f=$(a.target),g=f.closest("ul");b=f.attr("data-context"),b=b&&b.replace(/.*(?=#[^\s]*$)/,"");var h=f.parent("li");h.length&&!h.hasClass("kmui-active")&&(c=g.find(".kmui-active:last a")[0],a=$.Event("beforeshow",{target:f[0],relatedTarget:c}),e.trigger(a),a.isDefaultPrevented()||(d=$(b,e.data("context")),e.activate(f.parent("li"),g),e.activate(d,d.parent(),function(){e.trigger({type:"aftershow",relatedTarget:c})})))},activate:function(a,b,c){if(void 0===a)return $(".kmui-tab-item.kmui-active",this.root()).index();var d=b.find("> .kmui-active");d.removeClass("kmui-active"),a.addClass("kmui-active"),c&&c()}}),KM.ui.define("separator",{tpl:'<div class="kmui-separator" unselectable="on" onmousedown="return false" ></div>',init:function(a){var b=this;return b.root($($.parseTmpl(b.tpl,a))),b}}),$.wordCountAdaptive=function(a,b){var c=$("<span>").html(a).css({display:"inline",position:"absolute",top:-1e7,left:-1e5}).appendTo(document.body),d=c.width();return c.remove(),c=null,50>d?a:(a=a.slice(0,b?-4:-1),a.length?$.wordCountAdaptive(a+"...",!0):"...")},f.extend(e,function(){var a={},b={},c=null,d={},e={};return{registerUI:function(b,c){f.each(b.split(/\s+/),function(b,d){a[d]=c})},registerToolbarUI:function(a,c){f.each(a.split(/\s+/),function(a,d){b[d]=c})},loadUI:function(b){f.each(a,function(a,c){c.call(b)})},_createUI:function(a){var b=$('<div class="kmui-container"></div>'),c=$.kmuitoolbar(),d=$('<div class="kmui-editor-body"></div>'),e=$('<div class="kmui-statusbar"></div>');return b.append(c).append(d).append(e),$(f.isString(a)?"#"+a:a).append(b),{$container:b,$toolbar:c,$body:d,$statusbar:e}},_createToolbar:function(a,c){var d=c.getOptions("toolbars");if(d&&d.length){var e=[];$.each(d,function(d,f){$.each(f.split(/\s+/),function(a,d){if("|"==d)$.kmuiseparator&&e.push($.kmuiseparator());else if(b[d]){var f=b[d].call(c,d);f&&e.push(f)}}),e.length&&a.kmui().appendToBtnmenu(e)}),a.append($('<div class="kmui-dialog-container"></div>'))}else a.hide()},_createStatusbar:function(){},getKityMinder:function(a,b){var c=this._createUI(a),d=this.getMinder(c.$body.get(0),b);return this._createToolbar(c.$toolbar,d),this._createStatusbar(c.$statusbar,d),d.$container=c.$container,this.loadUI(d),d.fire("interactchange")},registerWidget:function(a,b,c){d[a]=$.extend2(b,{$root:"",_preventDefault:!1,root:function(a){return this.$root||(this.$root=a)},preventDefault:function(){this._preventDefault=!0},clear:!1}),c&&(e[a]=c)},getWidgetData:function(a){return d[a]},setWidgetBody:function(a,b,c){c._widgetData||f.extend(c,{_widgetData:{},getWidgetData:function(a){return this._widgetData[a]},getWidgetCallback:function(a){var c=this;return function(){return e[a].apply(c,[c,b].concat(f.argsToArray(arguments,0)))}}});var g=d[a];return g?(g=c._widgetData[a],g||(g=d[a],g=c._widgetData[a]="function"==$.type(g)?g:f.clone(g)),g.root(b.kmui().getBodyContainer()),c.fire("selectionclear"),g.initContent(c,b),b.on("keydown keyup keypress",function(a){a.stopPropagation()}),g._preventDefault||g.initEvent(c,b),void(g.width&&b.width(g.width))):null},setActiveWidget:function(a){c=a}}}()),KM.registerToolbarUI("bold italic redo undo unhyperlink removeimage expandnode collapsenode hand zoom-in zoom-out",function(a){var b=this,c=$.kmuibutton({icon:a,click:function(){b.execCommand(a)},title:this.getLang("tooltips")[a]||""});return this.on("interactchange",function(){var b=this.queryCommandState(a);c.kmui().disabled(-1==b).active(1==b)}),c}),KM.registerToolbarUI("fontfamily fontsize",function(a){function b(a){for(var b=null,c=[],d=0,e=a.items.length;e>d;d++)b=a.items[d].val,c.push(b.split(/\s*,\s*/)[0]),a.itemStyles.push("font-family: "+b),a.value.push(b),a.autowidthitem.push($.wordCountAdaptive(c[d]));return a.items=c,a}function c(a){var b=null,c=[];a.itemStyles=[],a.value=[];for(var d=0,e=a.items.length;e>d;d++)b=a.items[d],c.push(b),a.itemStyles.push("font-size: "+b+"px; height:"+(b+2)+"px; line-height: "+(b+2)+"px");return a.value=a.items,a.items=c,a.autoRecord=!1,a}var d=this,e=d.getLang("tooltips."+a),f={label:e,title:e,comboboxName:a,items:d.getOptions(a)||[],itemStyles:[],value:[],autowidthitem:[]},g=null,h=null;if(0==f.items.length)return null;switch(a){case"fontfamily":f=b(f);break;case"fontsize":f=c(f)}return g=$.kmuibuttoncombobox(f).css("zIndex",d.getOptions("zIndex")+1),h=g.kmui(),h.on("comboboxselect",function(b,c){d.execCommand(a,c.value)}).on("beforeshow",function(){0===g.parent().length&&g.appendTo(d.$container.find(".kmui-dialog-container"))}),this.on("interactchange",function(){var b=this.queryCommandState(a),c=this.queryCommandValue(a);h.button().kmui().disabled(-1==b).active(1==b),c&&(c=c.replace(/['"]/g,"").toLowerCase().split(/['|"]?\s*,\s*[\1]?/),h.selectItemByLabel(c))}),h.button().addClass("kmui-combobox")}),KM.registerToolbarUI("forecolor",function(c){function d(){return g.css("background-color")}var e=this,f=null,g=null,h=null;return this.on("interactchange",function(){var a=this.queryCommandState(c);h.kmui().disabled(-1==a).active(1==a)}),h=$.kmuicolorsplitbutton({icon:c,caret:!0,name:c,title:this.getLang("tooltips")[c]||"",click:function(){var b=a.Color.parse(d()).toHEX();"#000000"!=b&&e.execCommand(c,b)}}),g=h.kmui().colorLabel(),f=$.kmuicolorpicker({name:c,lang_clearColor:e.getLang("popupcolor").clearColor||"",lang_themeColor:e.getLang("popupcolor").themeColor||"",lang_standardColor:e.getLang("popupcolor").standardColor||""}).on("pickcolor",function(a,d){b.setTimeout(function(){g.css("backgroundColor",d),e.execCommand(c,d)},0)}).on("show",function(){KM.setActiveWidget(f.kmui().root())}).css("zIndex",e.getOptions("zIndex")+1),h.kmui().on("arrowclick",function(){f.parent().length||e.$container.find(".kmui-dialog-container").append(f),f.kmui().show(h,{caretDir:"down",offsetTop:-5,offsetLeft:8,caretLeft:11,caretTop:-8})}).register("click",h,function(){f.kmui().hide()}),h}),function(){function b(a,b,c){{var d=a.split(",")[1],e=$("<form></form>").attr({action:"download.php",method:"POST","accept-charset":"utf-8"});$("<input />").attr({name:"content",type:"hidden",value:decodeURIComponent(d)}).appendTo(e),$("<input />").attr({name:"type",type:"hidden",value:c}).appendTo(e),$("<input />").attr({name:"filename",type:"hidden",value:b}).appendTo(e)}$('<input name="iehack" value="&#9760;" />').appendTo(e),e.appendTo("body").submit().remove()}function c(a,b){return"data:"+a+"; utf-8,"+encodeURIComponent(b)}function d(a,d){var f=a.exportData(d),g=e.findProtocal(d),h=a.getMinderTitle()+g.fileExtension,i=g.mineType||"text/plain";"string"==typeof f?b(c(i,f),h,"text"):f&&f.then&&f.then(function(a){b(a,h,"base64")})}a.extendClass(j,{exportFile:function(a){return d(this,a),this}}),KM.registerToolbarUI("saveto",function(a){var b=this,c=b.getLang("tooltips."+a),g={label:c,title:c,comboboxName:a,items:[],itemStyles:[],value:[],autowidthitem:[],enabledRecord:!1,enabledSelected:!1},h=null,i=null;return f.each(e.getAllRegisteredProtocals(),function(a){var b=e.findProtocal(a);if(b.encode){var c=b.fileDescription+""+b.fileExtension+"";g.value.push(a),g.items.push(c),g.autowidthitem.push($.wordCountAdaptive(c),!0)}}),h=$.kmuibuttoncombobox(g).css("zIndex",b.getOptions("zIndex")+1),i=h.kmui(),i.on("comboboxselect",function(a,c){d(b,c.value)}).on("beforeshow",function(){0===h.parent().length&&h.appendTo(b.$container.find(".kmui-dialog-container"))}).on("aftercomboboxselect",function(){this.setLabelWithDefaultValue()}),i.button().addClass("kmui-combobox")})}(),KM.registerUI("tooltips",function(){var a=this;$.kmuitooltip&&($("[data-original-title]",a.$container).each(function(b,c){var d=a.getLang("tooltips"),e=$(c).data("original-title");f.each(d,function(b,d){d==e&&a.getShortcutKey(b)&&$(c).attr("data-original-title",e+" ("+a.getShortcutKey(b).toUpperCase()+")")})}),$.kmuitooltip("attachTo",$("[data-original-title]",a.$container)).css("z-index",a.getOptions("zIndex")+1)),a.$container.find("a").click(function(a){a.preventDefault()})}),KM.registerToolbarUI("template theme",function(a){var b=f.keys("template"==a?KM.getTemplateList():KM.getThemeList()),c=this,d=c.getLang("tooltips."+a),e={label:d,title:d,comboboxName:a,items:b.map(function(b){return c.getLang(a)[b]}),itemStyles:[],value:b,autowidthitem:[],enabledRecord:!1},g=null;g=$.kmuibuttoncombobox(e).css("zIndex",c.getOptions("zIndex")+1);var h=g.kmui();h.on("comboboxselect",function(b,d){c.execCommand(a,d.value)}).on("beforeshow",function(){0===g.parent().length&&g.appendTo(c.$container.find(".kmui-dialog-container"))});var i,j;return c.on("interactchange",function(){var b=this.queryCommandState(a),c=this.queryCommandValue(a);i!=b&&h.button().kmui().disabled(-1==b).active(1==b),c&&c!=j&&h.selectItemByValue(c),i=b,j=c}),h.button().addClass("kmui-combobox")}),KM.registerToolbarUI("node",function(a){function b(a){var b=[];return f.each(a.items,function(d,f){a.value.push(f),b.push((e[d]||d)+" ("+c[f]+")"),a.autowidthitem.push($.wordCountAdaptive(b[b.length-1]))}),a.items=b,a}var c={appendsiblingnode:"Enter",appendchildnode:"Tab",removenode:"Del",editnode:"F2"},d=this,e=d.getLang("node"),g=d.getLang("tooltips."+a),h={label:g,title:g,comboboxName:a,items:{appendsiblingnode:"appendsiblingnode",appendchildnode:"appendchildnode",editnode:"editnode",removenode:"removenode"},itemStyles:[],value:[],autowidthitem:[],enabledRecord:!1,enabledSelected:!1},i=null;if(0===h.items.length)return null;i=$.kmuibuttoncombobox(b(h)).css("zIndex",d.getOptions("zIndex")+1);var j=i.kmui();return j.on("comboboxselect",function(a,b){d.execCommand(b.value,d.getLang().topic)}).on("beforeshow",function(){0===i.parent().length&&i.appendTo(d.$container.find(".kmui-dialog-container"));var a=i.kmui();a.traverseItems(function(b,c){-1==d.queryCommandState(c)?a.disableItemByLabel(b):a.enableItemByLabel(b)})}),d.on("interactchange",function(){var a=0;f.each(c,function(b){return a=d.queryCommandState(b),-1!=a?!1:void 0}),j.button().kmui().disabled(-1==a).active(1==a)}),j.button().addClass("kmui-combobox")}),KM.registerUI("contextmenu",function(){function a(a){var c;return f.each(b.getContextmenu(),function(b,d){return d.label==a?(c=d,!1):void 0}),c}var b=this,c=$.kmuidropmenu({click:function(c,d,e){var f=a(e);f.exec?f.exec.apply(km):b.execCommand(f.cmdName),this.hide()}});b.$container.append(c),b.on("contextmenu",function(a){a.preventDefault()}),b.on("mouseup",function(a){if("hand"!=b.getStatus()&&a.isRightMB()){var d=a.getTargetNode();d&&(this.removeAllSelectedNodes(),this.select(d));var e=b.getContextmenu(),g=[];if(f.each(e,function(a,c){return c.divider?void(g.length&&g.push(c)):void(-1!=b.queryCommandState(c.cmdName)&&g.push({label:c.label,value:c.cmdName}))}),g.length){var h=g[g.length-1];h.divider&&g.pop();var i=a.getPosition("screen"),j=$(b.getPaper().container).offset();i.y-=j.top,i.x-=j.left,c.kmui().setData({data:g}).position(i).show()}}}),b.on("afterclick",function(){c.kmui().hide()}),b.on("beforemousedown",function(a){a.isRightMB()})}),KM.registerToolbarUI("markers help preference resource",function(a){var b,c=this,d={title:this.getLang("tooltips")[a]||"",url:c.getOptions("KITYMINDER_HOME_URL")+"dialogs/"+a+"/"+a+".js"},e=$.kmuibutton({icon:a,title:this.getLang("tooltips")[a]||""});switch(f.loadFile(document,{src:d.url,tag:"script",type:"text/javascript",defer:"defer"},function(){b=$.kmuimodal(d),b.attr("id","kmui-dialog-"+a).addClass("kmui-dialog-"+a).find(".kmui-modal-body").addClass("kmui-dialog-"+a+"-body"),b.kmui().on("beforeshow",function(){var d=this.root();d.parent()[0]||c.$container.find(".kmui-dialog-container").append(d),KM.setWidgetBody(a,b,c)}).attachTo(e),"help"==a&&b.kmui().on("beforeshow",function(){e.kmui().active(!0),$(".kmui-editor-body").addClass("blur")}).on("beforehide",function(){e.kmui().active(!1),$(".kmui-editor-body").removeClass("blur")})}),c.on("interactchange",function(){var b=this.queryCommandState(a);e.kmui().disabled(-1==b).active(1==b)}),a){case"markers":c.addContextmenu([{label:c.getLang("marker.marker"),exec:function(){b.kmui().show()},cmdName:"markers"}]);break;case"resource":c.addContextmenu([{label:c.getLang("resource.resource"),exec:function(){b.kmui().show()},cmdName:"resource"}])}return e}),KM.registerToolbarUI("hyperlink",function(a){var b,c=this,d={title:this.getLang("tooltips")[a]||"",url:c.getOptions("KITYMINDER_HOME_URL")+"dialogs/"+a+"/"+a+".js"},e=$.kmuibutton({icon:a,title:this.getLang("tooltips")[a]||""});return f.loadFile(document,{src:d.url,tag:"script",type:"text/javascript",defer:"defer"},function(){b=$.kmuimodal(d),b.attr("id","kmui-dialog-"+a).addClass("kmui-dialog-"+a).find(".kmui-modal-body").addClass("kmui-dialog-"+a+"-body"),b.kmui().on("beforeshow",function(){var d=this.root();d.parent()[0]||c.$container.find(".kmui-dialog-container").append(d),KM.setWidgetBody(a,b,c)}).attachTo(e)}),c.addContextmenu([{label:c.getLang("hyperlink.hyperlink"),exec:function(){b.kmui().show()},cmdName:"hyperlink"},{label:c.getLang("hyperlink.unhyperlink"),exec:function(){this.execCommand("unhyperlink")},cmdName:"unhyperlink"}]),c.on("interactchange",function(){var b=this.queryCommandState(a);e.kmui().disabled(-1==b).active(1==b)}),e}),KM.registerToolbarUI("image",function(a){var b,c=this,d={title:this.getLang("tooltips")[a]||"",url:c.getOptions("KITYMINDER_HOME_URL")+"dialogs/"+a+"/"+a+".js"},e=$.kmuibutton({icon:a,title:this.getLang("tooltips")[a]||""});return f.loadFile(document,{src:d.url,tag:"script",type:"text/javascript",defer:"defer"},function(){b=$.kmuimodal(d),b.attr("id","kmui-dialog-"+a).addClass("kmui-dialog-"+a).find(".kmui-modal-body").addClass("kmui-dialog-"+a+"-body"),b.kmui().on("beforeshow",function(){var d=this.root();d.parent()[0]||c.$container.find(".kmui-dialog-container").append(d),KM.setWidgetBody(a,b,c)}).attachTo(e)}),c.addContextmenu([{label:c.getLang("image.image"),exec:function(){b.kmui().show()},cmdName:"image"},{label:c.getLang("image.removeimage"),exec:function(){this.execCommand("removeimage")},cmdName:"removeimage"}]),c.on("interactchange",function(){var b=this.queryCommandState(a);e.kmui().disabled(-1==b).active(1==b)}),e}),KM.registerToolbarUI("zoom",function(a){function b(a){var b=[];return f.each(a.items,function(c,d){a.value.push(d),b.push(d+"%"),a.autowidthitem.push($.wordCountAdaptive(b[b.length-1]))}),a.items=b,a}var c=this,d=c.getLang("tooltips."+a),e={label:d,title:d,comboboxName:a,items:c.getOptions(a)||[],itemStyles:[],value:c.getOptions(a),autowidthitem:[],enabledRecord:!1},g=null;if(0==e.items.length)return null;g=$.kmuibuttoncombobox(b(e)).css("zIndex",c.getOptions("zIndex")+1);var h=g.kmui();h.on("comboboxselect",function(a,b){c.execCommand("zoom",b.value)}).on("beforeshow",function(){0===g.parent().length&&g.appendTo(c.$container.find(".kmui-dialog-container"))});var i,j;return c.on("interactchange",function(){var b=this.queryCommandState(a),c=this.queryCommandValue(a);b!=i&&h.button().kmui().disabled(-1==b).active(1==b),c&&c!=j&&h.selectItemByLabel(c+"%"),i=b,j=c}),h.button().addClass("kmui-combobox")}),e.registerProtocal("xmind",function(){var a={"priority-1":["priority",1],"priority-2":["priority",2],"priority-3":["priority",3],"priority-4":["priority",4],"priority-5":["priority",5],"priority-6":["priority",6],"priority-7":["priority",7],"priority-8":["priority",8],"task-start":["progress",1],"task-oct":["progress",2],"task-quarter":["progress",3],"task-3oct":["progress",4],"task-half":["progress",5],"task-5oct":["progress",6],"task-3quar":["progress",7],"task-7oct":["progress",8],"task-done":["progress",9]};return{fileDescription:"xmind",fileExtension:".xmind",decode:function(b){function c(b,d){if(d.data={text:b.title},b.marker_refs&&b.marker_refs.marker_ref){var e=b.marker_refs.marker_ref;if(e.length&&e.length>0)for(var f in e){var g=a[e[f].marker_id];g&&(d.data[g[0]]=g[1])}else{var g=a[e.marker_id];g&&(d.data[g[0]]=g[1])}}b["xlink:href"]&&(d.data.hyperlink=b["xlink:href"]);var h=b.children&&b.children.topics,i=h&&(h.topic||h[0]&&h[0].topic);if(i){var j=i;if(j.length&&j.length>0){d.children=[];for(var f in j)d.children.push({}),c(j[f],d.children[f])}else d.children=[{}],c(j,d.children[0])}}function d(a){var b=$.xml2json(a),d={},e=b.sheet,g=f.isArray(e)?e[0].topic:e.topic;return c(g,d),d}function e(){h("ziperror")}function g(a,b){zip.createReader(new zip.BlobReader(a),function(a){a.getEntries(b)},e)}var h;return{then:function(a){return g(b,function(b){var c=!1;b.forEach(function(b){"content.xml"==b.filename&&(c=!0,b.getData(new zip.TextWriter,function(b){try{var c=d($.parseXML(b));a&&a(c)}catch(e){h&&h("parseerror")}}))}),!c&&h&&h("parseerror")}),this},error:function(a){h=a}}},recognizePriority:-1}}),e.registerProtocal("freemind",function(){function a(b,d){d.data={text:b.TEXT};var e;if(b.icon){var f,g=b.icon;if(g.length&&g.length>0)for(e in g)f=c[g[e].BUILTIN],f&&(d.data[f[0]]=f[1]);else f=c[g.BUILTIN],f&&(d.data[f[0]]=f[1])}if(b.LINK&&(d.data.hyperlink=b.LINK),b.node){var h=b.node;if(h.length&&h.length>0){d.children=[];for(e in h)d.children.push({}),a(h[e],d.children[e])}else d.children=[{}],a(h,d.children[0])}}function b(b){var c=$.xml2json(b),d={};return a(c.node,d),d}var c={"full-1":["priority",1],"full-2":["priority",2],"full-3":["priority",3],"full-4":["priority",4],"full-5":["priority",5],"full-6":["priority",6],"full-7":["priority",7],"full-8":["priority",8]};return{fileDescription:"freemind",fileExtension:".mm",decode:function(a){return b(a)},recognizePriority:-1}}),e.registerProtocal("mindmanager",function(){function a(b,c){if(c.data={text:b.Text&&b.Text.PlainText||""},b.Task){var d;b.Task.TaskPriority&&(d=g[b.Task.TaskPriority],d&&(c.data[d[0]]=d[1])),b.Task.TaskPercentage&&(d=g[b.Task.TaskPercentage],d&&(c.data[d[0]]=d[1]))}if(b.Hyperlink&&(c.data.hyperlink=b.Hyperlink.Url),b.SubTopics&&b.SubTopics.Topic){var e=b.SubTopics.Topic;if(e.length&&e.length>0){c.children=[];for(var f in e)c.children.push({}),a(e[f],c.children[f])}else c.children=[{}],a(e,c.children[0])}}function b(b){var c=$.xml2json(b),d={};return a(c.OneTopic.Topic,d),d}function c(){f("ziperror")}function d(a,b){zip.createReader(new zip.BlobReader(a),function(a){a.getEntries(b)},c)}var e,f,g={"urn:mindjet:Prio1":["PriorityIcon",1],"urn:mindjet:Prio2":["PriorityIcon",2],"urn:mindjet:Prio3":["PriorityIcon",3],"urn:mindjet:Prio4":["PriorityIcon",4],"urn:mindjet:Prio5":["PriorityIcon",5],0:["ProgressIcon",1],25:["ProgressIcon",2],50:["ProgressIcon",3],75:["ProgressIcon",4],100:["ProgressIcon",5]};return{fileDescription:"mindmanager",fileExtension:".mmap",decode:function(a){return{then:function(c){return e=c,d(a,function(a){var c=!1;a.forEach(function(a){"Document.xml"==a.filename&&(c=!0,a.getData(new zip.TextWriter,function(a){try{var c=b($.parseXML(a));e&&e(c)}catch(d){f&&f("parseerror")}}))}),!c&&f&&f("parseerror")}),this},error:function(a){f=a}}},recognizePriority:-1}}),e.registerProtocal("plain",function(){function a(a,b){for(var c="";b--;)c+=a;return c}function b(c,d){var e="";return d=d||0,e+=a(l,d),e+=c.data.text+j,c.children&&c.children.forEach(function(a){e+=b(a,d+1)}),e}function c(a){return!/\S/.test(a)}function d(a){for(var b=0;a.charAt(b)===l;)b++;return b}function e(a){return{data:{text:a.replace(new RegExp("^"+l+"*"),"")}}}function f(a){function b(a,b){var c=a.children||(a.children=[]);c.push(b)}for(var f,g,h,i,j={},l=a.split(k),m=0;m<l.length;m++)if(g=l[m],!c(g)){if(h=d(g),i=e(g),0===h){if(f)throw new Error("Invalid local format");f=i}else{if(!j[h-1])throw new Error("Invalid local format");b(j[h-1],i)}j[h]=i}return f}function g(a){if(!Utils.isString(a))return!1;h=a;try{i=f(a)}catch(b){i=null}return!!i}var h,i,j="\r",k=/\r\n|\r|\n/,l="	";return{fileDescription:"",fileExtension:".txt",mineType:"text/plain",encode:function(a){return b(a,0)},decode:function(a){return h==a&&i?i:f(a)},recognize:g,recognizePriority:-1}}),e.registerProtocal("json",function(){function a(a,b){return"layout"==a||"shicon"==a?void 0:b}return{fileDescription:"KityMinder",fileExtension:".km",mineType:"application/json",encode:function(b){return JSON.stringify(b,a)},decode:function(a){return JSON.parse(a)},recognize:function(a){return Utils.isString(a)&&"{"==a.charAt(0)&&"}"==a.charAt(a.length-1)},recognizePriority:0}}),a.Browser.ie||e.registerProtocal("png",function(){function c(a,b){var c=document.createElement("img");c.onload=b,c.src=a}return{fileDescription:"PNG ",fileExtension:".png",encode:function(d,e){function f(a,b){a.save(),a.fillStyle=b,a.fillRect(0,0,z.width,z.height),a.restore()}function g(a,b,c,d){a.drawImage(b,c,d)}function h(a){var b=a.toDataURL("png");return b}function i(){c(n,function(){var a,b=this;g(A,b,y,y),m.revokeObjectURL(n),a=h(z),o&&o(a)})}var j,k,l,m,n,o,p=(e._zoomValue,e.getPaper()),q=p.shapeNode.getAttribute("transform"),r=(p.container,e.getStyle("background").toString()),s=/url\((.+)\)/.exec(r),t=a.Color.parse(r),u=e.getRenderContainer(),v=u.getRenderBox(),w=v.width+1,x=v.height+1,y=20,z=document.createElement("canvas"),A=z.getContext("2d");return p.shapeNode.setAttribute("transform","translate(0.5, 0.5)"),u.translate(-v.x,-v.y),j=p.container.innerHTML,u.translate(v.x,v.y),p.shapeNode.setAttribute("transform",q),k=$(j).filter("svg"),k.attr({width:v.width+1,height:v.height+1,style:'font-family: Arial, "Microsoft Yahei","Heiti SC";'}),j=$("<div></div>").append(k).html(),j=j.replace(/&nbsp;/g,"&#xa0;"),l=new Blob([j],{type:"image/svg+xml;charset=utf-8"}),m=b.URL||b.webkitURL||b,n=m.createObjectURL(l),z.width=w+2*y,z.height=x+2*y,s?c(s[1],function(){f(A,A.createPattern(this,"repeat")),i()}):(f(A,t.toString()),i()),{then:function(a){o=a}}},recognizePriority:-1}}),a.Browser.ie||e.registerProtocal("svg",function(){return{fileDescription:"SVG ",fileExtension:".svg",mineType:"image/svg+xml",encode:function(a,b){var c,d,e=b.getPaper(),f=e.shapeNode.getAttribute("transform"),g=b.getRenderContainer(),h=g.getRenderBox(),i=(g.getTransform(),h.width),j=h.height,k=20;return e.shapeNode.setAttribute("transform","translate(0.5, 0.5)"),c=b.getPaper().container.innerHTML,e.shapeNode.setAttribute("transform",f),d=$(c).filter("svg"),d.attr({width:i+2*k|0,height:j+2*k|0,style:'font-family: Arial, "Microsoft Yahei",  "Heiti SC"; background: '+b.getStyle("background")}),d[0].setAttribute("viewBox",[h.x-k|0,h.y-k|0,i+2*k|0,j+2*k|0].join(" ")),c=$("<div></div>").append(d).html(),c=$("<div></div>").append(d).html(),c=c.replace(/&nbsp;/g,"&#xa0;")},recognizePriority:-1}})}(kity,window);