/*!
 * ====================================================
 * kityminder - v1.0.0 - 2014-03-25
 * https://github.com/fex-team/kityminder
 * GitHub: https://github.com/fex-team/kityminder.git 
 * Copyright (c) 2014 f-cube @ FEX; Licensed MIT
 * ====================================================
 */

!function(a,b){function c(a){var b={};b.data=a.getData();var d=a.getChildren();if(d.length){b.children=[];for(var e=0;e<d.length;e++)b.children.push(c(d[e]))}return b}function d(a,b,c){var e=b.data;for(var f in e)a.setData(f,e[f]);a.setText(e.text||c.getLang(l[e.type]));var g=b.children;if(g){for(var h=0;h<g.length;h++){var j=new i;d(j,g[h],c),a.appendChild(j)}return a}}function e(a){return a.getRenderContainer().getRenderBox("top")}var f=b.KM=b.KityMinder=function(){var a={},b=0;return{version:"1.1.1",createMinder:function(a,b){b=b||{},b.renderTo=Utils.isString(a)?document.getElementById(a):a;var c=new k(b);return this.addMinder(b.renderTo,c),c},addMinder:function(c,d){var e;e="string"==typeof c?c:c.id||"KM_INSTANCE_"+b++,a[e]=d},getMinder:function(c,d){var e;return e="string"==typeof c?c:c.id||"KM_INSTANCE_"+b++,a[e]||this.createMinder(c,d)},LANG:{}}}(),g=Utils=f.Utils={extend:a.Utils.extend.bind(a.Utils),listen:function(a,c,d){var e=g.isArray(c)?c:g.trim(c).split(/\s+/),f=e.length;if(f)for(;f--;)if(c=e[f],a.addEventListener)a.addEventListener(c,d,!1);else{d._d||(d._d={els:[]});var h=c+d.toString(),i=g.indexOf(d._d.els,a);d._d[h]&&-1!=i||(-1==i&&d._d.els.push(a),d._d[h]||(d._d[h]=function(a){return d.call(a.srcElement,a||b.event)}),a.attachEvent("on"+c,d._d[h]))}a=null},trim:function(a){return a.replace(/(^[ \t\n\r]+)|([ \t\n\r]+$)/g,"")},each:function(a,b,c){if(null!=a)if(a.length===+a.length){for(var d=0,e=a.length;e>d;d++)if(b.call(c,d,a[d],a)===!1)return!1}else for(var f in a)if(a.hasOwnProperty(f)&&b.call(c,f,a[f],a)===!1)return!1},addCssRule:function(a,b,c){var d;return void 0===b||b&&b.nodeType&&9==b.nodeType?(c=b&&b.nodeType&&9==b.nodeType?b:c||document,d=c.getElementById(a),d?d.innerHTML:void 0):(c=c||document,d=c.getElementById(a),""===b?d?(d.parentNode.removeChild(d),!0):!1:void(d?d.innerHTML=b:(d=c.createElement("style"),d.id=a,d.innerHTML=b,c.getElementsByTagName("head")[0].appendChild(d))))},keys:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},proxy:function(a,b){return function(){return a.apply(b,arguments)}},indexOf:function(a,b,c){var d=-1;return c=this.isNumber(c)?c:0,this.each(a,function(a,e){return e>=c&&a===b?(d=e,!1):void 0}),d},argsToArray:function(a,b){return Array.prototype.slice.call(a,b||0)},clonePlainObject:function(a,b){var c;b=b||{};for(var d in a)a.hasOwnProperty(d)&&(c=a[d],g.isObject(c)||g.isArray(c)?(b[d]=g.isArray(c)?[]:{},g.clonePlainObject(a[d],b[d])):b[d]=c);return b},compareObject:function(a,b){var c;if(this.isEmptyObject(a)!==this.isEmptyObject(b))return!1;if(this.getObjectLength(a)!=this.getObjectLength(b))return!1;for(var d in a)if(a.hasOwnProperty(d)){if(c=a[d],void 0===b[d])return!1;if(this.isObject(c)||this.isArray(c)){if(this.isObject(b[d])!==this.isObject(c))return!1;if(this.isArray(c)!==this.isArray(b[d]))return!1;if(this.compareObject(c,b[d])===!1)return!1}else if(c!=b[d])return!1}return!0},getObjectLength:function(a){if(this.isArray(a)||this.isString(a))return a.length;var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b},isEmptyObject:function(a){if(null==a)return!0;if(this.isArray(a)||this.isString(a))return 0===a.length;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},getNodeCommonAncestor:function(a,b){if(a===b)return a.parent;if(a.contains(b))return this;if(b.contains(a))return b;for(var c=a.parent;!c.contains(b);)c=c.parent;return c},loadFile:function(){function a(a,c){try{for(var d,e=0;d=b[e++];)if(d.doc===a&&d.url==(c.src||c.href))return d}catch(f){return null}}var b=[];return function(c,d,e){var f=a(c,d);if(f)return void(f.ready?e&&e():f.funs.push(e));if(b.push({doc:c,url:d.src||d.href,funs:[e]}),!c.body){var g=[];for(var h in d)"tag"!=h&&g.push(h+'="'+d[h]+'"');return void c.write("<"+d.tag+" "+g.join(" ")+" ></"+d.tag+">")}if(!d.id||!c.getElementById(d.id)){var i=c.createElement(d.tag);delete d.tag;for(var h in d)i.setAttribute(h,d[h]);i.onload=i.onreadystatechange=function(){if(!this.readyState||/loaded|complete/.test(this.readyState)){if(f=a(c,d),f.funs.length>0){f.ready=1;for(var b;b=f.funs.pop();)b()}i.onload=i.onreadystatechange=null}},i.onerror=function(){throw Error("The load "+(d.href||d.src)+" fails,check the url settings of file umeditor.config.js ")},c.getElementsByTagName("head")[0].appendChild(i)}}}(),clone:function(a,b){var c;b=b||{};for(var d in a)a.hasOwnProperty(d)&&(c=a[d],"object"==typeof c?(b[d]=g.isArray(c)?[]:{},g.clone(a[d],b[d])):b[d]=c);return b}};Utils.each(["String","Function","Array","Number","RegExp","Object"],function(a,b){f.Utils["is"+b]=function(a){return Object.prototype.toString.apply(a)=="[object "+b+"]"}});var h=a.createClass("Command",{constructor:function(){this._isContentChange=!0,this._isSelectionChange=!1},execute:function(){},setContentChanged:function(a){this._isContentChange=!!a},isContentChanged:function(){return this._isContentChange},setSelectionChanged:function(a){this._isSelectionChange=!!a},isSelectionChanged:function(){return this._isContentChange},queryState:function(){return 0},queryValue:function(){return 0},isNeedUndo:function(){return!0}}),i=f.MinderNode=a.createClass("MinderNode",{constructor:function(a){this.parent=null,this.children=[],this.data={},this.tmpData={},Utils.isString(a)?this.setData("text",a):this.setData(a),this._createShapeDom(),this.setData("layout",{})},_createShapeDom:function(){this.rc=new a.Group,this.rc.addClass("km-minderNode"),this.rc.minderNode=this,this._createBgGroup(),this._createContGroup(),this._createIconShape(),this._createTextShape()},_createGroup:function(b){var c=new a.Group;c.setData("rctype",b),this.rc.appendShape(c)},_createBgGroup:function(){this._createGroup("bgrc")},_createContGroup:function(){this._createGroup("contrc")},_createTextShape:function(){var b=new a.Text(this.getData("text")||"");b.setAttr("_nodeTextShape",!0),this.getContRc().appendShape(b)},_createIconShape:function(){var b=new a.Group;this.getContRc().appendShape(b),this._iconRc=b},getContRc:function(){var a,b=this.rc.getShapesByType("group");return Utils.each(b,function(b,c){return"contrc"==c.getData("rctype")?(a=c,!1):void 0}),a},getBgRc:function(){var a,b=this.rc.getShapesByType("group");return Utils.each(b,function(b,c){return"bgrc"==c.getData("rctype")?(a=c,!1):void 0}),a},getIconRc:function(){return this._iconRc},setPoint:function(a,b){arguments.length<2?this.setData("point",a):this.setData("point",{x:a,y:b})},getPoint:function(){return this.getData("point")},setType:function(a){this.setData("type",a)},getLevel:function(){for(var a=0,b=this.parent;b;)a++,b=b.parent;return a},getType:function(){var a=this.getData("type");if(a)return a;var b=Math.min(this.getLevel(),2);return a=["root","main","sub"][b],this.setData("type",a),a},setText:function(a){this.setData("text",a),this.getTextShape().setContent(a)},getText:function(){return this.getData("text")},isRoot:function(){return null===this.getParent()?!0:!1},getParent:function(){return this.parent},getDepth:function(){for(var a=0,b=this.parent;b;)b=b.parent,a++;return a},getRoot:function(){for(var a=this;a.parent;)a=a.parent;return a},isAncestorOf:function(a){for(var b=a.parent;b;){if(b==this)return!0;b=b.parent}return!1},preTraverse:function(a){var b=this.getChildren();a(this);for(var c=0;c<b.length;c++)b[c].preTraverse(a)},postTraverse:function(a){for(var b=this.getChildren(),c=0;c<b.length;c++)b[c].postTraverse(a);a(this)},traverse:function(a){return this.postTraverse(a)},getChildren:function(){return this.children},getIndex:function(){return this.parent?this.parent.children.indexOf(this):-1},insertChild:function(a,b){void 0===b&&(b=this.children.length),a.parent&&a.parent.removeChild(a),a.parent=this,a.root=a.parent.root,this.children.splice(b,0,a)},appendChild:function(a){return this.insertChild(a)},prependChild:function(a){return this.insertChild(a,0)},removeChild:function(a){var b,c=a;a instanceof i&&(c=this.children.indexOf(a)),c>=0&&(b=this.children.splice(c,1)[0],b.parent=null)},getChild:function(a){return this.children[a]},getFirstChild:function(){return this.children[0]},getLastChild:function(){return this.children[this.children.length-1]},getData:function(a){return void 0===a?this.data:this.data[a]},setData:function(a,b){void 0===a?this.data={}:g.isObject(a)?Utils.extend(this.data,a):void 0===b?(this.data[a]=null,delete this.data[a]):this.data[a]=b},getRenderContainer:function(){return this.rc},getCommonAncestor:function(a){return Utils.getNodeCommonAncestor(this,a)},contains:function(a){if(this===a)return!0;if(this===a.parent)return!0;var b=!1;return Utils.each(this.getChildren(),function(c,d){return b=d.contains(a),b===!0?!1:void 0}),b},clone:function(){function a(b,c){var d=new KM.MinderNode(c.getText());d.data=Utils.clonePlainObject(c.getData()),d.tmpData=Utils.clonePlainObject(c.getTmpData()),d.parent=b,b&&b.children.push(d);for(var e,f=0;e=c.children[f++];)a(d,e);return d}return function(){return a(null,this)}}(),equals:function(a){if(a.children.length!=this.children.length)return!1;if(g.compareObject(a.getData(),this.getData())===!1)return!1;if(g.compareObject(a.getTmpData(),this.getTmpData())===!1)return!1;for(var b,c=0;b=this.children[c];c++)if(b.equals(a.children[c])===!1)return!1;return!0},getTextShape:function(){var a;return g.each(this.getContRc().getShapesByType("text"),function(b,c){return c.getAttr("_nodeTextShape")?(a=c,!1):void 0}),a},isSelected:function(){return this.getTmpData("highlight")===!0},clearChildren:function(){this.children=[]},isHighlight:function(){return this.getTmpData("highlight")},setTmpData:function(a,b){var c=this;g.isObject(a)&&g.each(a,function(a,b){c.setTmpData(b,a)}),void 0===b||null===b||""===b?delete this.tmpData[a]:this.tmpData[a]=b},getTmpData:function(a){return void 0===a?this.tmpData:this.tmpData[a]}});!function(){var a;f.registerModule=function(b,c){a||(a={}),a[b]=c},f.getModules=function(){return a}}();var j=a.createClass("MindEvent",{constructor:function(b,c,d){c=c||{},c.getType&&"ShapeEvent"==c.getType()?(this.kityEvent=c,this.originEvent=c.originEvent,this.getPosition=c.getPosition.bind(c)):c.target&&c.preventDefault?this.originEvent=c:a.Utils.extend(this,c),this.type=b,this._canstop=d||!1},getTargetNode:function(){var a=this.kityEvent&&this.kityEvent.targetShape;if(!a)return null;for(;!a.minderNode&&a.container;)a=a.container;return a.minderNode||null},stopPropagation:function(){this._stoped=!0},stopPropagationImmediately:function(){this._immediatelyStoped=!0,this._stoped=!0},shouldStopPropagation:function(){return this._canstop&&this._stoped},shouldStopPropagationImmediately:function(){return this._canstop&&this._immediatelyStoped},preventDefault:function(){this.originEvent.preventDefault()},isRightMB:function(){var a=!1;return this.originEvent?("which"in this.originEvent?a=3==this.originEvent.which:"button"in this.originEvent&&(a=2==this.originEvent.button),a):!1}}),k=f.Minder=a.createClass("KityMinder",{constructor:function(a){this._options=Utils.extend(b.KITYMINDER_CONFIG||{},a),this.setDefaultOptions(KM.defaultOptions),this._initEvents(),this._initMinder(),this._initSelection(),this._initStatus(),this._initShortcutKey(),this._initContextmenu(),this._initModules(),this.fire("ready")},getOptions:function(a){return this._options[a]},setDefaultOptions:function(a,b){var c={};Utils.isString(a)?c[a]=b:c=a,g.extend(this._options,c,!0)},_initMinder:function(){this._paper=new a.Paper,this._paper.getNode().setAttribute("contenteditable",!0),this._paper.getNode().ondragstart=function(a){a.preventDefault()},this._addRenderContainer(),this._root=new i(this.getLang().maintopic),this._root.setType("root"),this._options.renderTo&&this.renderTo(this._options.renderTo)},_addRenderContainer:function(){this._rc=new a.Group,this._paper.addShape(this._rc)},renderTo:function(a){this._paper.renderTo(this._renderTarget=a),this._bindEvents()},getRenderContainer:function(){return this._rc},getPaper:function(){return this._paper},getRenderTarget:function(){return this._renderTarget},_initShortcutKey:function(){this._shortcutkeys={},this._bindshortcutKeys()},isTextEditStatus:function(){return!1},addShortcutKeys:function(a,b){var c={},d=this;b?c[a]=b:c=a,g.each(c,function(a,b){d._shortcutkeys[a.toLowerCase()]=b})},getShortcutKey:function(a){return this._shortcutkeys[a]},_bindshortcutKeys:function(){function a(a,b,c){switch(a){case"ctrl":case"cmd":if(c.ctrlKey||c.metaKey)return!0;break;case"alt":if(c.altKey)return!0;break;case"shift":if(c.shiftKey)return!0}return b==m[a]?!0:!1}var b=this,c=this._shortcutkeys;b.on("keydown",function(d){var e=d.originEvent,f=e.keyCode||e.which;for(var h in c){var i=c[h].toLowerCase().split("+"),j=0;if(g.each(i,function(b,c){a(c,f,e)&&j++}),j==i.length){-1!=b.queryCommandState(h)&&b.execCommand(h),e.preventDefault();break}}})},_initContextmenu:function(){this.contextmenus=[]},addContextmenu:function(a){return g.isArray(a)?this.contextmenus=this.contextmenus.concat(a):this.contextmenus.push(a),this},getContextmenu:function(){return this.contextmenus},_initStatus:function(){this._status="normal",this._rollbackStatus="normal"},setStatus:function(a){return a?(this._rollbackStatus=this._status,this._status=a):this._status="",this},rollbackStatus:function(){this._status=this._rollbackStatus},getStatus:function(){return this._status}});Utils.extend(f,{_protocals:{},registerProtocal:function(a,b){f._protocals[a]=b()},findProtocal:function(a){return f._protocals[a]||null},getSupportedProtocals:function(){return Utils.keys(f._protocals).sort(function(a,b){return f._protocals[b].recognizePriority-f._protocals[a].recognizePriority})},getAllRegisteredProtocals:function(){return f._protocals}});var l={root:"maintopic",main:"topic"};a.extendClass(k,{exportData:function(a){var b,d;return b=c(this.getRoot()),d=f.findProtocal(a),d?d.encode(b,this):b},importData:function(a,b){var c,e;if(b?e=f.findProtocal(b):f.getSupportedProtocals().every(function(b){var c=f.findProtocal(b);return c.recognize&&c.recognize(a)&&(e=c),!e}),!e)throw new Error("Unsupported protocal: "+b);var g={local:a,protocalName:b,protocal:e},h=this._fire(new j("beforeimport",g,!0));if(h)return this;for(c=g.json||(g.json=e.decode(a)),this._fire(new j("preimport",g,!1));this._root.getChildren().length;)this._root.removeChild(0);return d(this._root,c,this),this._fire(new j("import",g,!1)),this._firePharse({type:"contentchange"}),this._firePharse({type:"interactchange"}),this}}),a.extendClass(k,{_initEvents:function(){this._eventCallbacks={}},_bindEvents:function(){this._bindPaperEvents(),this._bindKeyboardEvents()},_resetEvents:function(){this._initEvents(),this._bindEvents()},_bindPaperEvents:function(){this._paper.on("click dblclick mousedown contextmenu mouseup mousemove mousewheel DOMMouseScroll touchstart touchmove touchend",this._firePharse.bind(this)),b&&b.addEventListener("resize",this._firePharse.bind(this))},_bindKeyboardEvents:function(){-1==navigator.userAgent.indexOf("iPhone")&&-1==navigator.userAgent.indexOf("iPod")&&-1==navigator.userAgent.indexOf("iPad")&&Utils.listen(document.body,"keydown keyup keypress paste",this._firePharse.bind(this))},_firePharse:function(a){var b,c,d;"DOMMouseScroll"==a.type&&(a.type="mousewheel",a.wheelDelta=a.originEvent.wheelDelta=120*a.originEvent.detail),b=new j("before"+a.type,a,!0),this._fire(b)||(c=new j("pre"+a.type,a,!1),d=new j(a.type,a,!1),this._fire(c),this._fire(d),this._fire(new j("after"+a.type,a,!1)),~"mousedown mouseup keydown keyup".indexOf(a.type)&&this._interactChange(a))},_interactChange:function(){var a=this;clearTimeout(this._interactTimeout),this._interactTimeout=setTimeout(function(){var b=a._fire(new j("beforeinteractchange"));b||(a._fire(new j("preinteractchange")),a._fire(new j("interactchange")))},300)},_listen:function(a,b){var c=this._eventCallbacks[a]||(this._eventCallbacks[a]=[]);c.push(b)},_fire:function(a){var b=this.getStatus(),c=this._eventCallbacks[a.type.toLowerCase()]||[];if(b&&(c=c.concat(this._eventCallbacks[b+"."+a.type.toLowerCase()]||[])),0!==c.length){for(var d=this.getStatus(),e=0;e<c.length&&(c[e].call(this,a),this.getStatus()==d&&!a.shouldStopPropagationImmediately());e++);return a.shouldStopPropagation()}},on:function(a,b){var c=this;return g.each(a.split(/\s+/),function(a,d){c._listen(d.toLowerCase(),b)}),this},off:function(a,b){var c,d,e,f,g=a.split(/\s+/);for(c=0;c<g.length;c++)if(e=this._eventCallbacks[g[c].toLowerCase()]){for(f=null,d=0;d<e.length;d++)e[d]==b&&(f=d);null!==f&&e.splice(f,1)}},fire:function(a,b){var c=new j(a,b);return this._fire(c),this}}),a.extendClass(k,{_initModules:function(){var a=f.getModules(),b=this._options.modules||Utils.keys(a);this._commands={},this._query={},this._modules={};var c,d,e,g,h,i=this;for(c=0;c<b.length;c++)if(d=b[c],a[d]){e=a[d].call(i),this._modules[d]=e,e.init&&e.init.call(i,this._options),g=e.commands;for(var d in g)this._commands[d.toLowerCase()]=new g[d];if(h=e.events)for(var j in h)i.on(j,h[j]);e.defaultOptions&&this.setDefaultOptions(e.defaultOptions),e.addShortcutKeys&&this.addShortcutKeys(e.addShortcutKeys),e.contextmenu&&this.addContextmenu(e.contextmenu)}},_garbage:function(){for(this.clearSelect();this._root.getChildren().length;)this._root.removeChild(0)},destroy:function(){var a=this._modules;this._resetEvents(),this._garbage();for(var b in a)a[b].destroy&&a[b].destroy.call(this)},reset:function(){var a=this._modules;this._garbage();for(var b in a)a[b].reset&&a[b].reset.call(this)}}),a.extendClass(k,{_getCommand:function(a){return this._commands[a.toLowerCase()]},_queryCommand:function(a,b,c){var d=this._getCommand(a);if(d){var e=d["query"+b];if(e)return e.apply(d,[this].concat(c))}return 0},queryCommandState:function(a){return this._queryCommand(a,"State",Utils.argsToArray(1))},queryCommandValue:function(a){return this._queryCommand(a,"Value",Utils.argsToArray(1))},execCommand:function(a){a=a.toLowerCase();var b,c,d,e,f=Utils.argsToArray(arguments,1),g=this;return b=this._getCommand(a),e={command:b,commandName:a.toLowerCase(),commandArgs:f},b?(!this._hasEnterExecCommand&&b.isNeedUndo()?(this._hasEnterExecCommand=!0,c=this._fire(new j("beforeExecCommand",e,!0)),c||(this._fire(new j("saveScene")),this._fire(new j("preExecCommand",e,!1)),d=b.execute.apply(b,[g].concat(f)),this._fire(new j("execCommand",e,!1)),this._fire(new j("saveScene")),b.isContentChanged()&&this._firePharse(new j("contentchange")),b.isSelectionChanged()&&this._firePharse(new j("selectionchange")),this._firePharse(new j("interactchange"))),this._hasEnterExecCommand=!1):d=b.execute.apply(b,[g].concat(f)),void 0===d?null:d):!1}}),a.extendClass(k,{getRoot:function(){return this._root},setRoot:function(a){this._root=a},handelNodeInsert:function(a){var b=this._rc;a.traverse(function(a){b.addShape(a.getRenderContainer())})},handelNodeRemove:function(a){var b=this._rc;a.traverse(function(a){b.removeShape(a.getRenderContainer())})},renderNodes:function(a){var b=this;if(a instanceof Array){if(0===a.length)return!1;for(var c=0;c<a.length;c++)b.renderNode(a[c])}else b.renderNode(a)},getMinderTitle:function(){return this.getRoot().getText()}});var m=f.keymap={Backspace:8,Tab:9,Enter:13,Shift:16,Control:17,Alt:18,CapsLock:20,Esc:27,Spacebar:32,PageUp:33,PageDown:34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Del:46,NumLock:144,Cmd:91,"=":187,"-":189,b:66,i:73,z:90,y:89,v:86,x:88,s:83,n:78};a.extendClass(k,{getLang:function(a){var b=KM.LANG[this.getOptions("lang")];if(!b)throw Error("not import language file");a=(a||"").split(".");for(var c,d=0;(c=a[d++])&&(b=b[c],b););return b}}),KM.defaultOptions={zIndex:1e3,lang:"zh-cn"},f.Geometry=function(){function b(a){return a.width=a.right-a.left,a.height=a.bottom-a.top,a.x=a.left,a.y=a.top,a}var c={},d=Math.min,e=Math.max,f=(Math.abs,Object.prototype.hasOwnProperty);return c.isNumberInRange=function(a,b){return a>b[0]&&a<b[1]},c.getDistance=function(b,c){return a.Vector.fromPoints(b,c).length()},c.getBox=function(a,c){return b({left:d(a.x,c.x),right:e(a.x,c.x),top:d(a.y,c.y),bottom:e(a.y,c.y)})},c.mergeBox=function(a,c){return b({left:d(a.left,c.left),right:e(a.right,c.right),top:d(a.top,c.top),bottom:e(a.bottom,c.bottom)})},c.getBoxRange=function(a){return{x:[a.left,a.right],y:[a.top,a.bottom]}},c.getBoxVertex=function(a){return{leftTop:{x:a.left,y:a.top},rightTop:{x:a.right,y:a.top},leftBottom:{x:a.left,y:a.bottom},rightBottom:{x:a.right,y:a.bottom}}},c.isPointInsideBox=function(a,b){var d=c.getBoxRange(b);return c.isNumberInRange(a.x,d.x)&&c.isNumberInRange(a.y,d.y)},c.isBoxIntersect=function(a,b){var c=e(a.left,b.left),f=e(a.top,b.top),g=d(a.right,b.right),h=d(a.bottom,b.bottom);return g>c&&h>f},c.snapToSharp=function(a){return g.isNumber(a)?(0|a)+.5:g.isArray(a)?a.map(c.snapToSharp):(["x","y","left","top","right","bottom"].forEach(function(b){f.call(a,b)&&(a[b]=c.snapToSharp(a[b]))}),a)},c.expandBox=function(a,c,d){return void 0===d&&(d=c),b({left:a.left-c,top:a.top-d,right:a.right+c,bottom:a.bottom+d})},c}(),f.registerModule("HistoryModule",function(){var b=this,c=a.createClass("Scene",{constructor:function(a){this.data=a.clone()},getData:function(){return this.data},cloneData:function(){return this.getData().clone()},equals:function(a){return this.getData().equals(a.getData())}}),d=a.createClass("HistoryManager",{constructor:function(a){this.list=[],this.index=0,this.hasUndo=!1,this.hasRedo=!1,this.km=a},undo:function(){if(this.hasUndo){if(!this.list[this.index-1]&&1==this.list.length)return void this.reset();for(;this.list[this.index].equals(this.list[this.index-1]);)if(this.index--,0==this.index)return this.restore(0);this.restore(--this.index)}},redo:function(){if(this.hasRedo){for(;this.list[this.index].equals(this.list[this.index+1]);)if(this.index++,this.index==this.list.length-1)return this.restore(this.index);this.restore(++this.index)}},restore:function(){var a=this.list[this.index];this.km.setRoot(a.cloneData()),this.km.removeAllSelectedNodes(),this.km.initStyle(),this.update(),this.km.fire("restoreScene"),this.km.fire("contentChange")},getScene:function(){return new c(this.km.getRoot())},saveScene:function(){var a=this.getScene(),b=this.list[this.index];b&&b.equals(a)||(this.list=this.list.slice(0,this.index+1),this.list.push(a),this.list.length>this.km.getOptions("maxUndoCount")&&this.list.shift(),this.index=this.list.length-1,this.update())},update:function(){this.hasRedo=!!this.list[this.index+1],this.hasUndo=!!this.list[this.index-1]},reset:function(){this.list=[],this.index=0,this.hasUndo=!1,this.hasRedo=!1}});this.historyManager=new d(this);var e,f,g={16:1,17:1,18:1,91:1,37:1,38:1,39:1,40:1},i=0;return{defaultOptions:{maxUndoCount:20,maxInputCount:20},commands:{undo:a.createClass("UndoCommand",{base:h,execute:function(a){a.historyManager.undo()},queryState:function(a){return a.historyManager.hasUndo?0:-1},isNeedUndo:function(){return!1}}),redo:a.createClass("RedoCommand",{base:h,execute:function(a){a.historyManager.redo()},queryState:function(a){return a.historyManager.hasRedo?0:-1},isNeedUndo:function(){return!1}})},addShortcutKeys:{Undo:"ctrl+z",Redo:"ctrl+y"},events:{saveScene:function(){this.historyManager.saveScene()},renderNode:function(a){var c=a.node;c.isHighlight()&&b.select(c)},keydown:function(a){var c=a.originEvent,d=c.keyCode||c.which;g[d]||c.ctrlKey||c.metaKey||c.shiftKey||c.altKey||(0==b.historyManager.list.length&&b.historyManager.saveScene(),clearTimeout(f),f=setTimeout(function(){b.historyManager.saveScene()},200),e=d,i++,i>=b.getOptions("maxInputCount")&&b.historyManager.saveScene())},"import":function(){this.historyManager.reset()}}}}),f.registerModule("IconModule",function(){var b=function(b,c){var d=["","#A92E24","#29A6BD","#1E8D54","#eb6100","#876DDA"],e=(new a.Rect).fill(d[c]).setRadius(3).setWidth(20).setHeight(20),f=(new a.Text).setContent(c).fill("white").setSize(12),g=new a.Group;g.addShapes([e,f]),b.getIconRc().addShape(g),f.setTransform((new a.Matrix).translate(6,15))},c=function(b,c,d){var e,f,g=new a.Group,h=(new a.Circle).setRadius(8).fill("white").stroke(new a.Pen("#29A6BD",2));switch(5>c?(e=new a.Path,f=e.getDrawer(),f.moveTo(0,0).lineTo(6,0)):e=new a.Group,g.addShapes([h,e]),b.getIconRc().addShape(g),g.setTransform((new a.Matrix).translate(d,10)),e.setTransform(10,10),c){case 1:break;case 2:f.carcTo(6,0,-6);break;case 3:f.carcTo(6,-6,0);break;case 4:f.carcTo(6,0,6,1,0);break;case 5:var i=new a.Path;e.addShapes([(new a.Circle).setRadius(6).fill("#29A6BD"),i]),i.getDrawer().moveTo(-3,0).lineTo(-1,3).lineTo(3,-2),i.stroke(new a.Pen("white",2).setLineCap("round"))}5>c&&f.close(),e.fill("#29A6BD")},d=a.createClass("SetPriorityCommand",function(){return{base:h,execute:function(a,b){for(var c=a.getSelectedNodes(),d=0;d<c.length;d++)c[d].setData("PriorityIcon",b),a.updateLayout(c[d])},queryValue:function(a){for(var b,c=a.getSelectedNodes(),d=0;d<c.length&&!(b=c[d].getData("PriorityIcon"));d++);return b}}}()),e=a.createClass("SetProgressCommand",function(){return{base:h,execute:function(a,b){for(var c=a.getSelectedNodes(),d=0;d<c.length;d++)c[d].setData("ProgressIcon",b),a.updateLayout(c[d])},queryValue:function(a){for(var b,c=a.getSelectedNodes(),d=0;d<c.length&&!(b=c[d].getData("ProgressIcon"));d++);return b}}}());return{commands:{priority:d,progress:e},events:{RenderNode:function(d){var e=d.node,f=e.getIconRc(),g=(e.getContRc(),e.getData("PriorityIcon")),h=e.getData("ProgressIcon");f.clear();var i=0;g&&(b(e,g),i=22),h&&c(e,h,i+10);var j=f.getWidth(),k=e.getTextShape();k.setTransform(j?(new a.Matrix).translate(j+5,0):(new a.Matrix).translate(0,0)),f.setTransform((new a.Matrix).translate(0,-(f.getHeight()+k.getHeight())/2))}}}}),f.registerModule("LayoutModule",function(){a.extendClass(k,{addLayoutStyle:function(a,b){this._layoutStyles||(this._layoutStyles={}),this._layoutStyles[a]=b},getLayoutStyle:function(a){return this._layoutStyles[a]},getLayoutStyleItems:function(){var a=[];for(var b in this._layoutStyles)a.push(b);return a},getCurrentStyle:function(){var a=this.getRoot();return a.getData("currentstyle")},setCurrentStyle:function(a){var b=this.getRoot();return b.setData("currentstyle",a),a},highlightNode:function(a){var b=this.getCurrentStyle();this.getLayoutStyle(b).highlightNode.call(this,a)},initStyle:function(){var b=this.getCurrentStyle(),c=this._rc.getTransform();this._rc.remove(),this._rc=(new a.Group).setTransform(c),this._paper.addShape(this._rc);var d=this.getRoot();d.preTraverse(function(a){a.clearLayout()}),this.getLayoutStyle(b).initStyle.call(this)},appendChildNode:function(a,b,c){var d=this.getCurrentStyle();this.getLayoutStyle(d).appendChildNode.call(this,a,b,c)},appendSiblingNode:function(a,b){var c=this.getCurrentStyle();this.getLayoutStyle(c).appendSiblingNode.call(this,a,b)},removeNode:function(a){var b=this.getCurrentStyle();this.getLayoutStyle(b).removeNode.call(this,a)},updateLayout:function(a){var b=this.getCurrentStyle();this.getLayoutStyle(b).updateLayout.call(this,a)},expandNode:function(a){var b=this.getCurrentStyle();this.getLayoutStyle(b).expandNode.call(this,a)}}),a.extendClass(i,{setLayout:function(a,b){void 0===this._layout&&(this._layout={});var c=this.getLayout();Utils.extend(c,{k:b}),this._layout=c},getLayout:function(a){return void 0===a?this._layout:this._layout[a]},clearLayout:function(){this._layout={}}});var b=function(a,b){var c=a.getRoot();return c.preTraverse(function(a){a.setPoint(),a.getBgRc().clear()}),a.setCurrentStyle(b),a.initStyle(),b},c=a.createClass("SwitchLayoutCommand",function(){return{base:h,execute:b,queryValue:function(a){return a.getCurrentStyle()}}}()),d=a.createClass("AppendChildNodeCommand",function(){return{base:h,execute:function(a,b){var c=a.getSelectedNode();return"root"!==c.getType()&&0!==c.getChildren().length&&c.getData("expand")===!1&&a.expandNode(c),a.appendChildNode(c,b),a.select(b,!0),b},queryState:function(a){var b=a.getSelectedNode();return b?0:-1}}}()),e=a.createClass("AppendSiblingNodeCommand",function(){return{base:h,execute:function(a,b){var c=a.getSelectedNode();return c.isRoot()?(b.setType("main"),a.appendChildNode(c,b)):a.appendSiblingNode(c,b),a.select(b,!0),b},queryState:function(a){var b=a.getSelectedNodes();return 0===b.length||1===b.length&&b[0]===a.getRoot()?-1:0}}}()),f=a.createClass("RemoveNodeCommand",function(){return{base:h,execute:function(a){for(var b=a.getSelectedNodes(),c=(a.getRoot(),[]),d=0;d<b.length;d++)c.push(b[d]);do{var e=c[0].getParent();e&&-1===c.indexOf(e)&&c.push(e),c.shift()}while(c.length>1);a.removeNode(b),a.select(c[0])},queryState:function(a){var b=a.getSelectedNodes();return 0===b.length||1===b.length&&b[0]===a.getRoot()?-1:0}}}());return{commands:{appendchildnode:d,appendsiblingnode:e,removenode:f,switchlayout:c},events:{ready:function(){this.setDefaultOptions("layoutstyle",this.getLayoutStyleItems()),b(this,this.getOptions("defaultlayoutstyle"))},click:function(a){var b=a.kityEvent.targetShape&&a.kityEvent.targetShape.container;b&&"shicon"===b.class&&this.expandNode(b)},resize:function(){clearTimeout(this._lastStyleResetTimeout),this._lastStyleResetTimeout=setTimeout(function(){this.updateLayout(this.getRoot())}.bind(this),100)},"import":function(){this.initStyle(this.getRoot())}},contextmenu:[{label:this.getLang("node.appendsiblingnode"),exec:function(){this.execCommand("appendsiblingnode",new i(this.getLang("topic")))},cmdName:"appendsiblingnode"},{label:this.getLang("node.appendchildnode"),exec:function(){this.execCommand("appendchildnode",new i(this.getLang("topic")))},cmdName:"appendchildnode"},{label:this.getLang("node.removenode"),cmdName:"removenode"},{divider:1}],defaultOptions:{defaultlayoutstyle:"default",node:{appendsiblingnode:"appendsiblingnode",appendchildnode:"appendchildnode",removenode:"removenode"}}}}),f.registerModule("LayoutDefault",function(){function b(){return{width:c.clientWidth,height:c.clientHeight}}var c=this.getRenderTarget(),d=this,e=a.createClass("DefaultshIcon",function(){return{constructor:function(b){this._show=!1,this._node=b;var c=this.shape=new a.Group;c.class="shicon",c.icon=this;var e=this._circle=(new a.Circle).fill("white").stroke("gray").setRadius(5),f=this._plus=new a.Path;f.getDrawer().moveTo(-3,0).lineTo(3,0).moveTo(0,-3).lineTo(0,3),f.stroke("gray");var g=this._dec=new a.Path;g.getDrawer().moveTo(-3,0).lineTo(3,0),g.stroke("gray"),d.getRenderContainer().addShape(c),c.addShapes([e,f,g]),this.update(),this.switchState()},switchState:function(){return this._show?(this._plus.setOpacity(1),this._dec.setOpacity(0),this._show=!1):(this._plus.setOpacity(0),this._dec.setOpacity(1),this._show=!0),this._show},update:function(){var b,c=this._node,d=c.getLayout(),e=c.getRenderContainer(),f="main"===c.getType()?d.y:d.y+e.getHeight()/2-5;"left"===d.appendside?b=e.getRenderBox().closurePoints[1].x-5:(b=e.getRenderBox().closurePoints[0].x+6,"main"===c.getType()&&(b-=3)),this.shape.setTransform((new a.Matrix).translate(b,f))},remove:function(){this.shape.remove()}}}()),f=function(a,b){for(var c=0;c<a.length;c++){var d=b.indexOf(a[c]);-1!==d&&b.splice(d,1)}return a.concat(b)},g={root:{color:"#430",fill:"#e9df98",fontSize:24,padding:[15.5,25.5,15.5,25.5],margin:[0,0,0,0],radius:30,highlight:"rgb(254, 219, 0)"},main:{stroke:new a.Pen("white",2).setLineCap("round").setLineJoin("round"),fill:"#A4c5c0",color:"#333",padding:[6.5,20,6.5,20],fontSize:16,margin:[0,10,30,50],radius:10,highlight:"rgb(254, 219, 0)"},sub:{stroke:new a.Pen("white",2).setLineCap("round").setLineJoin("round"),color:"white",fontSize:12,margin:[0,10,20,6],padding:[5,10,5.5,10],highlight:"rgb(254, 219, 0)"}},h=function(b){var c=b.getType(),d=g[c],e=b.getLayout();switch(b.getType()){case"root":case"main":var f=b.getBgRc().clear();f.addShape(e.bgShadow=new a.Rect),f.addShape(e.bgRect=new a.Rect),e.bgRect.fill(d.fill).setRadius(d.radius),e.bgShadow.fill("black").setOpacity(.2).setRadius(d.radius).translate(3,5);break;case"sub":var h=e.underline=new a.Path,i=e.highlightshape=(new a.Rect).setRadius(4);b.getBgRc().clear().addShapes([e.bgRect=(new a.Rect).setRadius(4),i,h])}},k=function(a){var b=a.getLayout(),c=a.getType(),d=g[c],e=a.getTextShape();
e.fill(d.color).setSize(d.fontSize).setY(-3),"root"===c&&(b.leftList=[],b.rightList=[],b.leftHeight=0,b.rightHeight=0)},l=function(b){var c=b.getContRc(),d=b.getType(),e=g[d],f=c.getWidth(),h=c.getHeight(),i=b.getLayout();switch(d){case"root":case"main":var j=f+e.padding[1]+e.padding[3],k=h+e.padding[0]+e.padding[2];i.bgRect.setWidth(j).setHeight(k),i.bgShadow.setWidth(j).setHeight(k);break;case"sub":var l=c.getWidth(),m=c.getHeight();j=l+e.padding[1]+e.padding[3],k=m+e.padding[0]+e.padding[2],i.underline.getDrawer().clear().moveTo(0,m+e.padding[2]+e.padding[0]).lineTo(l+e.padding[1]+e.padding[3],m+e.padding[2]+e.padding[0]),i.underline.stroke(e.stroke),i.highlightshape.setWidth(l+e.padding[1]+e.padding[3]).setHeight(m+e.padding[0]+e.padding[2]),i.bgRect.setWidth(j).setHeight(k)}c.setTransform((new a.Matrix).translate(e.padding[3],e.padding[0]+b.getTextShape().getHeight()))},m=function(a,c,e){var f=d.getRoot(),h=[a];"remove"===e&&(h=[]);var i=a.getLayout(),j=(a.getRenderContainer(),a.getType()),k=g[j],l=i.appendside,m=function(a,b){var c=g[a.getType()],d=a.getRenderContainer().getHeight()+c.margin[0]+c.margin[2],e=function(){var c,d=0;c=b?a.getLayout()[b+"List"]:a.getChildren();for(var e=0;e<c.length;e++){var f=c[e].getLayout();0!==c[e].getRenderContainer().getHeight()&&(d+=f.branchheight)}return d}();return b?e:d>e?d:e};if("root"===j)i.y=b().height/2,h.push(a);else{"append"===e||"contract"===e?i.branchheight=a.getRenderContainer().getHeight()+k.margin[0]+k.margin[2]:"change"===e&&(i.branchheight=m(a));for(var n=(c.getLayout(),c.getRenderContainer(),a.getParent()||c);n;){var o=n.getLayout();"root"===n.getType()?o[l+"Height"]=m(n,l):o.branchheight=m(n),n=n.getParent()}}var p=function(a){for(var b=[f];b.length>0;){var c=b[0].getLayout(),d=c[a+"List"]||b[0].getChildren();b=b.concat(d);for(var e=c.y-(c[a+"Height"]||c.branchheight)/2,g=0;g<d.length;g++){var i=d[g].getLayout();i.y=e+i.branchheight/2,e+=i.branchheight}b[0]!==f&&h.push(b[0]),b.shift()}};return l?p(l):(p("left"),p("right")),h},n=function(a){for(var c=(a.getType(),a.getParent(),[a]),d=a.getLayout(),e=[a];0!==e.length;){var f=e[0].getParent();if(e=e.concat(e[0].getChildren()),f){var h=f.getLayout(),i=f.getRenderContainer().getWidth(),j=g[f.getType()],k=e[0].getLayout(),l=g[e[0].getType()];"center"===h.align&&(i/=2),k.x="left"===k.appendside?h.x-i-j.margin[1]-l.margin[3]:h.x+i+j.margin[1]+l.margin[3],c.push(e[0]),e.shift()}else d.x=b().width/2,e.shift()}return c},o=function(b){var c=b.getLayout(),d=b.getRenderContainer(),e=c.align,f=d.getHeight(),g=d.getWidth();switch(e){case"right":d.setTransform((new a.Matrix).translate(c.x-g,c.y-f/2));break;case"center":d.setTransform((new a.Matrix).translate(c.x-g/2,c.y-f/2));break;default:d.setTransform((new a.Matrix).translate(c.x,c.y-f/2))}b.setPoint(c.x,c.y)},p=function(b){var c,f=b.getType(),h=b.getLayout(),i=g[b.getType()];if("main"===f){if(!h.connect){c=h.connect=new a.Group;var j=h.connect.bezier=new a.Bezier,k=h.connect.circle=new a.Circle;c.addShapes([j,k]),d.getRenderContainer().addShape(c),d.getRoot().getRenderContainer().bringTop()}var l=d.getRoot(),m=l.getLayout().x,n=l.getLayout().y;c=h.connect;var o,p,q=b.getRenderContainer(),r=q.getRenderBox().closurePoints;"left"===h.appendside?(o=new a.BezierPoint(m-30,r[2].y+q.getHeight()/2),p=new a.BezierPoint(r[2].x+3,r[2].y+q.getHeight()/2)):(o=new a.BezierPoint(m+30,r[3].y+q.getHeight()/2),p=new a.BezierPoint(r[3].x-3,r[3].y+q.getHeight()/2));var s=(o.getVertex(),p.getVertex());o.setVertex(m,n),c.bezier.setPoints([o,p]).stroke(i.stroke),c.circle.setCenter(s.x+("left"===h.appendside?-.5:-1.5),s.y).fill("white").setRadius(4)}else if("sub"===f){h.connect||(c=h.connect=new a.Path,d.getRenderContainer().addShape(c)),c=h.connect;var t,u,v=b.getParent().getRenderContainer(),w=v.getRenderBox(),x=b.getParent().getLayout(),y=g[b.getParent().getType()],z=b.getRenderContainer(),A=x.y,B=z.getRenderBox().closurePoints[1].y;"left"===h.appendside?(t=w.closurePoints[1].x-y.margin[1],u=z.getRenderBox().closurePoints[0].x,c.getDrawer().clear().moveTo(t,A).lineTo(t,B>A?B-i.margin[3]:B+i.margin[3]),B>A?c.getDrawer().carcTo(i.margin[3],u,B,0,1):c.getDrawer().carcTo(i.margin[3],u,B),c.stroke(i.stroke)):(t=w.closurePoints[0].x+y.margin[1],u=z.getRenderBox().closurePoints[1].x+1,c.getDrawer().clear().moveTo(t,A).lineTo(t,B>A?B-i.margin[3]:B+i.margin[3]),B>A?c.getDrawer().carcTo(i.margin[3],u,B):c.getDrawer().carcTo(i.margin[3],u,B,0,1),c.stroke(i.stroke))}"root"!==f&&0!==b.getChildren().length&&(h.shicon||(h.shicon=new e(b)),h.shicon.update())},q={highlightNode:function(a){var b=a.isHighlight(),c=a.getType(),d=g[c],e=a.getLayout();switch(c){case"root":case"main":e.bgRect.fill(b?d.highlight:d.fill);break;case"sub":b?(e.highlightshape.fill(d.highlight).setOpacity(1),a.getTextShape().fill("black")):(e.highlightshape.setOpacity(0),a.getTextShape().fill("white"))}this._fire(new j("beforeRenderNode",{node:a},!1)),this._fire(new j("RenderNode",{node:a},!1))},updateLayout:function(a){this._fire(new j("beforeRenderNode",{node:a},!1)),this._fire(new j("RenderNode",{node:a},!1)),l(a);for(var b=n(a),c=m(a,a.getParent(),"change"),d=f(b,c),e=0;e<d.length;e++)o(d[e]),p(d[e])},initStyle:function(){var a=d.getRoot(),b=a.getPoint();b&&(b=JSON.parse(JSON.stringify(b))),d.handelNodeInsert(a),a.getLayout().align="center",h(a),k(a),this._fire(new j("beforeRenderNode",{node:a},!1)),this._fire(new j("RenderNode",{node:a},!1)),l(a),n(a),m(a),o(a);for(var c=[a],e=[];0!==c.length;){var f=c[0].getChildren();c=c.concat(f);for(var g=0;g<f.length;g++)f[g].getLayout().parent=c[0];c[0].clearChildren(),c[0]!==a&&e.push(c[0]),c.shift()}b&&a.setPoint(b);for(var i=0;i<e.length;i++)this.appendChildNode(e[i].getLayout().parent,e[i]);a.setPoint(a.getLayout().x,a.getLayout().y)},appendChildNode:function(a,b,c){d.handelNodeInsert(b),b.clearLayout();var e=b.getLayout(),g=a.getLayout();if(c){var i=c.getLayout();if(e.appendside=i.appendside,e.align=i.align,a.insertChild(b,c.getIndex()+1),"root"===a.getType()){var q=a.getChildren().length;7>q&&(q%2?(e.appendside="right",e.align="left"):(e.appendside="left",e.align="right"));var r=g[e.appendside+"List"],s=r.indexOf(c);r.splice(s+1,0,b)}}else if("root"!==a.getType()){var t=a.getLayout();e.appendside=t.appendside,e.align=t.align,a.appendChild(b)}else{var u=b.getPoint();u&&u.x&&u.y?u.x>a.getPoint().x?(e.appendside="right",e.align="left"):(e.appendside="left",e.align="right"):g.rightList.length>1&&g.rightList.length>g.leftList.length?(e.appendside="left",e.align="right"):(e.appendside="right",e.align="left");var v=g[e.appendside+"List"];v.push(b);var w;w="right"===e.appendside?v.length:a.getChildren().length,a.insertChild(b,w)}b.setType("root"===a.getType()?"main":"sub"),h(b),k(b),this._fire(new j("beforeRenderNode",{node:b},!1)),this._fire(new j("RenderNode",{node:b},!1)),l(b);for(var x=m(b,a,"append"),y=n(b),z=f(x,y),A=0;A<z.length;A++)o(z[A]),p(z[A])},appendSiblingNode:function(a,b){var c=a.getParent();this.appendChildNode(c,b,a)},removeNode:function(a){for(;0!==a.length;){var b=a[0].getParent();if(!b)return a.splice(0,1),!1;var c=a[0].getLayout();if("root"===b.getType()){var d=b.getLayout()[c.appendside+"List"],e=d.indexOf(a[0]);d.splice(e,1)}if(b.removeChild(a[0]),"root"!==b.getType()&&0===b.getChildren().length){var f=b.getLayout();f.shicon.remove(),f.shicon=null}for(var g=m(a[0],b,"remove"),h=0;h<g.length;h++)o(g[h]),p(g[h]);for(var i=[a[0]];0!==i.length;){i=i.concat(i[0].getChildren());try{i[0].getRenderContainer().remove();var j=i[0].getLayout();j.connect.remove(),j.shicon.remove()}catch(k){console.log("isRemoved")}var l=a.indexOf(i[0]);-1!==l&&a.splice(l,1),i.shift()}}},expandNode:function(a){var b,c;a instanceof i?(c=a,b=c.getLayout().shicon.switchState()):(b=a.icon.switchState(),c=a.icon._node),c.setData("expand",b);for(var e=c.getChildren(),f=[];0!==e.length;){var g=e[0].getLayout();if(b){var h=e[0].getParent();g.parent=h,f.push(e[0]),g.connect=null,g.shicon=null}else try{e[0].getRenderContainer().remove(),g.connect.remove(),g.shicon&&g.shicon.remove()}catch(j){}e=e.concat(e[0].getChildren()),e.shift()}if(b){c.clearChildren();for(var k=0;k<f.length;k++)f[k].clearChildren(),d.appendChildNode(f[k].getLayout().parent,f[k])}var l=[];b||(l=m(c,c.getParent(),"contract"));for(var n=0;n<l.length;n++)o(l[n]),p(l[n])}};return this.addLayoutStyle("default",q),{}}),f.registerModule("LayoutBottom",function(){function b(){return{width:c.clientWidth,height:c.clientHeight}}var c=this.getRenderTarget(),d=this,e=a.createClass("DefaultshIcon",function(){return{constructor:function(b){this._show=!1,this._node=b;var c=this.shape=new a.Group;c.class="shicon",c.icon=this;var e=this._rect=(new a.Rect).fill("white").stroke("gray").setRadius(2).setWidth(10).setHeight(10),f=this._plus=new a.Path;f.getDrawer().moveTo(2,5).lineTo(8,5).moveTo(5,2).lineTo(5,8),f.stroke("gray");var g=this._dec=new a.Path;g.getDrawer().moveTo(2,5).lineTo(8,5),g.stroke("gray"),"main"===b.getType()?d.getRenderContainer().addShape(c):b.getLayout().subgroup.addShape(c),c.addShapes([e,f,g]),this.update(),this.switchState()},switchState:function(){return this._show?(this._plus.setOpacity(1),this._dec.setOpacity(0),this._show=!1):(this._plus.setOpacity(0),this._dec.setOpacity(1),this._show=!0),this._show},update:function(){var b=this._node,c=(b.getLayout(),b.getRenderContainer()),d=(b.getType(),c.getRenderBox().closurePoints[1].x+5),e=c.getRenderBox().closurePoints[0].y;this.shape.setTransform((new a.Matrix).translate(d,e))},remove:function(){this.shape.remove()}}}()),f={root:{color:"#430",fill:"#e9df98",fontSize:24,padding:[15.5,25.5,15.5,25.5],margin:[0,0,20,0],radius:0,highlight:"rgb(254, 219, 0)"},main:{stroke:new a.Pen("white",2).setLineCap("round").setLineJoin("round"),fill:"#A4c5c0",color:"#333",padding:[6.5,20,6.5,20],fontSize:16,margin:[20,20,10,10],radius:0,highlight:"rgb(254, 219, 0)"},sub:{stroke:new a.Pen("white",2).setLineCap("round").setLineJoin("round"),color:"#333",fontSize:12,margin:[10,10,10,30],padding:[5,10,5.5,10],highlight:"rgb(254, 219, 0)",fill:"rgb(231, 243, 255)"}},g=function(b){var c=b.getType(),d=f[c],e=b.getLayout();switch(b.getType()){case"root":case"main":var g=b.getBgRc().clear();g.addShape(e.bgShadow=new a.Rect),g.addShape(e.bgRect=new a.Rect),e.bgRect.fill(d.fill).setRadius(d.radius),e.bgShadow.fill("black").setOpacity(.2).setRadius(d.radius).translate(3,5);break;case"sub":var h=b.getBgRc().clear();h.addShape(e.bgRect=new a.Rect),e.bgRect.fill(d.fill)}},h=function(b){var c=b.getLayout(),e=b.getType(),g=f[e],h=b.getTextShape();if(h.fill(g.color).setSize(g.fontSize).setY(-3),"main"===e){var i=c.subgroup=new a.Group;d.getRenderContainer().addShape(i)}},k=function(b){var c=b.getContRc(),d=b.getType(),e=f[d],g=c.getWidth(),h=c.getHeight(),i=b.getLayout();switch(d){case"root":case"main":var j=g+e.padding[1]+e.padding[3],k=h+e.padding[0]+e.padding[2];i.bgRect.setWidth(j).setHeight(k),i.bgShadow.setWidth(j).setHeight(k);break;case"sub":j=g+e.padding[1]+e.padding[3],k=h+e.padding[0]+e.padding[2],i.bgRect.setWidth(j).setHeight(k)}c.setTransform((new a.Matrix).translate(e.padding[3],e.padding[0]+b.getTextShape().getHeight()))},l=function(){for(var a=d.getRoot(),b=a.getChildren(),c=function(a){var b=a.getLayout(),c=a.getRenderContainer().getWidth()+f.main.margin[1]+f.main.margin[3],d=b.subgroup.getWidth()+f.main.margin[1]+f.sub.margin[3],e=b.branchwidth=c>d?c:d;return e},e=a.getLayout(),g=0,h=0;h<b.length;h++)g+=c(b[h]);for(var i=e.x-g/2,j=0;j<b.length;j++){var k=b[j].getLayout();k.x=i+f.main.margin[3]+5,i+=k.branchwidth}return b},m=function(a,c,e){var g=[],h=a.getType(),i=a.getLayout(),j=d.getRoot(),k=j.getLayout();if("root"===h){i.x=b().width/2,i.y=100,i.align="center",g.push(a);for(var m=a.getChildren(),n=0;n<m.length;n++){var o=m[n].getLayout();o.y=i.y+a.getRenderContainer().getHeight()+f.root.margin[2]+f.main.margin[0]}g=g.concat(m)}else if("main"===h)i.align="left",("append"===e||"contract"===e)&&(i.y=k.y+j.getRenderContainer().getHeight()+f.root.margin[2]+f.main.margin[0]),g=l();else{i.align="left";var p=c.getLayout();"append"===e&&(i.x="main"===c.getType()?f.sub.margin[3]:p.x+f.sub.margin[3]),("append"===e||"contract"===e)&&(i.branchheight=a.getRenderContainer().getHeight()+f.sub.margin[0]+f.sub.margin[2]);var q=c;for("change"===e&&(q=a);"main"!==q.getType();){for(var r=q.getChildren(),s=q.getLayout(),t=q.getRenderContainer().getHeight()+f.sub.margin[0]+f.sub.margin[2],u=0;u<r.length;u++)t+=r[u].getLayout().branchheight;s.branchheight=t,q=q.getParent()}for(var v=[q];0!==v.length;){var w=v[0].getChildren();v=v.concat(w);var x,y=v[0].getLayout(),z=f[v[0].getType()];x="main"===v[0].getType()?0:y.y+v[0].getRenderContainer().getHeight()+z.margin[2];for(var A=0;A<w.length;A++){var B=w[A].getLayout(),C=f[w[A].getType()];B.y=x+C.margin[0],x+=B.branchheight}g.push(v[0]),v.shift()}}return g},n=function(b){var c=b.getLayout(),d=b.getRenderContainer(),e=c.align,f=(d.getHeight(),d.getWidth());switch(e){case"right":d.setTransform((new a.Matrix).translate(c.x-f,c.y));break;case"center":d.setTransform((new a.Matrix).translate(c.x-f/2,c.y));break;default:d.setTransform((new a.Matrix).translate(c.x,c.y))}"main"===b.getType()&&c.subgroup.setTransform((new a.Matrix).translate(c.x,c.y+b.getRenderContainer().getHeight())),b.setPoint(c.x,c.y)},o=function(b){var c,g=b.getType(),h=b.getLayout(),i=(f[b.getType()],d.getRoot()),j=i.getLayout();if("main"===g){h.connect||(c=h.connect=new a.Path,d.getRenderContainer().addShape(c)),c=h.connect;var k=j.x,l=j.y+i.getRenderContainer().getHeight(),m=h.x+b.getRenderContainer().getWidth()/2,n=l+f.root.margin[2];c.getDrawer().clear().moveTo(k,l).lineTo(k,n).lineTo(m,n).lineTo(m,h.y),c.stroke(f.main.stroke)}else if("sub"===g){var o=b.getParent(),p=o.getLayout();h.connect||(c=h.connect=new a.Path,h.subgroup.addShape(c)),c=h.connect;var q,r;"main"===o.getType()?(q=10,r=0):(q=p.x+10,r=p.y+o.getRenderContainer().getHeight()+10);var s=h.y+b.getRenderContainer().getHeight()/2;c.getDrawer().clear().moveTo(q,r).lineTo(q,s).lineTo(h.x,s),c.stroke(f.sub.stroke)}"root"!==g&&0!==b.getChildren().length&&(h.shicon||(h.shicon=new e(b)),h.shicon.update())},p={highlightNode:function(a){var b=a.isHighlight(),c=a.getType(),d=f[c],e=a.getLayout();switch(c){case"root":case"main":case"sub":e.bgRect.fill(b?d.highlight:d.fill)}this._fire(new j("beforeRenderNode",{node:a},!1)),this._fire(new j("RenderNode",{node:a},!1))},updateLayout:function(a){this._fire(new j("beforeRenderNode",{node:a},!1)),this._fire(new j("RenderNode",{node:a},!1)),k(a);for(var b=m(a,a.getParent(),"change"),c=0;c<b.length;c++)n(b[c]),o(b[c]);if("sub"===a.getType())for(var d=l(),e=0;e<d.length;e++)n(d[e]),o(d[e])},initStyle:function(){var a=d.getRoot();d.handelNodeInsert(a),a.getLayout().align="center",g(a),h(a),this._fire(new j("beforeRenderNode",{node:a},!1)),this._fire(new j("RenderNode",{node:a},!1)),k(a),m(a),n(a);for(var b=[a],c=[];0!==b.length;){var e=b[0].getChildren();b=b.concat(e);for(var f=0;f<e.length;f++)e[f].getLayout().parent=b[0];b[0].clearChildren(),b[0]!==a&&c.push(b[0]),b.shift()}for(var i=0;i<c.length;i++)this.appendChildNode(c[i].getLayout().parent,c[i])},appendChildNode:function(a,b,c){b.clearLayout();{var e=a.getLayout();a.getData("expand")}"root"===a.getType()?(b.setType("main"),b.setData("expand",!0),d.handelNodeInsert(b)):(b.setType("sub"),e.subgroup.addShape(b.getRenderContainer()),b.getLayout().subgroup=e.subgroup),c?a.insertChild(b,c.getIndex()+1):a.appendChild(b),g(b),h(b),this._fire(new j("beforeRenderNode",{node:b},!1)),this._fire(new j("RenderNode",{node:b},!1)),k(b);for(var f=m(b,a,"append"),i=0;i<f.length;i++)n(f[i]),o(f[i]);if("sub"===b.getType())for(var p=l(),q=0;q<p.length;q++)n(p[q]),o(p[q])},appendSiblingNode:function(a,b){var c=a.getParent();this.appendChildNode(c,b,a)},removeNode:function(a){for(;0!==a.length;){var b=a[0].getParent();if(!b)return a.splice(0,1),!1;{a[0].getLayout()}if(b.removeChild(a[0]),"root"!==b.getType()&&0===b.getChildren().length){var c=b.getLayout();c.shicon.remove(),c.shicon=null}for(var d=m(a[0],b,"remove"),e=0;e<d.length;e++)n(d[e]),o(d[e]);for(var f=l(),g=0;g<f.length;g++)n(f[g]),o(f[g]);for(var h=[a[0]];0!==h.length;){h=h.concat(h[0].getChildren());try{h[0].getRenderContainer().remove();var i=h[0].getLayout();i.connect.remove(),i.shicon.remove()}catch(j){console.log("isRemoved")}var k=a.indexOf(h[0]);-1!==k&&a.splice(k,1),h.shift()}}},expandNode:function(a){var b,c;a instanceof i?(c=a,b=c.getLayout().shicon.switchState()):(b=a.icon.switchState(),c=a.icon._node),c.setData("expand",b);for(var e=c.getChildren(),f=[];0!==e.length;){var g=e[0].getLayout();if(b){var h=e[0].getParent();g.parent=h,f.push(e[0]),g.connect=null,g.shicon=null}else try{e[0].getRenderContainer().remove(),g.connect.remove(),g.shicon&&g.shicon.remove()}catch(j){}e=e.concat(e[0].getChildren()),e.shift()}if(b){c.clearChildren();for(var k=0;k<f.length;k++)f[k].clearChildren(),d.appendChildNode(f[k].getLayout().parent,f[k])}var l=[];b||(l=m(c,c.getParent(),"contract"));for(var p=0;p<l.length;p++)n(l[p]),o(l[p])}};return this.addLayoutStyle("bottom",p),{}}),a.extendClass(k,function(){function a(a,b){b.setTmpData("highlight",!0),a.highlightNode(b)}function b(a,b){b.setTmpData("highlight",!1),a.highlightNode(b)}return{_initSelection:function(){this._selectedNodes=[]},getSelectedNodes:function(){return this._selectedNodes},getSelectedNode:function(){return this.getSelectedNodes()[0]||null},removeAllSelectedNodes:function(){var a=this;return Utils.each(this.getSelectedNodes(),function(c,d){b(a,d)}),this._selectedNodes=[],this.fire("selectionclear")},removeSelectedNodes:function(a){var c=this;return Utils.each(Utils.isArray(a)?a:[a],function(a,d){var e;-1!==(e=c._selectedNodes.indexOf(d))&&(c._selectedNodes.splice(e,1),b(c,d))}),this},select:function(b,c){c&&this.removeAllSelectedNodes();var d=this;return Utils.each(Utils.isArray(b)?b:[b],function(b,c){-1===d._selectedNodes.indexOf(c)&&(d._selectedNodes.push(c),a(d,c))}),this},isNodeSelected:function(a){return a.getTmpData("highlight")===!0},toggleSelect:function(a){return Utils.isArray(a)?a.forEach(this.toggleSelect.bind(this)):a.isSelected()?this.removeSelectedNodes(a):this.select(a),this},isSingleSelect:function(){return 1==this._selectedNodes.length},getSelectedAncestors:function(){function a(a,b){for(var c=a.length-1;c>=0;--c)if(a[c].isAncestorOf(b))return!0;return!1}var b,c=this.getSelectedNodes().slice(0),d=[],e=c.indexOf(this.getRoot());for(~e&&c.splice(e,1),c.sort(function(a,b){return a.getLevel()-b.getLevel()});b=c.pop();)a(c,b)||d.push(b);return d}}}());var n=a.createClass("ViewDragger",{constructor:function(a){this._minder=a,this._enabled=!1,this._offset={x:0,y:0},this._bind()},isEnabled:function(){return this._enabled},setEnabled:function(a){var b=this._minder.getPaper();b.setStyle("cursor",a?"pointer":"default"),b.setStyle("cursor",a?"-webkit-grab":"default"),this._enabled=a},move:function(a){this._minder.getRenderContainer().translate(a.x,a.y)},_bind:function(){var b=this,c=!1,d=null,e=null;this._minder.on("normal.beforemousedown",function(a){if(!(a.getTargetNode()!=this.getRoot()||this.getRoot().isSelected()&&this.isSingleSelect())){d=a.getPosition(),b.setEnabled(!0),c=!0;var e=this;setTimeout(function(){e.setStatus("hand")},1)}}).on("hand.beforemousedown",function(a){b.isEnabled()&&(d=a.getPosition(),a.stopPropagation(),a.originEvent.preventDefault())}).on("hand.beforemousemove",function(c){if(d){e=c.getPosition();var f=a.Vector.fromPoints(d,e);b.move(f),c.stopPropagation(),d=e}}).on("hand.mouseup",function(){d=null,c&&(b.setEnabled(!1),c=!1,this.rollbackStatus())})}});f.registerModule("View",function(){var b=a.createClass("ToggleHandCommand",{base:h,execute:function(a){a._viewDragger.setEnabled(!a._viewDragger.isEnabled()),a._viewDragger.isEnabled()?a.setStatus("hand"):a.rollbackStatus(),this.setContentChanged(!1)},queryState:function(a){return a._viewDragger.isEnabled()?1:0}}),c=a.createClass("CameraCommand",{base:h,execute:function(a,b){var c=a.getPaper().getViewPort(),d=b.getRenderContainer().getRenderBox(a.getRenderContainer()),e=c.center.x-d.x-d.width/2,f=c.center.y-d.y;a.getRenderContainer().fxTranslate(e,f,1e3,"easeOutQuint"),this.setContentChanged(!1)}});return{init:function(){this._viewDragger=new n(this)},commands:{hand:b,camera:c},events:{keyup:function(a){a.originEvent.keyCode==m.Spacebar&&0===this.getSelectedNodes().length&&(this.execCommand("hand"),a.preventDefault())},mousewheel:function(a){var b,c;a=a.originEvent,a.ctrlKey||a.shiftKey||("wheelDeltaX"in a?(b=a.wheelDeltaX||0,c=a.wheelDeltaY||0):(b=0,c=a.wheelDelta),this._viewDragger.move({x:b/2.5,y:c/2.5}),a.preventDefault())},"normal.dblclick":function(a){a.getTargetNode()||this.execCommand("camera",this.getRoot())}}}});var o=f.Geometry,p=a.createClass("AreaAnimator",{base:a.Animator,constructor:function(a,b){a.opacity=0,b.opacity=.8,this.callBase(a,b,function(a,b){a.setPosition(b.x,b.y),a.setSize(b.width,b.height),a.setOpacity(b.opacity)})}}),q=a.createClass("MoveToParentCommand",{base:h,execute:function(a,b,c){for(var d,e=b.length-1;e>=0;e--)d=b[e],d.getParent()&&(d.getParent().removeChild(d),c.appendChild(d));a.initStyle(a.getRoot()),a.select(b,!0)}}),r=a.createClass("DragBox",{base:a.Group,constructor:function(a){this.callBase(),this._minder=a,this._draw()},_draw:function(){this._rect=(new a.Rect).setRadius(5).fill("white").stroke("#3399ff",1),this._text=(new a.Text).setSize(14).setTextAnchor("middle").fill("black").setStyle("cursor","default"),this.addShapes([this._rect,this._text])},_calcDragSources:function(){this._dragSources=this._minder.getSelectedAncestors()},_calcDropTargets:function(){function a(b,c){var d,e=[];return e.push(c),c.getChildren().forEach(function(c){for(d=0;d<b.length;d++)if(b[d]==c)return;e=e.concat(a(b,c))}),e}this._dropTargets=a(this._dragSources,this._minder.getRoot()),this._dropTargetBoxes=this._dropTargets.map(e)},_enterDragMode:function(){return this._calcDragSources(),this._dragSources.length?(this._calcDropTargets(),this._drawForDragMode(),this._shrink(),this._dragMode=!0,!0):(this._startPosition=null,!1)},_leaveDragMode:function(){this.remove(),this._dragMode=!1,this._dropSucceedTarget=null},_drawForDragMode:function(){this._text.setContent(this._dragSources.length+" items"),this._text.setPosition(this._startPosition.x,this._startPosition.y+5),this._minder.getPaper().addShape(this)},_shrink:function(){function a(a){for(var b=a.pop();a.length;)b=o.mergeBox(b,a.pop());return{x:b.left,y:b.top,width:b.width,height:b.height}}function b(a){var b=80,c=30;return{x:a.x-b/2,y:a.y-c/2,width:b,height:c}}var c=a(this._dragSources.map(e)),d=b(this._startPosition),f=new p(c,d);f.start(this._rect,400,"easeOutQuint")},_dropTest:function(){var a,b=this.getRenderBox();this._dropSucceedTarget=null;for(var c=0;c<this._dropTargetBoxes.length;c++)if(a=this._dropTargetBoxes[c],o.isBoxIntersect(b,a))return void(this._dropSucceedTarget=this._dropTargets[c])},_updateDropHint:function(){var a=this._dropSucceedTarget,b=this._lastSucceedTarget;a&&a==b||(b&&this._removeDropStyle(b),a&&this._addDropStyle(a),this._lastSucceedTarget=a)},_removeDropStyle:function(a){a._layout.bgRect.stroke("none"),this._rect.stroke("#3399ff",1)},_addDropStyle:function(a){a._layout.bgRect.stroke("rgb(254, 219, 0)",3),a.getRenderContainer().fxScale(1.25,1.25,150,"ease").fxScale(.8,.8,150,"ease")},dragStart:function(a){this._startPosition=a},dragMove:function(b){var c=10;if(this._startPosition){if(this._dragPosition=b,!this._dragMode){if(o.getDistance(this._dragPosition,this._startPosition)<c)return;if(!this._enterDragMode())return}var d=a.Vector.fromPoints(this._startPosition,this._dragPosition);this.setTransform((new a.Matrix).translate(d.x,d.y)),this._dropTest(),this._updateDropHint()}},dragEnd:function(){this._startPosition=null,this._dragMode&&(this._dropSucceedTarget&&this._minder.execCommand("movetoparent",this._dragSources,this._dropSucceedTarget),this._leaveDragMode())}});f.registerModule("DragTree",function(){return{init:function(){this._dragBox=new r(this)},events:{mousedown:function(a){a.getTargetNode()&&a.getTargetNode()!=this.getRoot()&&this._dragBox.dragStart(a.getPosition())},mousemove:function(a){this._dragBox.dragMove(a.getPosition())},mouseup:function(){this._dragBox.dragEnd()}},commands:{movetoparent:q}}}),f.registerModule("DropFile",function(){function a(){var a=this.getPaper().getContainer();a.addEventListener("dragover",b),a.addEventListener("drop",c.bind(this))}function b(a){a.preventDefault(),a.stopPropagation(),a.dataTransfer.dropEffect="copy"}function c(a){a.preventDefault(),a.stopPropagation();var b=this;if(a.dataTransfer.files){var c=new FileReader;c.onload=function(a){b.importData(a.target.result)},c.readAsText(a.dataTransfer.files[0])}}return{events:{ready:a}}}),f.registerModule("KeyboardModule",function(){function b(a){var b,c=[];a.traverse(function(a){b=a.getRenderContainer().getRenderBox("top"),c.push({x:b.x+b.width/2,y:b.y+b.height/2,node:a})});for(var e=0;e<c.length;e++)d(c,e)}function c(a){return a.x>0?a.y>0?1:2:a.y<0?3:4}function d(b,d){for(var e,f,g=b[d],h=(new a.Matrix).translate(-g.x,-g.y).rotate(45),i={},j=0;j<b.length;j++)j!=d&&(f=h.transformPoint(b[j].x,b[j].y),e=c(f),(!i[e]||f.length()<i[e].point.length())&&(i[e]={point:f,node:b[j].node}));g.node._nearestNodes={right:i[1]&&i[1].node||null,top:i[2]&&i[2].node||null,left:i[3]&&i[3].node||null,down:i[4]&&i[4].node||null}}function e(a,c){var d=a.getSelectedNode();if(!d)return a.select(a.getRoot()),void b(a.getRoot());var e=d._nearestNodes[c];e&&a.select(e,!0)}return{events:{contentchange:function(){b(this.getRoot())},"normal.keydown":function(a){var b=f.keymap,c=a.getTargetNode();switch(this.receiver.keydownNode=c,a.originEvent.keyCode){case b.Enter:this.execCommand("appendSiblingNode",new i(this.getLang().topic)),a.preventDefault();break;case b.Tab:this.execCommand("appendChildNode",new i(this.getLang().topic)),a.preventDefault();break;case b.Backspace:case b.Del:this.execCommand("removenode"),a.preventDefault();break;case b.Left:e(this,"left"),a.preventDefault();break;case b.Up:e(this,"top"),a.preventDefault();break;case b.Right:e(this,"right"),a.preventDefault();break;case b.Down:e(this,"down"),a.preventDefault()}}}}}),f.registerModule("Select",function(){var b=this,c=f.Geometry,d=function(){var d=null,e=(new a.Path).fill("rgba(255,255,255,.3)").stroke("white"),f=!1,g=10;return{selectStart:function(a){return a.originEvent.button?void 0:d?this.selectEnd():void(d=c.snapToSharp(a.getPosition()))},selectMove:function(a){if(!b.isTextEditStatus()&&d){var h=d,i=a.getPosition();if(!f){if(c.getDistance(h,i)<g)return;f=!0,b.getPaper().addShape(e),e.setOpacity(.8).getDrawer().clear()}var j=c.getBox(h,i),k=[];c.snapToSharp(j),e.getDrawer().pipe(function(){this.clear(),this.moveTo(j.left,j.top),this.lineTo(j.right,j.top),this.lineTo(j.right,j.bottom),this.lineTo(j.left,j.bottom),this.close()}),b.getRoot().traverse(function(a){var b=a.getRenderContainer().getRenderBox("top");c.isBoxIntersect(b,j)&&k.push(a)}),b.select(k,!0)}},selectEnd:function(){d&&(d=null),f&&(e.fadeOut(200,"ease",0,function(){e.remove&&e.remove()}),f=!1)}}}(),e=null;return{events:{"normal.mousedown textedit.mousedown":function(a){var b=a.getTargetNode();b?a.originEvent.shiftKey?this.toggleSelect(b):b.isSelected()?this.isSingleSelect()||(e=b):this.select(b,!0):(this.removeAllSelectedNodes(),d.selectStart(a),this.setStatus("normal"))},"normal.mousemove textedit.mousemove":d.selectMove,"normal.mouseup textedit.mouseup":function(a){var b=a.getTargetNode();b&&b==e&&(this.select(e,!0),e=null),d.selectEnd(a)}}}}),f.registerModule("TextEditModule",function(){var a=this,b=new k.Selection,c=new k.Receiver(this),d=new k.Range;this.receiver=c;var e,f=!1,g=0,h=1;a.isTextEditStatus=function(){return a.receiver.isTextEditStatus()};var i=!1;return{init:function(){this.getPaper().addShape(b)},events:{"normal.beforemousedown textedit.beforemousedown":function(g){if(g.isRightMB())return void g.stopPropagationImmediately();b.setHide();var h=g.getTargetNode();if(!h){var j=g.kityEvent.targetShape;j&&"Selection"==j.getType()&&(i=!0,h=j.getData("relatedNode"),g.stopPropagationImmediately()),"textedit"==this.getStatus()&&this.fire("contentchange"),a.setStatus("normal")}if(h){var k=h.getTextShape();k.setStyle("cursor","default"),this.isSingleSelect()&&h.isSelected()&&(b.collapse(),h.getTextShape().setStyle("cursor","text"),a.setStatus("textedit"),c.setTextEditStatus(!0).setSelection(b).setKityMinder(this).setMinderNode(h).setTextShape(k).setBaseOffset().setContainerStyle().setSelectionHeight().setCurrentIndex(g.getPosition()).updateSelection().setRange(d),b.setData("relatedNode",h),f=!0,e=g.getPosition(),i&&(b.setShow(),i=!1),a.setStatus("textedit"))}},"normal.mouseup textedit.mouseup":function(a){if(f)if(b.collapsed)b.setShow();else try{c.updateRange(d)}catch(a){console.log(a)}f=!1,g=0},"textedit.beforemousemove":function(a){if(f){a.stopPropagationImmediately();var d=a.getPosition();if(Math.abs(d.y-e.y)>2&&Math.abs(e.x-d.x)<1)return b.setHide(),void(f=!1);h=d.x>e.x?1:d.x<e.x?-1:h,c.updateSelectionByMousePosition(d,h).updateSelectionShow(h),e=a.getPosition()}},"normal.dblclick textedit.dblclick":function(e){var f=e.kityEvent.targetShape;"text"==f.getType().toLowerCase()&&(b.setStartOffset(0),b.setEndOffset(f.getContent().length),b.setShow(),c.setContainerTxt(f.getContent()).updateSelectionShow(1).updateRange(d).setTextEditStatus(!0),a.setStatus("textedit"))},restoreScene:function(){b.setHide()},stopTextEdit:function(){b.setHide(),c.clear().setTextEditStatus(!1),a.setStatus("normal")},resize:function(){b.setHide()},execCommand:function(e){var f={appendchildnode:1,appendsiblingnode:1};if(f[e.commandName]){var g=a.getSelectedNode(),h=g.getTextShape();return h.setStyle("cursor","default"),g.getTextShape().setStyle("cursor","text"),a.setStatus("textedit"),c.setTextEditStatus(!0).setSelection(b).setKityMinder(this).setMinderNode(g).setTextShape(h).setBaseOffset().setContainerStyle().setSelectionHeight().getTextOffsetData().setIndex(0).updateSelection().setRange(d),b.setStartOffset(0),b.setEndOffset(h.getContent().length),b.setShow(),void c.updateSelectionShow(1).updateRange(d)}return"priority"!=e.commandName&&"progress"!=e.commandName||"textedit"!=this.getStatus()?(c.clear().setTextEditStatus(!1),void("textedit"==this.getStatus()&&this.setStatus("normal"))):(c.setBaseOffset().getTextOffsetData(),void(b.collapsed?c.updateSelection():c.updateSelectionShow(1)))},selectionclear:function(){a.setStatus("normal"),c.setTextEditStatus(!1).clear()}}}}),k.Range=a.createClass("Range",{constructor:function(){this.nativeRange=document.createRange(),this.nativeSel=b.getSelection()},select:function(){var a=this.nativeRange.startContainer;if(1==a.nodeType&&0==a.childNodes.length){var b=document.createTextNode("");a.appendChild(b),this.nativeRange.setStart(b,1),this.nativeRange.collapse(!0)}return this.nativeSel.removeAllRanges(),this.nativeSel.addRange(this.nativeRange),this},setStart:function(a,b){try{this.nativeRange.setStart(a,b)}catch(c){console.log(c)}return this},setEnd:function(a,b){return this.nativeRange.setEnd(a,b),this},getStart:function(){var a=this.nativeSel.getRangeAt(0);return{startContainer:a.startContainer,startOffset:a.startOffset}},collapse:function(a){return this.nativeRange.collapse(a===!0),this},insertNode:function(a){return this.nativeRange.insertNode(a),this},updateNativeRange:function(){return this.nativeRange=this.nativeSel.getRangeAt(0),this}}),k.Receiver=a.createClass("Receiver",{clear:function(){return this.container.innerHTML="",this.selection&&this.selection.setHide(),this.range&&this.range.nativeSel.removeAllRanges(),this.index=0,this.inputLength=0,this},setTextEditStatus:function(a){return this.textEditStatus=a||!1,this},isTextEditStatus:function(){return this.textEditStatus},constructor:function(a){this.setKityMinder(a),this.textEditStatus=!1;var b=document.createElement("div");b.setAttribute("contenteditable",!0),b.className="km_receiver",this.container=document.body.insertBefore(b,document.body.firstChild),g.addCssRule("km_receiver_css"," .km_receiver{position:absolute;padding:0;margin:0;word-wrap:break-word;clip:rect(1em 1em 1em 1em);}"),this.km.on("textedit.beforekeyup textedit.keydown textedit.paste",g.proxy(this.keyboardEvents,this)),this.timer=null,this.index=0
},setRange:function(a,b){this.index=b||this.index;var c=this.container.firstChild;this.range=a,a.setStart(c||this.container,this.index).collapse(!0);var d=this;return setTimeout(function(){d.container.focus(),a.select()}),this},setTextShape:function(b){return b||(b=new a.Text),this.textShape=b,this.container.innerHTML=b.getContent(),this},setTextShapeSize:function(a){return this.textShape.setSize(a),this},getTextShapeHeight:function(){return this.textShape.getRenderBox().height},appendTextShapeToPaper:function(a){return a.addShape(this.textShape),this},setKityMinder:function(a){return this.km=a,this},setMinderNode:function(a){return this.minderNode=a,this},keyboardEvents:function(a){function b(){var a=c.container.textContent.replace(/[\u200b\t\r\n]/g,"");0==c.textShape.getOpacity()&&c.textShape.setOpacity(1),c.textShape.setContent(a),c.setContainerStyle(),c.minderNode.setText(a),0==a.length&&(c.textShape.setContent("a"),c.textShape.setOpacity(0)),c.km.updateLayout(c.minderNode),c.setBaseOffset(),c.updateTextData(),c.updateIndex(),c.updateSelection(),c.timer=setTimeout(function(){c.selection.setShow()},500)}clearTimeout(this.timer);var c=this,d=a.originEvent,e=d.keyCode,g=f.keymap;switch(a.type){case"keydown":switch(a.originEvent.keyCode){case g.Enter:case g.Tab:this.selection.setHide(),this.clear().setTextEditStatus(!1),this.km.fire("contentchange"),this.km.setStatus("normal"),a.preventDefault()}if(a.originEvent.ctrlKey||a.originEvent.metaKey)return e==m.v&&setTimeout(function(){c.range.updateNativeRange().insertNode($("<span>$$_kityminder_bookmark_$$</span>")[0]),c.container.innerHTML=c.container.textContent.replace(/[\u200b\t\r\n]/g,"");var a=c.container.textContent.indexOf("$$_kityminder_bookmark_$$");c.container.textContent=c.container.textContent.replace("$$_kityminder_bookmark_$$",""),c.range.setStart(c.container.firstChild,a).collapse(!0).select(),b()},100),void(e==m.x&&setTimeout(function(){b()},100));break;case"beforekeyup":switch(e){case m.Enter:case m.Tab:return this.keydownNode===this.minderNode&&(this.rollbackStatus(),this.setTextEditStatus(!1),this.clear()),void a.preventDefault();case m.Shift:case m.Control:case m.Alt:case m.Cmd:return}return b(),!0}},updateIndex:function(){this.index=this.range.getStart().startOffset},updateTextData:function(){this.textShape.textData=this.getTextOffsetData()},setSelection:function(a){return this.selection=a,this},updateSelection:function(){return this.selection.setShowHold(),this.selection.bringTop(),this.selection.setStartOffset(this.index).collapse(!0),this.selection.setPosition(this.index==this.textData.length?0==this.index?this.getBaseOffset():{x:this.textData[this.index-1].x+this.textData[this.index-1].width,y:this.textData[this.index-1].y}:this.textData[this.index]),this},getBaseOffset:function(){return this.textShape.getRenderBox("top")},setBaseOffset:function(){return this.offset=this.textShape.getRenderBox("top"),this},setContainerStyle:function(){var a=this.textShape.getRenderBox();return this.container.style.cssText=";left:"+this.offset.x+"px;top:"+(this.offset.y+a.height)+"px;width:"+a.width+"px;height:"+a.height+"px;",this},getTextOffsetData:function(){var a=this.textShape.getContent();this.textData=[];for(var b=0,c=a.length;c>b;b++){var d=this.textShape.getExtentOfChar(b);this.textData.push({x:d.x+this.offset.x,y:this.offset.y,width:d.width,height:d.height})}return this},setCurrentIndex:function(a){var b=this;this.getTextOffsetData();var c=!1;return g.each(this.textData,function(d,e){return 0==d&&a.x<=e.x?(b.index=0,!1):d==b.textData.length-1&&a.x>=e.x?(b.index=b.textData.length,!1):a.x>=e.x&&a.x<=e.x+e.width?(b.index=a.x-e.x>e.width/2?d+1:d,c=!0,!1):void 0}),this},setSelectionHeight:function(){return this.selection.setHeight(this.getTextShapeHeight()),this},updateSelectionByMousePosition:function(a,b){var c=this;return g.each(this.textData,function(d,e){return 0==d&&a.x<=e.x?(c.selection.setStartOffset(0),!1):d==c.textData.length-1&&a.x>=e.x?(c.selection.setEndOffset(c.textData.length),!1):a.x>=e.x&&a.x<=e.x+e.width?(c.index==d?(0==d&&c.selection.setStartOffset(d),a.x<=e.x+e.width/2?c.selection.collapse():c.selection.setEndOffset(d+(c.selection.endOffset>d||1==b?1:0))):d>c.index?(c.selection.setStartOffset(c.index),c.selection.setEndOffset(d+1)):(c.selection.setStartOffset(1==b?d+(a.x>=e.x+e.width/2?1:0):d),c.selection.setEndOffset(c.index)),!1):void 0}),this},updateSelectionShow:function(){var a=this.textData[this.selection.startOffset],b=this.textData[this.selection.endOffset],c=0;if(this.selection.collapsed)return this.selection.updateShow(a||this.textData[this.textData.length-1],0),this;if(b)c=b.x-a.x;else{var d=this.textData[this.textData.length-1];c=d.x-a.x+d.width}return this.selection.updateShow(a,c),this},updateRange:function(a){var b=this.container.firstChild;return a.setStart(b,this.selection.startOffset),a.setEnd(b,this.selection.endOffset),a.select(),this},setIndex:function(a){return this.index=a,this},setContainerTxt:function(a){return this.container.textContent=a,this}}),k.Selection=a.createClass("Selection",{base:a.Rect,constructor:function(a,b,c){this.callBase(),this.height=a||20,this.stroke(b||"rgb(27,171,255)",c||1),this.width=0,this.fill("rgb(27,171,255)"),this.setHide(),this.timer=null,this.collapsed=!0,this.startOffset=this.endOffset=0,this.setOpacity(.5),this.setStyle("cursor","text")},collapse:function(a){return this.stroke("rgb(27,171,255)",1),this.setOpacity(1),this.width=1,this.collapsed=!0,a?this.startOffset=this.endOffset:this.endOffset=this.startOffset,this},setStartOffset:function(a){this.startOffset=a;var b=this.startOffset;if(this.startOffset>this.endOffset)this.startOffset=this.endOffset,this.endOffset=b;else if(this.startOffset==this.endOffset)return this.collapse(),this;return this.collapsed=!1,this.stroke("none",0),this.setOpacity(.5),this},setEndOffset:function(a){this.endOffset=a;var b=this.endOffset;if(this.endOffset<this.startOffset)this.endOffset=this.startOffset,this.startOffset=b;else if(this.startOffset==this.endOffset)return this.collapse(),this;return this.collapsed=!1,this.stroke("none",0),this.setOpacity(.5),this},updateShow:function(a,b){return b&&this.setShowHold(),this.setPosition(a).setWidth(b),this.setOpacity(0==b?0:.5),this},setPosition:function(a){try{this.x=a.x,this.y=a.y}catch(b){console.log(b)}return this.update()},setHeight:function(a){this.height=a},setHide:function(){return clearInterval(this.timer),this.setStyle("display","none"),this},setShowHold:function(){return clearInterval(this.timer),this.setStyle("display",""),this},setShow:function(){clearInterval(this.timer);var a=this,b="";return this.collapsed?this.timer=setInterval(function(){a.setStyle("display",b),b=b?"":"none"},300):a.setStyle("display",""),this},setTextShape:function(b){return this.text=b?b:new a.Text,this},getTextShape:function(){return this.text},setTxtContent:function(a){this.text.setContent(a)},updatePosition:function(){}}),f.registerModule("basestylemodule",function(){var b=this;return{commands:{bold:a.createClass("boldCommand",{base:h,execute:function(){var a=b.getSelectedNodes();1==this.queryState("bold")?g.each(a,function(a,c){c.setData("bold"),c.getTextShape().setAttr("font-weight"),b.updateLayout(c)}):g.each(a,function(a,c){c.setData("bold",!0),c.getTextShape().setAttr("font-weight","bold"),b.updateLayout(c)})},queryState:function(){var a=b.getSelectedNodes(),c=0;return 0==a.length?-1:(g.each(a,function(a,b){return b.getData("bold")?(c=1,!1):void 0}),c)}}),italic:a.createClass("italicCommand",{base:h,execute:function(){var a=b.getSelectedNodes();1==this.queryState("italic")?g.each(a,function(a,c){c.setData("italic"),c.getTextShape().setAttr("font-style"),b.updateLayout(c)}):g.each(a,function(a,c){c.setData("italic",!0),c.getTextShape().setAttr("font-style","italic"),b.updateLayout(c)})},queryState:function(){var a=b.getSelectedNodes(),c=0;return 0==a.length?-1:(g.each(a,function(a,b){return b.getData("italic")?(c=1,!1):void 0}),c)}})},addShortcutKeys:{bold:"ctrl+b",italic:"ctrl+i"},events:{beforeRenderNode:function(a){a.node.getData("bold")&&a.node.getTextShape().setAttr("font-weight","bold"),a.node.getData("italic")&&a.node.getTextShape().setAttr("font-style","italic")}}}}),f.registerModule("fontmodule",function(){return{defaultOptions:{fontfamily:[{name:"songti",val:",SimSun"},{name:"yahei",val:",Microsoft YaHei"},{name:"kaiti",val:",_GB2312, SimKai"},{name:"heiti",val:", SimHei"},{name:"lishu",val:", SimLi"},{name:"andaleMono",val:"andale mono"},{name:"arial",val:"arial, helvetica,sans-serif"},{name:"arialBlack",val:"arial black,avant garde"},{name:"comicSansMs",val:"comic sans ms"},{name:"impact",val:"impact,chicago"},{name:"timesNewRoman",val:"times new roman"},{name:"sans-serif",val:"sans-serif"}],fontsize:[10,12,16,18,24,32,48]},commands:{forecolor:a.createClass("fontcolorCommand",{base:h,execute:function(a,b){var c=a.getSelectedNodes();g.each(c,function(a,c){c.setData("fontcolor",b),c.getTextShape().fill(b)})},queryState:function(a){return 0==a.getSelectedNodes().length?-1:0}}),fontfamily:a.createClass("fontfamilyCommand",{base:h,execute:function(a,b){var c=a.getSelectedNodes();g.each(c,function(c,d){d.setData("fontfamily",b),d.getTextShape().setAttr("font-family",b),a.updateLayout(d)})},queryState:function(a){return 0==a.getSelectedNodes().length?-1:0}}),fontsize:a.createClass("fontsizeCommand",{base:h,execute:function(a,b){var c=a.getSelectedNodes();g.each(c,function(c,d){d.setData("fontsize",b),d.getTextShape().setSize(b),a.updateLayout(d)})},queryState:function(a){return 0==a.getSelectedNodes().length?-1:0}})},events:{beforeRenderNode:function(a){var b;(b=a.node.getData("fontfamily"))&&a.node.getTextShape().setAttr("font-family",b),(b=a.node.getData("fontcolor"))&&a.node.getTextShape().fill(b),(b=a.node.getData("fontsize"))&&a.node.getTextShape().setSize(b)}}}}),f.registerModule("Zoom",function(){function b(b,c){var d=b.getPaper(),e=d.getViewBox(),f=b._zoomValue,g=e.width,h=e.height,i=e.x,j=e.y,k=g*c,l=h*c,m=i+(g-k)/2,n=j+(h-l)/2,o=new a.Animator({beginValue:e,finishValue:{width:k,height:l,x:m,y:n},setter:function(a,b){a.setViewBox(b.x,b.y,b.width,b.height)}});o.start(d,500,"ease"),b._zoomValue=f*=c}var c=2,d=a.Browser.chrome?1:.5,e=Math.sqrt(2),f=a.createClass("ZoomInCommand",{base:h,execute:function(a){this.queryState(a)||b(a,1/e)},queryState:function(a){return a._zoomValue>1/c?0:-1}}),g=a.createClass("ZoomOutCommand",{base:h,execute:function(a){this.queryState(a)||b(a,e)},queryState:function(a){return a._zoomValue<1/d?0:-1}});return{commands:{"zoom-in":f,"zoom-out":g},events:{"normal.keydown":function(a){var b=this,c=a.originEvent,d=c.keyCode||c.which;m["="]==d&&b.execCommand("zoom-in"),m["-"]==d&&b.execCommand("zoom-out")},ready:function(){this._zoomValue=1},"normal.mousewheel":function(b){if(b.originEvent.ctrlKey){var c=b.originEvent.wheelDelta,d=this;a.Browser.mac||(c=-c),Math.abs(c)>100&&(clearTimeout(this._wheelZoomTimeout),this._wheelZoomTimeout=setTimeout(function(){d.getPaper()._zoom||1;0>c?d.execCommand("zoom-in"):c>0&&d.execCommand("zoom-out")},100),b.originEvent.preventDefault())}}}}}),function(a,b){function c(b,c){var e,f,g,h=b.nodeName.toLowerCase();return"area"===h?(e=b.parentNode,f=e.name,b.href&&f&&"map"===e.nodeName.toLowerCase()?(g=a("img[usemap=#"+f+"]")[0],!!g&&d(g)):!1):(/input|select|textarea|button|object/.test(h)?!b.disabled:"a"===h?b.href||c:c)&&d(b)}function d(b){return a.expr.filters.visible(b)&&!a(b).parents().addBack().filter(function(){return"hidden"===a.css(this,"visibility")}).length}var e=0,f=/^ui-id-\d+$/;a.ui=a.ui||{},a.extend(a.ui,{version:"1.10.4",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),a.fn.extend({focus:function(b){return function(c,d){return"number"==typeof c?this.each(function(){var b=this;setTimeout(function(){a(b).focus(),d&&d.call(b)},c)}):b.apply(this,arguments)}}(a.fn.focus),scrollParent:function(){var b;return b=a.ui.ie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?this.parents().filter(function(){return/(relative|absolute|fixed)/.test(a.css(this,"position"))&&/(auto|scroll)/.test(a.css(this,"overflow")+a.css(this,"overflow-y")+a.css(this,"overflow-x"))}).eq(0):this.parents().filter(function(){return/(auto|scroll)/.test(a.css(this,"overflow")+a.css(this,"overflow-y")+a.css(this,"overflow-x"))}).eq(0),/fixed/.test(this.css("position"))||!b.length?a(document):b},zIndex:function(c){if(c!==b)return this.css("zIndex",c);if(this.length)for(var d,e,f=a(this[0]);f.length&&f[0]!==document;){if(d=f.css("position"),("absolute"===d||"relative"===d||"fixed"===d)&&(e=parseInt(f.css("zIndex"),10),!isNaN(e)&&0!==e))return e;f=f.parent()}return 0},uniqueId:function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++e)})},removeUniqueId:function(){return this.each(function(){f.test(this.id)&&a(this).removeAttr("id")})}}),a.extend(a.expr[":"],{data:a.expr.createPseudo?a.expr.createPseudo(function(b){return function(c){return!!a.data(c,b)}}):function(b,c,d){return!!a.data(b,d[3])},focusable:function(b){return c(b,!isNaN(a.attr(b,"tabindex")))},tabbable:function(b){var d=a.attr(b,"tabindex"),e=isNaN(d);return(e||d>=0)&&c(b,!e)}}),a("<a>").outerWidth(1).jquery||a.each(["Width","Height"],function(c,d){function e(b,c,d,e){return a.each(f,function(){c-=parseFloat(a.css(b,"padding"+this))||0,d&&(c-=parseFloat(a.css(b,"border"+this+"Width"))||0),e&&(c-=parseFloat(a.css(b,"margin"+this))||0)}),c}var f="Width"===d?["Left","Right"]:["Top","Bottom"],g=d.toLowerCase(),h={innerWidth:a.fn.innerWidth,innerHeight:a.fn.innerHeight,outerWidth:a.fn.outerWidth,outerHeight:a.fn.outerHeight};a.fn["inner"+d]=function(c){return c===b?h["inner"+d].call(this):this.each(function(){a(this).css(g,e(this,c)+"px")})},a.fn["outer"+d]=function(b,c){return"number"!=typeof b?h["outer"+d].call(this,b):this.each(function(){a(this).css(g,e(this,b,!0,c)+"px")})}}),a.fn.addBack||(a.fn.addBack=function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}),a("<a>").data("a-b","a").removeData("a-b").data("a-b")&&(a.fn.removeData=function(b){return function(c){return arguments.length?b.call(this,a.camelCase(c)):b.call(this)}}(a.fn.removeData)),a.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()),a.support.selectstart="onselectstart"in document.createElement("div"),a.fn.extend({disableSelection:function(){return this.bind((a.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(a){a.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),a.extend(a.ui,{plugin:{add:function(b,c,d){var e,f=a.ui[b].prototype;for(e in d)f.plugins[e]=f.plugins[e]||[],f.plugins[e].push([c,d[e]])},call:function(a,b,c){var d,e=a.plugins[b];if(e&&a.element[0].parentNode&&11!==a.element[0].parentNode.nodeType)for(d=0;e.length>d;d++)a.options[e[d][0]]&&e[d][1].apply(a.element,c)}},hasScroll:function(b,c){if("hidden"===a(b).css("overflow"))return!1;var d=c&&"left"===c?"scrollLeft":"scrollTop",e=!1;return b[d]>0?!0:(b[d]=1,e=b[d]>0,b[d]=0,e)}})}(jQuery),function(a,b){var c=0,d=Array.prototype.slice,e=a.cleanData;a.cleanData=function(b){for(var c,d=0;null!=(c=b[d]);d++)try{a(c).triggerHandler("remove")}catch(f){}e(b)},a.widget=function(c,d,e){var f,g,h,i,j={},k=c.split(".")[0];c=c.split(".")[1],f=k+"-"+c,e||(e=d,d=a.Widget),a.expr[":"][f.toLowerCase()]=function(b){return!!a.data(b,f)},a[k]=a[k]||{},g=a[k][c],h=a[k][c]=function(a,c){return this._createWidget?(arguments.length&&this._createWidget(a,c),b):new h(a,c)},a.extend(h,g,{version:e.version,_proto:a.extend({},e),_childConstructors:[]}),i=new d,i.options=a.widget.extend({},i.options),a.each(e,function(c,e){return a.isFunction(e)?(j[c]=function(){var a=function(){return d.prototype[c].apply(this,arguments)},b=function(a){return d.prototype[c].apply(this,a)};return function(){var c,d=this._super,f=this._superApply;return this._super=a,this._superApply=b,c=e.apply(this,arguments),this._super=d,this._superApply=f,c}}(),b):(j[c]=e,b)}),h.prototype=a.widget.extend(i,{widgetEventPrefix:g?i.widgetEventPrefix||c:c},j,{constructor:h,namespace:k,widgetName:c,widgetFullName:f}),g?(a.each(g._childConstructors,function(b,c){var d=c.prototype;a.widget(d.namespace+"."+d.widgetName,h,c._proto)}),delete g._childConstructors):d._childConstructors.push(h),a.widget.bridge(c,h)},a.widget.extend=function(c){for(var e,f,g=d.call(arguments,1),h=0,i=g.length;i>h;h++)for(e in g[h])f=g[h][e],g[h].hasOwnProperty(e)&&f!==b&&(c[e]=a.isPlainObject(f)?a.isPlainObject(c[e])?a.widget.extend({},c[e],f):a.widget.extend({},f):f);return c},a.widget.bridge=function(c,e){var f=e.prototype.widgetFullName||c;a.fn[c]=function(g){var h="string"==typeof g,i=d.call(arguments,1),j=this;return g=!h&&i.length?a.widget.extend.apply(null,[g].concat(i)):g,this.each(h?function(){var d,e=a.data(this,f);return e?a.isFunction(e[g])&&"_"!==g.charAt(0)?(d=e[g].apply(e,i),d!==e&&d!==b?(j=d&&d.jquery?j.pushStack(d.get()):d,!1):b):a.error("no such method '"+g+"' for "+c+" widget instance"):a.error("cannot call methods on "+c+" prior to initialization; attempted to call method '"+g+"'")}:function(){var b=a.data(this,f);b?b.option(g||{})._init():a.data(this,f,new e(g,this))}),j}},a.Widget=function(){},a.Widget._childConstructors=[],a.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:!1,create:null},_createWidget:function(b,d){d=a(d||this.defaultElement||this)[0],this.element=a(d),this.uuid=c++,this.eventNamespace="."+this.widgetName+this.uuid,this.options=a.widget.extend({},this.options,this._getCreateOptions(),b),this.bindings=a(),this.hoverable=a(),this.focusable=a(),d!==this&&(a.data(d,this.widgetFullName,this),this._on(!0,this.element,{remove:function(a){a.target===d&&this.destroy()}}),this.document=a(d.style?d.ownerDocument:d.document||d),this.window=a(this.document[0].defaultView||this.document[0].parentWindow)),this._create(),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:a.noop,_getCreateEventData:a.noop,_create:a.noop,_init:a.noop,destroy:function(){this._destroy(),this.element.unbind(this.eventNamespace).removeData(this.widgetName).removeData(this.widgetFullName).removeData(a.camelCase(this.widgetFullName)),this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled ui-state-disabled"),this.bindings.unbind(this.eventNamespace),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")},_destroy:a.noop,widget:function(){return this.element},option:function(c,d){var e,f,g,h=c;if(0===arguments.length)return a.widget.extend({},this.options);if("string"==typeof c)if(h={},e=c.split("."),c=e.shift(),e.length){for(f=h[c]=a.widget.extend({},this.options[c]),g=0;e.length-1>g;g++)f[e[g]]=f[e[g]]||{},f=f[e[g]];if(c=e.pop(),1===arguments.length)return f[c]===b?null:f[c];f[c]=d}else{if(1===arguments.length)return this.options[c]===b?null:this.options[c];h[c]=d}return this._setOptions(h),this},_setOptions:function(a){var b;for(b in a)this._setOption(b,a[b]);return this},_setOption:function(a,b){return this.options[a]=b,"disabled"===a&&(this.widget().toggleClass(this.widgetFullName+"-disabled ui-state-disabled",!!b).attr("aria-disabled",b),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")),this},enable:function(){return this._setOption("disabled",!1)},disable:function(){return this._setOption("disabled",!0)},_on:function(c,d,e){var f,g=this;"boolean"!=typeof c&&(e=d,d=c,c=!1),e?(d=f=a(d),this.bindings=this.bindings.add(d)):(e=d,d=this.element,f=this.widget()),a.each(e,function(e,h){function i(){return c||g.options.disabled!==!0&&!a(this).hasClass("ui-state-disabled")?("string"==typeof h?g[h]:h).apply(g,arguments):b}"string"!=typeof h&&(i.guid=h.guid=h.guid||i.guid||a.guid++);var j=e.match(/^(\w+)\s*(.*)$/),k=j[1]+g.eventNamespace,l=j[2];l?f.delegate(l,k,i):d.bind(k,i)})},_off:function(a,b){b=(b||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,a.unbind(b).undelegate(b)},_delay:function(a,b){function c(){return("string"==typeof a?d[a]:a).apply(d,arguments)}var d=this;return setTimeout(c,b||0)},_hoverable:function(b){this.hoverable=this.hoverable.add(b),this._on(b,{mouseenter:function(b){a(b.currentTarget).addClass("ui-state-hover")},mouseleave:function(b){a(b.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(b){this.focusable=this.focusable.add(b),this._on(b,{focusin:function(b){a(b.currentTarget).addClass("ui-state-focus")},focusout:function(b){a(b.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(b,c,d){var e,f,g=this.options[b];if(d=d||{},c=a.Event(c),c.type=(b===this.widgetEventPrefix?b:this.widgetEventPrefix+b).toLowerCase(),c.target=this.element[0],f=c.originalEvent)for(e in f)e in c||(c[e]=f[e]);return this.element.trigger(c,d),!(a.isFunction(g)&&g.apply(this.element[0],[c].concat(d))===!1||c.isDefaultPrevented())}},a.each({show:"fadeIn",hide:"fadeOut"},function(b,c){a.Widget.prototype["_"+b]=function(d,e,f){"string"==typeof e&&(e={effect:e});var g,h=e?e===!0||"number"==typeof e?c:e.effect||c:b;e=e||{},"number"==typeof e&&(e={duration:e}),g=!a.isEmptyObject(e),e.complete=f,e.delay&&d.delay(e.delay),g&&a.effects&&a.effects.effect[h]?d[b](e):h!==b&&d[h]?d[h](e.duration,e.easing,f):d.queue(function(c){a(this)[b](),f&&f.call(d[0]),c()})}})}(jQuery),function(a){var b=!1;a(document).mouseup(function(){b=!1}),a.widget("ui.mouse",{version:"1.10.4",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var b=this;this.element.bind("mousedown."+this.widgetName,function(a){return b._mouseDown(a)}).bind("click."+this.widgetName,function(c){return!0===a.data(c.target,b.widgetName+".preventClickEvent")?(a.removeData(c.target,b.widgetName+".preventClickEvent"),c.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&a(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(c){if(!b){this._mouseStarted&&this._mouseUp(c),this._mouseDownEvent=c;var d=this,e=1===c.which,f="string"==typeof this.options.cancel&&c.target.nodeName?a(c.target).closest(this.options.cancel).length:!1;return e&&!f&&this._mouseCapture(c)?(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){d.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(c)&&this._mouseDelayMet(c)&&(this._mouseStarted=this._mouseStart(c)!==!1,!this._mouseStarted)?(c.preventDefault(),!0):(!0===a.data(c.target,this.widgetName+".preventClickEvent")&&a.removeData(c.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(a){return d._mouseMove(a)},this._mouseUpDelegate=function(a){return d._mouseUp(a)},a(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),c.preventDefault(),b=!0,!0)):!0}},_mouseMove:function(b){return a.ui.ie&&(!document.documentMode||9>document.documentMode)&&!b.button?this._mouseUp(b):this._mouseStarted?(this._mouseDrag(b),b.preventDefault()):(this._mouseDistanceMet(b)&&this._mouseDelayMet(b)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,b)!==!1,this._mouseStarted?this._mouseDrag(b):this._mouseUp(b)),!this._mouseStarted)},_mouseUp:function(b){return a(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,b.target===this._mouseDownEvent.target&&a.data(b.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(b)),!1},_mouseDistanceMet:function(a){return Math.max(Math.abs(this._mouseDownEvent.pageX-a.pageX),Math.abs(this._mouseDownEvent.pageY-a.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}})}(jQuery),function(a){a.widget("ui.draggable",a.ui.mouse,{version:"1.10.4",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1,drag:null,start:null,stop:null},_create:function(){"original"!==this.options.helper||/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative"),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._mouseInit()},_destroy:function(){this.element.removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._mouseDestroy()},_mouseCapture:function(b){var c=this.options;return this.helper||c.disabled||a(b.target).closest(".ui-resizable-handle").length>0?!1:(this.handle=this._getHandle(b),this.handle?(a(c.iframeFix===!0?"iframe":c.iframeFix).each(function(){a("<div class='ui-draggable-iframeFix' style='background: #fff;'></div>").css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e3}).css(a(this).offset()).appendTo("body")}),!0):!1)},_mouseStart:function(b){var c=this.options;return this.helper=this._createHelper(b),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),a.ui.ddmanager&&(a.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(),this.offsetParent=this.helper.offsetParent(),this.offsetParentCssPosition=this.offsetParent.css("position"),this.offset=this.positionAbs=this.element.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},this.offset.scroll=!1,a.extend(this.offset,{click:{left:b.pageX-this.offset.left,top:b.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.originalPosition=this.position=this._generatePosition(b),this.originalPageX=b.pageX,this.originalPageY=b.pageY,c.cursorAt&&this._adjustOffsetFromHelper(c.cursorAt),this._setContainment(),this._trigger("start",b)===!1?(this._clear(),!1):(this._cacheHelperProportions(),a.ui.ddmanager&&!c.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b),this._mouseDrag(b,!0),a.ui.ddmanager&&a.ui.ddmanager.dragStart(this,b),!0)},_mouseDrag:function(b,c){if("fixed"===this.offsetParentCssPosition&&(this.offset.parent=this._getParentOffset()),this.position=this._generatePosition(b),this.positionAbs=this._convertPositionTo("absolute"),!c){var d=this._uiHash();if(this._trigger("drag",b,d)===!1)return this._mouseUp({}),!1;this.position=d.position}return this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),a.ui.ddmanager&&a.ui.ddmanager.drag(this,b),!1},_mouseStop:function(b){var c=this,d=!1;return a.ui.ddmanager&&!this.options.dropBehaviour&&(d=a.ui.ddmanager.drop(this,b)),this.dropped&&(d=this.dropped,this.dropped=!1),"original"!==this.options.helper||a.contains(this.element[0].ownerDocument,this.element[0])?("invalid"===this.options.revert&&!d||"valid"===this.options.revert&&d||this.options.revert===!0||a.isFunction(this.options.revert)&&this.options.revert.call(this.element,d)?a(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){c._trigger("stop",b)!==!1&&c._clear()}):this._trigger("stop",b)!==!1&&this._clear(),!1):!1},_mouseUp:function(b){return a("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)}),a.ui.ddmanager&&a.ui.ddmanager.dragStop(this,b),a.ui.mouse.prototype._mouseUp.call(this,b)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(b){return this.options.handle?!!a(b.target).closest(this.element.find(this.options.handle)).length:!0},_createHelper:function(b){var c=this.options,d=a.isFunction(c.helper)?a(c.helper.apply(this.element[0],[b])):"clone"===c.helper?this.element.clone().removeAttr("id"):this.element;return d.parents("body").length||d.appendTo("parent"===c.appendTo?this.element[0].parentNode:c.appendTo),d[0]===this.element[0]||/(fixed|absolute)/.test(d.css("position"))||d.css("position","absolute"),d},_adjustOffsetFromHelper:function(b){"string"==typeof b&&(b=b.split(" ")),a.isArray(b)&&(b={left:+b[0],top:+b[1]||0}),"left"in b&&(this.offset.click.left=b.left+this.margins.left),"right"in b&&(this.offset.click.left=this.helperProportions.width-b.right+this.margins.left),"top"in b&&(this.offset.click.top=b.top+this.margins.top),"bottom"in b&&(this.offset.click.top=this.helperProportions.height-b.bottom+this.margins.top)},_getParentOffset:function(){var b=this.offsetParent.offset();return"absolute"===this.cssPosition&&this.scrollParent[0]!==document&&a.contains(this.scrollParent[0],this.offsetParent[0])&&(b.left+=this.scrollParent.scrollLeft(),b.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]===document.body||this.offsetParent[0].tagName&&"html"===this.offsetParent[0].tagName.toLowerCase()&&a.ui.ie)&&(b={top:0,left:0}),{top:b.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:b.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"===this.cssPosition){var a=this.element.position();return{top:a.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:a.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var c,d,e,f=this.options;return f.containment?"window"===f.containment?void(this.containment=[a(b).scrollLeft()-this.offset.relative.left-this.offset.parent.left,a(b).scrollTop()-this.offset.relative.top-this.offset.parent.top,a(b).scrollLeft()+a(b).width()-this.helperProportions.width-this.margins.left,a(b).scrollTop()+(a(b).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]):"document"===f.containment?void(this.containment=[0,0,a(document).width()-this.helperProportions.width-this.margins.left,(a(document).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]):f.containment.constructor===Array?void(this.containment=f.containment):("parent"===f.containment&&(f.containment=this.helper[0].parentNode),d=a(f.containment),e=d[0],void(e&&(c="hidden"!==d.css("overflow"),this.containment=[(parseInt(d.css("borderLeftWidth"),10)||0)+(parseInt(d.css("paddingLeft"),10)||0),(parseInt(d.css("borderTopWidth"),10)||0)+(parseInt(d.css("paddingTop"),10)||0),(c?Math.max(e.scrollWidth,e.offsetWidth):e.offsetWidth)-(parseInt(d.css("borderRightWidth"),10)||0)-(parseInt(d.css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(c?Math.max(e.scrollHeight,e.offsetHeight):e.offsetHeight)-(parseInt(d.css("borderBottomWidth"),10)||0)-(parseInt(d.css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relative_container=d))):void(this.containment=null)
},_convertPositionTo:function(b,c){c||(c=this.position);var d="absolute"===b?1:-1,e="absolute"!==this.cssPosition||this.scrollParent[0]!==document&&a.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent;return this.offset.scroll||(this.offset.scroll={top:e.scrollTop(),left:e.scrollLeft()}),{top:c.top+this.offset.relative.top*d+this.offset.parent.top*d-("fixed"===this.cssPosition?-this.scrollParent.scrollTop():this.offset.scroll.top)*d,left:c.left+this.offset.relative.left*d+this.offset.parent.left*d-("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():this.offset.scroll.left)*d}},_generatePosition:function(b){var c,d,e,f,g=this.options,h="absolute"!==this.cssPosition||this.scrollParent[0]!==document&&a.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,i=b.pageX,j=b.pageY;return this.offset.scroll||(this.offset.scroll={top:h.scrollTop(),left:h.scrollLeft()}),this.originalPosition&&(this.containment&&(this.relative_container?(d=this.relative_container.offset(),c=[this.containment[0]+d.left,this.containment[1]+d.top,this.containment[2]+d.left,this.containment[3]+d.top]):c=this.containment,b.pageX-this.offset.click.left<c[0]&&(i=c[0]+this.offset.click.left),b.pageY-this.offset.click.top<c[1]&&(j=c[1]+this.offset.click.top),b.pageX-this.offset.click.left>c[2]&&(i=c[2]+this.offset.click.left),b.pageY-this.offset.click.top>c[3]&&(j=c[3]+this.offset.click.top)),g.grid&&(e=g.grid[1]?this.originalPageY+Math.round((j-this.originalPageY)/g.grid[1])*g.grid[1]:this.originalPageY,j=c?e-this.offset.click.top>=c[1]||e-this.offset.click.top>c[3]?e:e-this.offset.click.top>=c[1]?e-g.grid[1]:e+g.grid[1]:e,f=g.grid[0]?this.originalPageX+Math.round((i-this.originalPageX)/g.grid[0])*g.grid[0]:this.originalPageX,i=c?f-this.offset.click.left>=c[0]||f-this.offset.click.left>c[2]?f:f-this.offset.click.left>=c[0]?f-g.grid[0]:f+g.grid[0]:f)),{top:j-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.scrollParent.scrollTop():this.offset.scroll.top),left:i-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():this.offset.scroll.left)}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]===this.element[0]||this.cancelHelperRemoval||this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1},_trigger:function(b,c,d){return d=d||this._uiHash(),a.ui.plugin.call(this,b,[c,d]),"drag"===b&&(this.positionAbs=this._convertPositionTo("absolute")),a.Widget.prototype._trigger.call(this,b,c,d)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),a.ui.plugin.add("draggable","connectToSortable",{start:function(b,c){var d=a(this).data("ui-draggable"),e=d.options,f=a.extend({},c,{item:d.element});d.sortables=[],a(e.connectToSortable).each(function(){var c=a.data(this,"ui-sortable");c&&!c.options.disabled&&(d.sortables.push({instance:c,shouldRevert:c.options.revert}),c.refreshPositions(),c._trigger("activate",b,f))})},stop:function(b,c){var d=a(this).data("ui-draggable"),e=a.extend({},c,{item:d.element});a.each(d.sortables,function(){this.instance.isOver?(this.instance.isOver=0,d.cancelHelperRemoval=!0,this.instance.cancelHelperRemoval=!1,this.shouldRevert&&(this.instance.options.revert=this.shouldRevert),this.instance._mouseStop(b),this.instance.options.helper=this.instance.options._helper,"original"===d.options.helper&&this.instance.currentItem.css({top:"auto",left:"auto"})):(this.instance.cancelHelperRemoval=!1,this.instance._trigger("deactivate",b,e))})},drag:function(b,c){var d=a(this).data("ui-draggable"),e=this;a.each(d.sortables,function(){var f=!1,g=this;this.instance.positionAbs=d.positionAbs,this.instance.helperProportions=d.helperProportions,this.instance.offset.click=d.offset.click,this.instance._intersectsWith(this.instance.containerCache)&&(f=!0,a.each(d.sortables,function(){return this.instance.positionAbs=d.positionAbs,this.instance.helperProportions=d.helperProportions,this.instance.offset.click=d.offset.click,this!==g&&this.instance._intersectsWith(this.instance.containerCache)&&a.contains(g.instance.element[0],this.instance.element[0])&&(f=!1),f})),f?(this.instance.isOver||(this.instance.isOver=1,this.instance.currentItem=a(e).clone().removeAttr("id").appendTo(this.instance.element).data("ui-sortable-item",!0),this.instance.options._helper=this.instance.options.helper,this.instance.options.helper=function(){return c.helper[0]},b.target=this.instance.currentItem[0],this.instance._mouseCapture(b,!0),this.instance._mouseStart(b,!0,!0),this.instance.offset.click.top=d.offset.click.top,this.instance.offset.click.left=d.offset.click.left,this.instance.offset.parent.left-=d.offset.parent.left-this.instance.offset.parent.left,this.instance.offset.parent.top-=d.offset.parent.top-this.instance.offset.parent.top,d._trigger("toSortable",b),d.dropped=this.instance.element,d.currentItem=d.element,this.instance.fromOutside=d),this.instance.currentItem&&this.instance._mouseDrag(b)):this.instance.isOver&&(this.instance.isOver=0,this.instance.cancelHelperRemoval=!0,this.instance.options.revert=!1,this.instance._trigger("out",b,this.instance._uiHash(this.instance)),this.instance._mouseStop(b,!0),this.instance.options.helper=this.instance.options._helper,this.instance.currentItem.remove(),this.instance.placeholder&&this.instance.placeholder.remove(),d._trigger("fromSortable",b),d.dropped=!1)})}}),a.ui.plugin.add("draggable","cursor",{start:function(){var b=a("body"),c=a(this).data("ui-draggable").options;b.css("cursor")&&(c._cursor=b.css("cursor")),b.css("cursor",c.cursor)},stop:function(){var b=a(this).data("ui-draggable").options;b._cursor&&a("body").css("cursor",b._cursor)}}),a.ui.plugin.add("draggable","opacity",{start:function(b,c){var d=a(c.helper),e=a(this).data("ui-draggable").options;d.css("opacity")&&(e._opacity=d.css("opacity")),d.css("opacity",e.opacity)},stop:function(b,c){var d=a(this).data("ui-draggable").options;d._opacity&&a(c.helper).css("opacity",d._opacity)}}),a.ui.plugin.add("draggable","scroll",{start:function(){var b=a(this).data("ui-draggable");b.scrollParent[0]!==document&&"HTML"!==b.scrollParent[0].tagName&&(b.overflowOffset=b.scrollParent.offset())},drag:function(c){var d=a(this).data("ui-draggable"),e=d.options,f=!1;d.scrollParent[0]!==document&&"HTML"!==d.scrollParent[0].tagName?(e.axis&&"x"===e.axis||(d.overflowOffset.top+d.scrollParent[0].offsetHeight-c.pageY<e.scrollSensitivity?d.scrollParent[0].scrollTop=f=d.scrollParent[0].scrollTop+e.scrollSpeed:c.pageY-d.overflowOffset.top<e.scrollSensitivity&&(d.scrollParent[0].scrollTop=f=d.scrollParent[0].scrollTop-e.scrollSpeed)),e.axis&&"y"===e.axis||(d.overflowOffset.left+d.scrollParent[0].offsetWidth-c.pageX<e.scrollSensitivity?d.scrollParent[0].scrollLeft=f=d.scrollParent[0].scrollLeft+e.scrollSpeed:c.pageX-d.overflowOffset.left<e.scrollSensitivity&&(d.scrollParent[0].scrollLeft=f=d.scrollParent[0].scrollLeft-e.scrollSpeed))):(e.axis&&"x"===e.axis||(c.pageY-a(document).scrollTop()<e.scrollSensitivity?f=a(document).scrollTop(a(document).scrollTop()-e.scrollSpeed):a(b).height()-(c.pageY-a(document).scrollTop())<e.scrollSensitivity&&(f=a(document).scrollTop(a(document).scrollTop()+e.scrollSpeed))),e.axis&&"y"===e.axis||(c.pageX-a(document).scrollLeft()<e.scrollSensitivity?f=a(document).scrollLeft(a(document).scrollLeft()-e.scrollSpeed):a(b).width()-(c.pageX-a(document).scrollLeft())<e.scrollSensitivity&&(f=a(document).scrollLeft(a(document).scrollLeft()+e.scrollSpeed)))),f!==!1&&a.ui.ddmanager&&!e.dropBehaviour&&a.ui.ddmanager.prepareOffsets(d,c)}}),a.ui.plugin.add("draggable","snap",{start:function(){var b=a(this).data("ui-draggable"),c=b.options;b.snapElements=[],a(c.snap.constructor!==String?c.snap.items||":data(ui-draggable)":c.snap).each(function(){var c=a(this),d=c.offset();this!==b.element[0]&&b.snapElements.push({item:this,width:c.outerWidth(),height:c.outerHeight(),top:d.top,left:d.left})})},drag:function(b,c){var d,e,f,g,h,i,j,k,l,m,n=a(this).data("ui-draggable"),o=n.options,p=o.snapTolerance,q=c.offset.left,r=q+n.helperProportions.width,s=c.offset.top,t=s+n.helperProportions.height;for(l=n.snapElements.length-1;l>=0;l--)h=n.snapElements[l].left,i=h+n.snapElements[l].width,j=n.snapElements[l].top,k=j+n.snapElements[l].height,h-p>r||q>i+p||j-p>t||s>k+p||!a.contains(n.snapElements[l].item.ownerDocument,n.snapElements[l].item)?(n.snapElements[l].snapping&&n.options.snap.release&&n.options.snap.release.call(n.element,b,a.extend(n._uiHash(),{snapItem:n.snapElements[l].item})),n.snapElements[l].snapping=!1):("inner"!==o.snapMode&&(d=p>=Math.abs(j-t),e=p>=Math.abs(k-s),f=p>=Math.abs(h-r),g=p>=Math.abs(i-q),d&&(c.position.top=n._convertPositionTo("relative",{top:j-n.helperProportions.height,left:0}).top-n.margins.top),e&&(c.position.top=n._convertPositionTo("relative",{top:k,left:0}).top-n.margins.top),f&&(c.position.left=n._convertPositionTo("relative",{top:0,left:h-n.helperProportions.width}).left-n.margins.left),g&&(c.position.left=n._convertPositionTo("relative",{top:0,left:i}).left-n.margins.left)),m=d||e||f||g,"outer"!==o.snapMode&&(d=p>=Math.abs(j-s),e=p>=Math.abs(k-t),f=p>=Math.abs(h-q),g=p>=Math.abs(i-r),d&&(c.position.top=n._convertPositionTo("relative",{top:j,left:0}).top-n.margins.top),e&&(c.position.top=n._convertPositionTo("relative",{top:k-n.helperProportions.height,left:0}).top-n.margins.top),f&&(c.position.left=n._convertPositionTo("relative",{top:0,left:h}).left-n.margins.left),g&&(c.position.left=n._convertPositionTo("relative",{top:0,left:i-n.helperProportions.width}).left-n.margins.left)),!n.snapElements[l].snapping&&(d||e||f||g||m)&&n.options.snap.snap&&n.options.snap.snap.call(n.element,b,a.extend(n._uiHash(),{snapItem:n.snapElements[l].item})),n.snapElements[l].snapping=d||e||f||g||m)}}),a.ui.plugin.add("draggable","stack",{start:function(){var b,c=this.data("ui-draggable").options,d=a.makeArray(a(c.stack)).sort(function(b,c){return(parseInt(a(b).css("zIndex"),10)||0)-(parseInt(a(c).css("zIndex"),10)||0)});d.length&&(b=parseInt(a(d[0]).css("zIndex"),10)||0,a(d).each(function(c){a(this).css("zIndex",b+c)}),this.css("zIndex",b+d.length))}}),a.ui.plugin.add("draggable","zIndex",{start:function(b,c){var d=a(c.helper),e=a(this).data("ui-draggable").options;d.css("zIndex")&&(e._zIndex=d.css("zIndex")),d.css("zIndex",e.zIndex)},stop:function(b,c){var d=a(this).data("ui-draggable").options;d._zIndex&&a(c.helper).css("zIndex",d._zIndex)}})}(jQuery),function(a){function c(b,c,d){if(b.prototype=a.extend2(a.extend({},c),(KM.ui[d]||f).prototype,!0),b.prototype.supper=(KM.ui[d]||f).prototype,KM.ui[d]&&KM.ui[d].prototype.defaultOpt){var e=KM.ui[d].prototype.defaultOpt,g=b.prototype.defaultOpt;b.prototype.defaultOpt=a.extend({},e,g||{})}return b}function d(b,c){a[h+c]=b,a.fn[h+c]=function(c){var d,e=Array.prototype.slice.call(arguments,1);return this.each(function(f,g){var h=a(g),i=h.kmui();if(i||(b(c&&a.isPlainObject(c)?c:{},h),h.kmui(i)),"string"==a.type(c))if("this"==c)d=i;else{if(d=i[c].apply(i,e),d!==i&&void 0!==d)return!1;d=null}}),null!==d?d:this}}a.parseTmpl=function(a,b){var c="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/<%=([\s\S]+?)%>/g,function(a,b){return"',"+b.replace(/\\'/g,"'")+",'"}).replace(/<%([\s\S]+?)%>/g,function(a,b){return"');"+b.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",d=new Function("obj",c);return b?d(b):d},a.extend2=function(b){for(var c=arguments,d="boolean"==a.type(c[c.length-1])?c[c.length-1]:!1,e="boolean"==a.type(c[c.length-1])?c.length-1:c.length,f=1;e>f;f++){var g=c[f];for(var h in g)d&&b.hasOwnProperty(h)||(b[h]=g[h])}return b},a.IE6=!!b.ActiveXObject&&6==parseFloat(navigator.userAgent.match(/msie (\d+)/i)[1]);var e=[],f=function(){},h="kmui";f.prototype={on:function(b,c){return this.root().on(b,a.proxy(c,this)),this},off:function(b,c){return this.root().off(b,a.proxy(c,this)),this},trigger:function(a,b){return this.root().trigger(a,b)===!1?!1:this},root:function(a){return this._$el||(this._$el=a)},destroy:function(){},data:function(a,b){return void 0!==b?(this.root().data(h+a,b),this):this.root().data(h+a)},register:function(b,c,d){e.push({evtname:b,$els:a.isArray(c)?c:[c],handler:a.proxy(d,c)})}},a.fn.kmui=function(a){return a?this.data("kmuiwidget",a):this.data("kmuiwidget")};var i=1;KM.ui={define:function(b,e,f){var j=KM.ui[b]=c(function(c,d){var e=function(){};a.extend(e.prototype,j.prototype,{guid:b+i++,widgetName:b});var f=new e;if("string"==a.type(c))return f.init&&f.init({}),f.root().kmui(f),f.root().find("a").click(function(a){a.preventDefault()}),f.root()[h+b].apply(f.root(),arguments);d&&f.root(d),f.init&&f.init(g.clonePlainObject(!c||a.isPlainObject(c)?a.extend2(c||{},f.defaultOpt||{},!0):c));try{f.root().find("a").click(function(a){a.preventDefault()})}catch(k){}return f.root().kmui(f)},e,f);d(j,b)}},a(function(){a(document).on("click mouseup mousedown dblclick mouseover",function(b){a.each(e,function(c,d){d.evtname==b.type&&a.each(d.$els,function(c,e){e[0]===b.target||a.contains(e[0],b.target)||d.handler(b)})})})})}(jQuery),KM.ui.define("button",{tpl:'<<%if(!texttype){%>div class="kmui-btn kmui-btn-<%=icon%> <%if(name){%>kmui-btn-name-<%=name%><%}%>" unselectable="on" onmousedown="return false" <%}else{%>a class="kmui-text-btn"<%}%><% if(title) {%> data-original-title="<%=title%>" <%};%>> <% if(icon) {%><div unselectable="on" class="kmui-icon-<%=icon%> kmui-icon"></div><% }; %><%if(text) {%><span unselectable="on" onmousedown="return false" class="kmui-button-label"><%=text%></span><%}%><%if(caret && text){%><span class="kmui-button-spacing"></span><%}%><% if(caret) {%><span unselectable="on" onmousedown="return false" class="kmui-caret"></span><% };%></<%if(!texttype){%>div<%}else{%>a<%}%>>',defaultOpt:{text:"",title:"",icon:"",width:"",caret:!1,texttype:!1,click:function(){}},init:function(a){var b=this;return b.root($($.parseTmpl(b.tpl,a))).click(function(c){b.wrapclick(a.click,c)}),b.root().hover(function(){b.root().hasClass("kmui-disabled")||b.root().toggleClass("kmui-hover")}),b},wrapclick:function(a,b){return this.disabled()||(this.root().trigger("wrapclick"),$.proxy(a,this,b)()),this},label:function(a){return void 0===a?this.root().find(".kmui-button-label").text():(this.root().find(".kmui-button-label").text(a),this)},disabled:function(a){return void 0===a?this.root().hasClass("kmui-disabled"):(this.root().toggleClass("kmui-disabled",a),this.root().hasClass("kmui-disabled")&&this.root().removeClass("kmui-hover"),this)},active:function(a){return void 0===a?this.root().hasClass("kmui-active"):(this.root().toggleClass("kmui-active",a),this)},mergeWith:function(a){var b=this;b.data("$mergeObj",a),a.kmui().data("$mergeObj",b.root()),$.contains(document.body,a[0])||a.appendTo(b.root()),b.on("click",function(){b.wrapclick(function(){a.kmui().show()})}).register("click",b.root(),function(){a.hide()})}}),function(){KM.ui.define("toolbar",{tpl:'<div class="kmui-toolbar"  ><div class="kmui-btn-toolbar" unselectable="on" onmousedown="return false"  ></div></div>',init:function(){var a=this.root($(this.tpl));this.data("$btnToolbar",a.find(".kmui-btn-toolbar"))},appendToBtnmenu:function(a){var b=this.data("$btnToolbar");a=$.isArray(a)?a:[a],$.each(a,function(a,c){b.append(c)})}})}(),KM.ui.define("menu",{show:function(a,b,c,d,e){c=c||"position",this.trigger("beforeshow")!==!1&&(this.root().css($.extend({display:"block"},a?{top:a[c]().top+("right"==b?0:a.outerHeight())-(d||0),left:a[c]().left+("right"==b?a.outerWidth():0)-(e||0)}:{})),this.trigger("aftershow"))},hide:function(a){var b;this.trigger("beforehide")!==!1&&((b=this.root().data("parentmenu"))&&(b.data("parentmenu")||a)&&b.kmui().hide(),this.root().css("display","none"),this.trigger("afterhide"))},attachTo:function(a){var b=this;a.data("$mergeObj")||(a.data("$mergeObj",b.root()),a.kmui()?a.on("wrapclick",function(){b.supper.show.call(b,a,"","offset",15)}):a.on("click",function(){b.supper.show.call(b,a,"","offset",15)}),b.register("click",a,function(){b.hide()}),b.data("$mergeObj",a))}}),KM.ui.define("dropmenu",{tmpl:'<ul class="kmui-dropdown-menu" aria-labelledby="dropdownMenu" ><%if(data && data.length){for(var i=0,ci;ci=data[i++];){%><%if(ci.divider){%><li class="kmui-divider"></li><%}else{%><li <%if(ci.active||ci.disabled){%>class="<%= ci.active|| \'\' %> <%=ci.disabled||\'\' %>" <%}%> data-value="<%= ci.value%>" data-label="<%= ci.label%>"><a href="#" tabindex="-1"><em class="kmui-dropmenu-checkbox"><i class="kmui-icon-ok"></i></em><%= ci.label%></a></li><%}}%><%}%></ul>',subTmpl:'<%if(data && data.length){for(var i=0,ci;ci=data[i++];){%><%if(ci.divider){%><li class="kmui-divider"></li><%}else{%><li <%if(ci.active||ci.disabled){%>class="<%= ci.active|| \'\' %> <%=ci.disabled||\'\' %>" <%}%> data-value="<%= ci.value%>" data-label="<%= ci.label%>"><a href="#" tabindex="-1"><em class="kmui-dropmenu-checkbox"><i class="kmui-icon-ok"></i></em><%= ci.label%></a></li><%}}%><%}%>',defaultOpt:{data:[],anchor:"top",click:function(){}},setData:function(a){return this.root().html($.parseTmpl(this.subTmpl,a)),this},position:function(a){return this.root().css({left:a.x,top:a.y}),this},show:function(){return this.trigger("beforeshow")!==!1?(this.root().css({display:"block"}),this.trigger("aftershow"),this):void 0},init:function(a){var b=this,c={click:1,mouseover:1,mouseout:1};this.root($($.parseTmpl(this.tmpl,a))).on("click",'li[class!="kmui-disabled kmui-divider kmui-dropdown-submenu"]',function(c){$.proxy(a.click,b,c,$(this).data("value"),$(this).data("label"),$(this))()}).find("li").each(function(d,e){var f=$(this);if(!f.hasClass("kmui-disabled kmui-divider kmui-dropdown-submenu")){var g=a.data[d];$.each(c,function(a){g[a]&&f[a](function(c){$.proxy(g[a],e)(c,g,b.root)})})}})},_initEvent:function(){this.root().on("mouseover",'li[class="kmui-dropdown-submenu',function(){var a=$(this).data("widget");a.kmui().show($(this),"right","position",5,2)})},disabled:function(a){$("li[class!=kmui-divider]",this.root()).each(function(){var b=$(this);a===!0?b.addClass("kmui-disabled"):$.isFunction(a)?b.toggleClass("kmui-disabled",a(b)):b.removeClass("kmui-disabled")})},val:function(a){var b;return $('li[class!="kmui-divider kmui-disabled kmui-dropdown-submenu"]',this.root()).each(function(){var c=$(this);if(void 0===a){if(c.find("em.kmui-dropmenu-checked").length)return b=c.data("value"),!1}else c.find("em").toggleClass("kmui-dropmenu-checked",c.data("value")==a)}),void 0===a?b:void 0},appendItem:function(a){var b='<%if(item.divider){%><li class="kmui-divider"></li><%}else{%><li <%if(item.active||item.disabled){%>class="<%= item.active|| \'\' %> <%=item.disabled||\'\' %>" <%}%> data-value="<%= item.value%>" data-label="<%= item.label%>"><a href="#" tabindex="-1"><em class="kmui-dropmenu-checkbox"><i class="kmui-icon-ok"></i></em><%= item.label%></a></li><%}%>',c=$.parseTmpl(b,a),d=$(c).click(a.click);this.root().append(d)},addSubmenu:function(a,b,c){c=c||0;var d=$("li[class!=kmui-divider]",this.root()),e=$('<li class="kmui-dropdown-submenu"><a tabindex="-1" href="#">'+a+"</a></li>").append(b);e.data("widget",b),c>=0&&c<d.length?e.insertBefore(d[c]):0>c?e.insertBefore(d[0]):c>=d.length&&e.appendTo(d)}},"menu"),KM.ui.define("splitbutton",{tpl:'<div class="kmui-splitbutton <%if (name){%>kmui-splitbutton-<%= name %><%}%>"  unselectable="on" <%if(title){%>data-original-title="<%=title%>"<%}%>><div class="kmui-btn"  unselectable="on" ><%if(icon){%><div  unselectable="on" class="kmui-icon-<%=icon%> kmui-icon"></div><%}%><%if(text){%><%=text%><%}%></div><div  unselectable="on" class="kmui-btn kmui-dropdown-toggle" ><div  unselectable="on" class="kmui-caret"></div></div></div>',defaultOpt:{text:"",title:"",click:function(){}},init:function(a){var b=this;return b.root($($.parseTmpl(b.tpl,a))),b.root().find(".kmui-btn:first").click(function(){b.disabled()||$.proxy(a.click,b)()}),b.root().find(".kmui-dropdown-toggle").click(function(){b.disabled()||b.trigger("arrowclick")}),b.root().hover(function(){b.root().hasClass("kmui-disabled")||b.root().toggleClass("kmui-hover")}),b},wrapclick:function(a,b){return this.disabled()||$.proxy(a,this,b)(),this},disabled:function(a){return void 0===a?this.root().hasClass("kmui-disabled"):(this.root().toggleClass("kmui-disabled",a).find(".kmui-btn").toggleClass("kmui-disabled",a),this)},active:function(a){return void 0===a?this.root().hasClass("kmui-active"):(this.root().toggleClass("kmui-active",a).find(".kmui-btn:first").toggleClass("kmui-active",a),this)},mergeWith:function(a){var b=this;b.data("$mergeObj",a),a.kmui().data("$mergeObj",b.root()),$.contains(document.body,a[0])||a.appendTo(b.root()),b.root().delegate(".kmui-dropdown-toggle","click",function(){b.wrapclick(function(){a.kmui().show()})}),b.register("click",b.root().find(".kmui-dropdown-toggle"),function(){a.hide()})}}),KM.ui.define("colorsplitbutton",{tpl:'<div class="kmui-splitbutton <%if (name){%>kmui-splitbutton-<%= name %><%}%>"  unselectable="on" <%if(title){%>data-original-title="<%=title%>"<%}%>><div class="kmui-btn"  unselectable="on" ><%if(icon){%><div  unselectable="on" class="kmui-icon-<%=icon%> kmui-icon"></div><%}%><div class="kmui-splitbutton-color-label" <%if (color) {%>style="background: <%=color%>"<%}%>></div><%if(text){%><%=text%><%}%></div><div  unselectable="on" class="kmui-btn kmui-dropdown-toggle" ><div  unselectable="on" class="kmui-caret"></div></div></div>',defaultOpt:{color:""},init:function(a){var b=this;b.supper.init.call(b,a)},colorLabel:function(){return this.root().find(".kmui-splitbutton-color-label")}},"splitbutton"),KM.ui.define("popup",{tpl:'<div class="kmui-dropdown-menu kmui-popup"<%if(!<%=stopprop%>){%>onmousedown="return false"<%}%>><div class="kmui-popup-body" unselectable="on" onmousedown="return false"><%=subtpl%></div><div class="kmui-popup-caret"></div></div>',defaultOpt:{stopprop:!1,subtpl:"",width:"",height:""},init:function(a){return this.root($($.parseTmpl(this.tpl,a))),this},mergeTpl:function(a){return $.parseTmpl(this.tpl,{subtpl:a})},show:function(a,b){b||(b={});var c=b.fnname||"position";this.trigger("beforeshow")!==!1&&(this.root().css($.extend({display:"block"},a?{top:a[c]().top+("right"==b.dir?0:a.outerHeight())-(b.offsetTop||0),left:a[c]().left+("right"==b.dir?a.outerWidth():0)-(b.offsetLeft||0),position:"absolute"}:{})),this.root().find(".kmui-popup-caret").css({top:b.caretTop||0,left:b.caretLeft||0,position:"absolute"}).addClass(b.caretDir||"up"),this.trigger("aftershow"))},hide:function(){this.root().css("display","none"),this.trigger("afterhide")},attachTo:function(a,b){var c=this;a.data("$mergeObj")||(a.data("$mergeObj",c.root()),a.on("wrapclick",function(){c.show(a,b)}),c.register("click",a,function(){c.hide()}),c.data("$mergeObj",a))},getBodyContainer:function(){return this.root().find(".kmui-popup-body")}}),KM.ui.define("scale",{tpl:'<div class="kmui-scale" unselectable="on"><span class="kmui-scale-hand0"></span><span class="kmui-scale-hand1"></span><span class="kmui-scale-hand2"></span><span class="kmui-scale-hand3"></span><span class="kmui-scale-hand4"></span><span class="kmui-scale-hand5"></span><span class="kmui-scale-hand6"></span><span class="kmui-scale-hand7"></span></div>',defaultOpt:{$doc:$(document),$wrap:$(document)},init:function(a){return a.$doc&&(this.defaultOpt.$doc=a.$doc),a.$wrap&&(this.defaultOpt.$wrap=a.$wrap),this.root($($.parseTmpl(this.tpl,a))),this.initStyle(),this.startPos=this.prePos={x:0,y:0},this.dragId=-1,this},initStyle:function(){g.cssRule("kmui-style-scale",".kmui-scale{display:none;position:absolute;border:1px solid #38B2CE;cursor:hand;}.kmui-scale span{position:absolute;left:0;top:0;width:7px;height:7px;overflow:hidden;font-size:0px;display:block;background-color:#3C9DD0;}.kmui-scale .kmui-scale-hand0{cursor:nw-resize;top:0;margin-top:-4px;left:0;margin-left:-4px;}.kmui-scale .kmui-scale-hand1{cursor:n-resize;top:0;margin-top:-4px;left:50%;margin-left:-4px;}.kmui-scale .kmui-scale-hand2{cursor:ne-resize;top:0;margin-top:-4px;left:100%;margin-left:-3px;}.kmui-scale .kmui-scale-hand3{cursor:w-resize;top:50%;margin-top:-4px;left:0;margin-left:-4px;}.kmui-scale .kmui-scale-hand4{cursor:e-resize;top:50%;margin-top:-4px;left:100%;margin-left:-3px;}.kmui-scale .kmui-scale-hand5{cursor:sw-resize;top:100%;margin-top:-3px;left:0;margin-left:-4px;}.kmui-scale .kmui-scale-hand6{cursor:s-resize;top:100%;margin-top:-3px;left:50%;margin-left:-4px;}.kmui-scale .kmui-scale-hand7{cursor:se-resize;top:100%;margin-top:-3px;left:100%;margin-left:-3px;}")},_eventHandler:function(a){var b=this,c=b.defaultOpt.$doc;switch(a.type){case"mousedown":var d,d=a.target||a.srcElement;-1!=d.className.indexOf("kmui-scale-hand")&&(b.dragId=d.className.slice(-1),b.startPos.x=b.prePos.x=a.clientX,b.startPos.y=b.prePos.y=a.clientY,c.bind("mousemove",$.proxy(b._eventHandler,b)));break;case"mousemove":-1!=b.dragId&&(b.updateContainerStyle(b.dragId,{x:a.clientX-b.prePos.x,y:a.clientY-b.prePos.y}),b.prePos.x=a.clientX,b.prePos.y=a.clientY,b.updateTargetElement());break;case"mouseup":if(-1!=b.dragId){b.dragId=-1,b.updateTargetElement();var e=b.data("$scaleTarget");e.parent()&&b.attachTo(b.data("$scaleTarget"))}c.unbind("mousemove",$.proxy(b._eventHandler,b))}},updateTargetElement:function(){var a=this,b=a.root(),c=a.data("$scaleTarget");c.css({width:b.width(),height:b.height()}),a.attachTo(c)},updateContainerStyle:function(a,b){var c,d=this,e=d.root(),f=[[0,0,-1,-1],[0,0,0,-1],[0,0,1,-1],[0,0,-1,0],[0,0,1,0],[0,0,-1,1],[0,0,0,1],[0,0,1,1]];0!=f[a][0]&&(c=parseInt(e.offset().left)+b.x,e.css("left",d._validScaledProp("left",c))),0!=f[a][1]&&(c=parseInt(e.offset().top)+b.y,e.css("top",d._validScaledProp("top",c))),0!=f[a][2]&&(c=e.width()+f[a][2]*b.x,e.css("width",d._validScaledProp("width",c))),0!=f[a][3]&&(c=e.height()+f[a][3]*b.y,e.css("height",d._validScaledProp("height",c)))},_validScaledProp:function(a,b){var c=this.root(),d=this.defaultOpt.$doc,e=function(a,c,d){return a+c>d?d-c:b};switch(b=isNaN(b)?0:b,a){case"left":return 0>b?0:e(b,c.width(),d.width());case"top":return 0>b?0:e(b,c.height(),d.height());case"width":return 0>=b?1:e(b,c.offset().left,d.width());case"height":return 0>=b?1:e(b,c.offset().top,d.height())}},show:function(a){var b=this;a&&b.attachTo(a),b.root().bind("mousedown",$.proxy(b._eventHandler,b)),b.defaultOpt.$doc.bind("mouseup",$.proxy(b._eventHandler,b)),b.root().show(),b.trigger("aftershow")},hide:function(){var a=this;a.root().unbind("mousedown",$.proxy(a._eventHandler,a)),a.defaultOpt.$doc.unbind("mouseup",$.proxy(a._eventHandler,a)),a.root().hide(),a.trigger("afterhide")},attachTo:function(a){var b=this,c=a.offset(),d=b.root(),e=b.defaultOpt.$wrap,f=e.offset();b.data("$scaleTarget",a),b.root().css({position:"absolute",width:a.width(),height:a.height(),left:c.left-f.left-parseInt(e.css("border-left-width"))-parseInt(d.css("border-left-width")),top:c.top-f.top-parseInt(e.css("border-top-width"))-parseInt(d.css("border-top-width"))})},getScaleTarget:function(){return this.data("$scaleTarget")[0]}}),KM.ui.define("colorpicker",{tpl:function(a){for(var b="ffffff,000000,eeece1,1f497d,4f81bd,c0504d,9bbb59,8064a2,4bacc6,f79646,f2f2f2,7f7f7f,ddd9c3,c6d9f0,dbe5f1,f2dcdb,ebf1dd,e5e0ec,dbeef3,fdeada,d8d8d8,595959,c4bd97,8db3e2,b8cce4,e5b9b7,d7e3bc,ccc1d9,b7dde8,fbd5b5,bfbfbf,3f3f3f,938953,548dd4,95b3d7,d99694,c3d69b,b2a2c7,92cddc,fac08f,a5a5a5,262626,494429,17365d,366092,953734,76923c,5f497a,31859b,e36c09,7f7f7f,0c0c0c,1d1b10,0f243e,244061,632423,4f6128,3f3151,205867,974806,c00000,ff0000,ffc000,ffff00,92d050,00b050,00b0f0,0070c0,002060,7030a0,".split(","),c='<div unselectable="on" onmousedown="return false" class="kmui-colorpicker<%if (name){%> kmui-colorpicker-<%=name%><%}%>" ><table unselectable="on" onmousedown="return false"><tr><td colspan="10">'+a.lang_themeColor+'</td> </tr><tr class="kmui-colorpicker-firstrow" >',d=0;d<b.length;d++)d&&d%10===0&&(c+="</tr>"+(60==d?'<tr><td colspan="10">'+a.lang_standardColor+"</td></tr>":"")+"<tr"+(60==d?' class="kmui-colorpicker-firstrow"':"")+">"),c+=70>d?'<td><a unselectable="on" onmousedown="return false" title="'+b[d]+'" class="kmui-colorpicker-colorcell" data-color="#'+b[d]+'" style="background-color:#'+b[d]+";border:solid #ccc;"+(10>d||d>=60?"border-width:1px;":d>=10&&20>d?"border-width:1px 1px 0 1px;":"border-width:0 1px 0 1px;")+'"></a></td>':"";return c+="</tr></table></div>"},init:function(a){var b=this;b.root($($.parseTmpl(b.supper.mergeTpl(b.tpl(a)),a))),b.root().on("click",function(a){b.trigger("pickcolor",$(a.target).data("color"))})}},"popup"),function(){var a="combobox",b="kmui-combobox-item",c="kmui-combobox-item-hover",d="kmui-combobox-checked-icon",e="kmui-combobox-item-label";KM.ui.define(a,function(){return{tpl:'<ul class="dropdown-menu kmui-combobox-menu<%if (comboboxName!==\'\') {%> kmui-combobox-<%=comboboxName%><%}%>" unselectable="on" onmousedown="return false" role="menu" aria-labelledby="dropdownMenu"><%if(autoRecord) {%><%for( var i=0, len = recordStack.length; i<len; i++ ) {%><%var index = recordStack[i];%><li class="<%=itemClassName%><%if( selected == index ) {%> kmui-combobox-checked<%}%><%if( disabled[ index ] === true ) {%> kmui-combobox-item-disabled<%}%>" data-item-index="<%=index%>" unselectable="on" onmousedown="return false"><span class="kmui-combobox-icon" unselectable="on" onmousedown="return false"></span><label class="<%=labelClassName%>" style="<%=itemStyles[ index ]%>" unselectable="on" onmousedown="return false"><%=items[index]%></label></li><%}%><%if( i ) {%><li class="kmui-combobox-item-separator"></li><%}%><%}%><%for( var i=0, label; label = items[i]; i++ ) {%><li class="<%=itemClassName%><%if( selected == i ) {%> kmui-combobox-checked<%}%> kmui-combobox-item-<%=i%><%if( disabled[ i ] === true ) {%> kmui-combobox-item-disabled<%}%>" data-item-index="<%=i%>" unselectable="on" onmousedown="return false"><span class="kmui-combobox-icon" unselectable="on" onmousedown="return false"></span><label class="<%=labelClassName%>" style="<%=itemStyles[ i ]%>" unselectable="on" onmousedown="return false"><%=label%></label></li><%}%></ul>',defaultOpt:{recordStack:[],items:[],value:[],comboboxName:"",selected:"",disabled:{},autoRecord:!0,recordCount:5,enabledRecord:!0},init:function(a){var c=this;$.extend(c._optionAdaptation(a),c._createItemMapping(a.recordStack,a.items),{itemClassName:b,iconClass:d,labelClassName:e}),this._transStack(a),c.root($($.parseTmpl(c.tpl,a))),this.data("options",a).initEvent()},initEvent:function(){var a=this;a.initSelectItem(),this.initItemActive()},setLabelWithDefaultValue:function(){var a=this.data("button");a.kmui().label(a.data("original-title"))},initSelectItem:function(){var a=this,c=a.data("options"),d="."+e;a.root().delegate("."+b,"click",function(){var b=$(this),e=b.attr("data-item-index");return c.disabled[e]?!1:(a.trigger("comboboxselect",{index:e,label:b.find(d).text(),value:a.data("options").value[e]}).select(e),a.hide(),a.trigger("aftercomboboxselect"),!1)})},initItemActive:function(){var a={mouseenter:"addClass",mouseleave:"removeClass"};$.IE6&&this.root().delegate("."+b,"mouseenter mouseleave",function(b){$(this)[a[b.type]](c)}).one("afterhide",function(){})},select:function(a){var b=this.data("options"),c=b.itemCount,d=b.autowidthitem;return d&&!d.length&&(d=b.items),b.disabled[a]?null:0==c?null:(0>a?a=c+a%c:a>=c&&(a=c-1),this.trigger("changebefore",d[a]),this._update(a),this.trigger("changeafter",d[a]),null)},selectItemByLabel:function(a){var b=this.data("options").itemMapping,c=this,d=null;!$.isArray(a)&&(a=[a]),$.each(a,function(a,e){return d=b[e],void 0!==d?(c.select(d),!1):void 0})},getItems:function(){return this.data("options").items},traverseItems:function(a){var b=this.data("options").value,c=this.data("options").items;
return $.each(c,function(c,d){a(d,b[c])}),this},getItemMapping:function(){return this.data("options").itemMapping},disableItemByIndex:function(a){var b=this.data("options");b.disabled[a]=!0,this._repaint()},disableItemByLabel:function(a){var b=this.data("options").itemMapping,c=b[a];return"number"==typeof c?this.disableItemByIndex(c):!1},enableItemByIndex:function(a){var b=this.data("options");delete b.disabled[a],this._repaint()},enableItemByLabel:function(a){var b=this.data("options").itemMapping,c=b[a];return"number"==typeof c?this.enableItemByIndex(c):!1},_transStack:function(a){var b=[],c=-1,d=-1;$.each(a.recordStack,function(e,f){c=a.itemMapping[f],$.isNumeric(c)&&(b.push(c),f==a.selected&&(d=c))}),a.recordStack=b,a.selected=d,b=null},_optionAdaptation:function(a){if(!("itemStyles"in a)){a.itemStyles=[];for(var b=0,c=a.items.length;c>b;b++)a.itemStyles.push("")}return a.autowidthitem=a.autowidthitem||a.items,a.itemCount=a.items.length,a},_createItemMapping:function(a,b){var c={},d={recordStack:[],mapping:{}};return $.each(b,function(a,b){c[b]=a}),d.itemMapping=c,$.each(a,function(a,b){void 0!==c[b]&&(d.recordStack.push(c[b]),d.mapping[b]=c[b])}),d},_update:function(a){var b=this.data("options"),c=[];this.data("options").enabledRecord&&($.each(b.recordStack,function(b,d){d!=a&&c.push(d)}),c.unshift(a),c.length>b.recordCount&&(c.length=b.recordCount),b.recordStack=c),b.selected=a,this._repaint(),c=null},_repaint:function(){var a=$($.parseTmpl(this.tpl,this.data("options")));this.root().html(a.html()),a=null}}}(),"menu")}(),function(){var a="buttoncombobox";KM.ui.define(a,function(){return{defaultOpt:{label:"",title:""},init:function(a){var b=this,c=$.kmuibutton({caret:!0,name:a.comboboxName,title:a.title,text:a.label,click:function(){b.show(this.root())}});b.supper.init.call(b,a),b.on("changebefore",function(a,b){c.kmuibutton("label",b)}),b.data("button",c),b.attachTo(c)},button:function(){return this.data("button")}}}(),"combobox")}(),KM.ui.define("modal",{tpl:'<div class="kmui-modal" tabindex="-1" ><div class="kmui-modal-header"><div class="kmui-close" data-hide="modal"></div><h3 class="kmui-title"><%=title%></h3></div><div class="kmui-modal-body"  style="<%if(width){%>width:<%=width%>px;<%}%><%if(height){%>height:<%=height%>px;<%}%>"> </div><% if(cancellabel || oklabel) {%><div class="kmui-modal-footer"><div class="kmui-modal-tip"></div><%if(oklabel){%><div class="kmui-btn kmui-btn-primary" data-ok="modal"><%=oklabel%></div><%}%><%if(cancellabel){%><div class="kmui-btn" data-hide="modal"><%=cancellabel%></div><%}%></div><%}%></div>',defaultOpt:{title:"",cancellabel:"",oklabel:"",width:"",height:"",backdrop:!0,keyboard:!0},init:function(a){var b=this;b.root($($.parseTmpl(b.tpl,a||{}))),b.data("options",a),a.okFn&&b.on("ok",$.proxy(a.okFn,b)),a.cancelFn&&b.on("beforehide",$.proxy(a.cancelFn,b)),b.root().delegate('[data-hide="modal"]',"click",$.proxy(b.hide,b)).delegate('[data-ok="modal"]',"click",$.proxy(b.ok,b)),$('[data-hide="modal"],[data-ok="modal"]',b.root()).hover(function(){$(this).toggleClass("kmui-hover")}),setTimeout(function(){$(".kmui-modal").draggable({handle:".kmui-modal-header"})},100)},toggle:function(){var a=this;return a[a.data("isShown")?"hide":"show"]()},show:function(){var a=this;a.trigger("beforeshow"),a.data("isShown")||(a.data("isShown",!0),a.escape(),a.backdrop(function(){a.autoCenter(),a.root().show().focus().trigger("aftershow")}),$(".kmui-modal").draggable({handle:".kmui-modal-header"}))},showTip:function(a){$(".kmui-modal-tip",this.root()).html(a).fadeIn()},hideTip:function(){$(".kmui-modal-tip",this.root()).fadeOut(function(){$(this).html("")})},autoCenter:function(){!$.IE6&&this.root().css("margin-left",-(this.root().width()/2))},hide:function(){var a=this;a.trigger("beforehide"),a.data("isShown")&&(a.data("isShown",!1),a.escape(),a.hideModal())},escape:function(){var a=this;a.data("isShown")&&a.data("options").keyboard?a.root().on("keyup",function(b){27==b.which&&a.hide()}):a.data("isShown")||a.root().off("keyup")},hideModal:function(){var a=this;a.root().hide(),a.backdrop(function(){a.removeBackdrop(),a.trigger("afterhide")})},removeBackdrop:function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},backdrop:function(a){var b=this;b.data("isShown")&&b.data("options").backdrop&&(b.$backdrop=$('<div class="kmui-modal-backdrop" />').click("static"==b.data("options").backdrop?$.proxy(b.root()[0].focus,b.root()[0]):$.proxy(b.hide,b))),b.trigger("afterbackdrop"),a&&a()},attachTo:function(a){var b=this;a.data("$mergeObj")||(a.data("$mergeObj",b.root()),a.on("click",function(){b.toggle(a)}),b.data("$mergeObj",a))},ok:function(){var a=this;a.trigger("beforeok"),a.trigger("ok",a)!==!1&&a.hide()},getBodyContainer:function(){return this.root().find(".kmui-modal-body")}}),KM.ui.define("tooltip",{tpl:'<div class="kmui-tooltip" unselectable="on" onmousedown="return false"><div class="kmui-tooltip-arrow" unselectable="on" onmousedown="return false"></div><div class="kmui-tooltip-inner" unselectable="on" onmousedown="return false"></div></div>',init:function(a){var b=this;b.root($($.parseTmpl(b.tpl,a||{})))},content:function(a){var b=this,c=$(a.currentTarget).attr("data-original-title");b.root().find(".kmui-tooltip-inner").text(c)},position:function(a){var b=this,c=$(a.currentTarget);b.root().css($.extend({display:"block"},c?{top:c.outerHeight(),left:(c.outerWidth()-b.root().outerWidth())/2}:{}))},show:function(a){if(!$(a.currentTarget).hasClass("kmui-disabled")){var b=this;b.content(a),b.root().appendTo($(a.currentTarget)),b.position(a),b.root().css("display","block")}},hide:function(){var a=this;a.root().css("display","none")},attachTo:function(a){function b(a){var b=this;$.contains(document.body,b.root()[0])||b.root().appendTo(a),b.data("tooltip",b.root()),a.each(function(){$(this).attr("data-original-title")&&$(this).on("mouseenter",$.proxy(b.show,b)).on("mouseleave click",$.proxy(b.hide,b))})}var c=this;"undefined"===$.type(a)?$("[data-original-title]").each(function(a,d){b.call(c,$(d))}):a.data("tooltip")||b.call(c,a)}}),KM.ui.define("tab",{init:function(a){var b=this,c=a.selector;$.type(c)&&(b.root($(c,a.context)),b.data("context",a.context),$(c,b.data("context")).on("click",function(a){b.show(a)}))},show:function(a){var b,c,d,a,e=this,f=$(a.target),g=f.closest("ul");b=f.attr("data-context"),b=b&&b.replace(/.*(?=#[^\s]*$)/,"");var h=f.parent("li");h.length&&!h.hasClass("kmui-active")&&(c=g.find(".kmui-active:last a")[0],a=$.Event("beforeshow",{target:f[0],relatedTarget:c}),e.trigger(a),a.isDefaultPrevented()||(d=$(b,e.data("context")),e.activate(f.parent("li"),g),e.activate(d,d.parent(),function(){e.trigger({type:"aftershow",relatedTarget:c})})))},activate:function(a,b,c){if(void 0===a)return $(".kmui-tab-item.kmui-active",this.root()).index();var d=b.find("> .kmui-active");d.removeClass("kmui-active"),a.addClass("kmui-active"),c&&c()}}),KM.ui.define("separator",{tpl:'<div class="kmui-separator" unselectable="on" onmousedown="return false" ></div>',init:function(a){var b=this;return b.root($($.parseTmpl(b.tpl,a))),b}}),$.wordCountAdaptive=function(a,b){var c=$("<span>").html(a).css({display:"inline",position:"absolute",top:-1e7,left:-1e5}).appendTo(document.body),d=c.width();return c.remove(),c=null,50>d?a:(a=a.slice(0,b?-4:-1),a.length?$.wordCountAdaptive(a+"...",!0):"...")},g.extend(f,function(){var a={},b={},c=null,d={},e={};return{registerUI:function(b,c){g.each(b.split(/\s+/),function(b,d){a[d]=c})},registerToolbarUI:function(a,c){g.each(a.split(/\s+/),function(a,d){b[d]=c})},loadUI:function(b){g.each(a,function(a,c){c.call(b)})},_createUI:function(a){var b=$('<div class="kmui-container"></div>'),c=$.kmuitoolbar(),d=$('<div class="kmui-editor-body"></div>'),e=$('<div class="kmui-statusbar"></div>');return b.append(c).append(d).append(e),$(g.isString(a)?"#"+a:a).append(b),{$container:b,$toolbar:c,$body:d,$statusbar:e}},_createToolbar:function(a,c){var d=c.getOptions("toolbars");if(d&&d.length){var e=[];$.each(d,function(d,f){$.each(f.split(/\s+/),function(a,d){if("|"==d)$.kmuiseparator&&e.push($.kmuiseparator());else if(b[d]){var f=b[d].call(c,d);f&&e.push(f)}}),e.length&&a.kmui().appendToBtnmenu(e)})}a.append($('<div class="kmui-dialog-container"></div>'))},_createStatusbar:function(){},getKityMinder:function(a,b){var c=this._createUI(a),d=this.getMinder(c.$body.get(0),b);return this._createToolbar(c.$toolbar,d),this._createStatusbar(c.$statusbar,d),d.$container=c.$container,this.loadUI(d),d.fire("interactchange")},registerWidget:function(a,b,c){d[a]=$.extend2(b,{$root:"",_preventDefault:!1,root:function(a){return this.$root||(this.$root=a)},preventDefault:function(){this._preventDefault=!0},clear:!1}),c&&(e[a]=c)},getWidgetData:function(a){return d[a]},setWidgetBody:function(a,b,c){c._widgetData||g.extend(c,{_widgetData:{},getWidgetData:function(a){return this._widgetData[a]},getWidgetCallback:function(a){var c=this;return function(){return e[a].apply(c,[c,b].concat(g.argsToArray(arguments,0)))}}});var f=d[a];return f?(f=c._widgetData[a],f||(f=d[a],f=c._widgetData[a]="function"==$.type(f)?f:g.clone(f)),f.root(b.kmui().getBodyContainer()),f.initContent(c,b),f._preventDefault||f.initEvent(c,b),void(f.width&&b.width(f.width))):null},setActiveWidget:function(a){c=a}}}()),KM.registerToolbarUI("bold italic redo undo",function(a){var b=this,c=$.kmuibutton({icon:a,click:function(){b.execCommand(a)},title:this.getLang("tooltips")[a]||""});return this.on("interactchange",function(){var b=this.queryCommandState(a);c.kmui().disabled(-1==b).active(1==b)}),c}),KM.registerToolbarUI("fontfamily fontsize",function(a){function b(a){for(var b=null,c=[],d=0,e=a.items.length;e>d;d++)b=a.items[d].val,c.push(b.split(/\s*,\s*/)[0]),a.itemStyles.push("font-family: "+b),a.value.push(b),a.autowidthitem.push($.wordCountAdaptive(c[d]));return a.items=c,a}function c(a){var b=null,c=[];a.itemStyles=[],a.value=[];for(var d=0,e=a.items.length;e>d;d++)b=a.items[d],c.push(b),a.itemStyles.push("font-size: "+b+"px; height:"+(b+2)+"px; line-height: "+(b+2)+"px");return a.value=a.items,a.items=c,a.autoRecord=!1,a}var d=this,e=d.getLang("tooltips."+a),f={label:e,title:e,comboboxName:a,items:d.getOptions(a)||[],itemStyles:[],value:[],autowidthitem:[]},g=null,h=null;if(0==f.items.length)return null;switch(a){case"fontfamily":f=b(f);break;case"fontsize":f=c(f)}return g=$.kmuibuttoncombobox(f).css("zIndex",d.getOptions("zIndex")+1),h=g.kmui(),h.on("comboboxselect",function(b,c){d.execCommand(a,c.value)}).on("beforeshow",function(){0===g.parent().length&&g.appendTo(d.$container.find(".kmui-dialog-container"))}),this.on("interactchange",function(){var b=this.queryCommandState(a),c=this.queryCommandValue(a);h.button().kmui().disabled(-1==b).active(1==b),c&&(c=c.replace(/['"]/g,"").toLowerCase().split(/['|"]?\s*,\s*[\1]?/),h.selectItemByLabel(c))}),h.button().addClass("kmui-combobox")}),KM.registerToolbarUI("forecolor",function(c){function d(){return g.css("background-color")}var e=this,f=null,g=null,h=null;return this.on("interactchange",function(){var a=this.queryCommandState(c);h.kmui().disabled(-1==a).active(1==a)}),h=$.kmuicolorsplitbutton({icon:c,caret:!0,name:c,title:this.getLang("tooltips")[c]||"",click:function(){var b=a.Color.parse(d()).toHEX();"#000000"!=b&&e.execCommand(c,b)}}),g=h.kmui().colorLabel(),f=$.kmuicolorpicker({name:c,lang_clearColor:e.getLang("popupcolor").clearColor||"",lang_themeColor:e.getLang("popupcolor").themeColor||"",lang_standardColor:e.getLang("popupcolor").standardColor||""}).on("pickcolor",function(a,d){b.setTimeout(function(){g.css("backgroundColor",d),e.execCommand(c,d)},0)}).on("show",function(){KM.setActiveWidget(f.kmui().root())}).css("zIndex",e.getOptions("zIndex")+1),h.kmui().on("arrowclick",function(){f.parent().length||e.$container.find(".kmui-dialog-container").append(f),f.kmui().show(h,{caretDir:"down",offsetTop:-5,offsetLeft:8,caretLeft:11,caretTop:-8})}).register("click",h,function(){f.kmui().hide()}),h}),KM.registerToolbarUI("saveto",function(a){function b(a,b){var c=document.createElement("a");c.setAttribute("download",b),c.setAttribute("href",a),c.dispatchEvent(new MouseEvent("click"))}var c=this,d=c.getLang("tooltips."+a),e={label:d,title:d,comboboxName:a,items:[],itemStyles:[],value:[],autowidthitem:[],enabledRecord:!1},h=null,i=null;return g.each(f.getAllRegisteredProtocals(),function(a){var b=f.findProtocal(a),c=b.fileDescription+""+b.fileExtension+"";e.value.push(a),e.items.push(c),e.autowidthitem.push($.wordCountAdaptive(c),!0)}),h=$.kmuibuttoncombobox(e).css("zIndex",c.getOptions("zIndex")+1),i=h.kmui(),i.on("comboboxselect",function(a,d){var e=c.exportData(d.value),g=f.findProtocal(d.value),h=c.getMinderTitle()+g.fileExtension;if("string"==typeof e){var i="data:text/plain; utf-8,"+encodeURI(e);b(i,h)}else e&&e.then&&e.then(function(a){b(a,h)})}).on("beforeshow",function(){0===h.parent().length&&h.appendTo(c.$container.find(".kmui-dialog-container"))}).on("aftercomboboxselect",function(){this.setLabelWithDefaultValue()}),i.button().addClass("kmui-combobox")}),KM.registerToolbarUI("hand zoom-in zoom-out",function(a){var b=this,c=$.kmuibutton({icon:a,click:function(){b.execCommand(a)},title:this.getLang("tooltips.")[a]||""});return b.on("interactchange",function(){var d=b.queryCommandState(a);c.kmui().disabled(-1==d).active(1==d)}),c}),KM.registerUI("tooltips",function(){var a=this;$.kmuitooltip&&($("[data-original-title]",a.$container).each(function(b,c){var d=a.getLang("tooltips"),e=$(c).data("original-title");g.each(d,function(b,d){d==e&&a.getShortcutKey(b)&&$(c).attr("data-original-title",e+" ("+a.getShortcutKey(b).toUpperCase()+")")})}),$.kmuitooltip("attachTo",$("[data-original-title]",a.$container)).css("z-index",a.getOptions("zIndex")+1)),a.$container.find("a").click(function(a){a.preventDefault()})}),KM.registerToolbarUI("switchlayout",function(a){var b=this,c=b.getLang("tooltips."+a),d={label:c,title:c,comboboxName:a,items:b.getLayoutStyleItems()||[],itemStyles:[],value:b.getLayoutStyleItems(),autowidthitem:[],enabledRecord:!1},e=null;if(0==d.items.length)return null;g.each(d.items,function(a,c){d.items[a]=b.getLang("layout")[c]}),e=$.kmuibuttoncombobox(d).css("zIndex",b.getOptions("zIndex")+1),comboboxWidget=e.kmui(),comboboxWidget.on("comboboxselect",function(c,d){b.execCommand(a,d.value)}).on("beforeshow",function(){0===e.parent().length&&e.appendTo(b.$container.find(".kmui-dialog-container"))}),b.on("interactchange",function(){var b=this.queryCommandState(a),c=this.queryCommandValue(a);comboboxWidget.button().kmui().disabled(-1==b).active(1==b),c&&(c=c.replace(/['"]/g,"").toLowerCase().split(/['|"]?\s*,\s*[\1]?/),comboboxWidget.selectItemByLabel(c))});var f=[];return g.each(b.getLayoutStyleItems(),function(c,d){f.push({label:b.getLang("tooltips."+a)+" "+d,cmdName:"switchlayout",exec:function(){b.execCommand("switchlayout",d)}})}),f.push({divider:1}),b.addContextmenu(f),comboboxWidget.button().addClass("kmui-combobox")}),KM.registerToolbarUI("node",function(a){function b(a){var b=[];return g.each(a.items,function(d,f){a.value.push(f),b.push((e[d]||d)+"("+c[f].toUpperCase()+")"),a.autowidthitem.push($.wordCountAdaptive(b[b.length-1]))}),a.items=b,a}var c={appendsiblingnode:"enter",appendchildnode:"tab",removenode:"del|backspace"},d=this,e=d.getLang("node"),f=d.getLang("tooltips."+a),h={label:f,title:f,comboboxName:a,items:d.getOptions(a)||[],itemStyles:[],value:[],autowidthitem:[],enabledRecord:!1},j=null;return 0==h.items.length?null:(j=$.kmuibuttoncombobox(b(h)).css("zIndex",d.getOptions("zIndex")+1),comboboxWidget=j.kmui(),comboboxWidget.on("comboboxselect",function(a,b){d.execCommand(b.value,new i(d.getLang().topic))}).on("beforeshow",function(){0===j.parent().length&&j.appendTo(d.$container.find(".kmui-dialog-container"));var a=j.kmui();a.traverseItems(function(b,c){-1==d.queryCommandState(c)?a.disableItemByLabel(b):a.enableItemByLabel(b)})}),comboboxWidget.button().addClass("kmui-combobox"))}),KM.registerUI("contextmenu",function(){function a(a){var c;return g.each(b.getContextmenu(),function(b,d){return d.label==a?(c=d,!1):void 0}),c}var b=this,c=$.kmuidropmenu({click:function(c,d,e){var f=a(e);f.exec?f.exec.apply(km):b.execCommand(f.cmdName),this.hide()}});b.$container.append(c),b.on("contextmenu",function(a){var d=b.getContextmenu(),e=[];if(g.each(d,function(a,c){return c.divider?void e.push(c):void(-1!=b.queryCommandState(c.cmdName)&&e.push({label:c.label,value:c.cmdName}))}),e.length){var f=e[e.length-1];f.divider&&e.pop(),c.kmui().setData({data:e}).position(a.getPosition()).show(),a.preventDefault()}}),b.on("click",function(){c.kmui().hide()}),b.on("beforemousedown",function(a){a.isRightMB()&&a.stopPropagationImmediately()})}),KM.registerToolbarUI("markers help",function(a){var b,c=this,d={title:this.getLang("tooltips")[a]||"",url:c.getOptions("KITYMINDER_HOME_URL")+"dialogs/"+a+"/"+a+".js"},e=$.kmuibutton({icon:a,title:this.getLang("tooltips")[a]||""});return g.loadFile(document,{src:d.url,tag:"script",type:"text/javascript",defer:"defer"},function(){b=$.kmuimodal(d),b.attr("id","kmui-dialog-"+a).addClass("kmui-dialog-"+a).find(".kmui-modal-body").addClass("kmui-dialog-"+a+"-body"),b.kmui().on("beforeshow",function(){var d=this.root();d.parent()[0]||c.$container.find(".kmui-dialog-container").append(d),KM.setWidgetBody(a,b,c)}).attachTo(e)}),c.on("interactchange",function(){var b=this.queryCommandState(a);e.kmui().disabled(-1==b).active(1==b)}),e}),f.registerProtocal("plain",function(){function a(a,b){for(var c="";b--;)c+=a;return c}function b(c,d){var e="";return d=d||0,e+=a(k,d),e+=c.data.text+j,c.children&&c.children.forEach(function(a){e+=b(a,d+1)}),e}function c(a){return!/\S/.test(a)}function d(a){for(var b=0;a.charAt(b)===k;)b++;return b}function e(a){return{data:{text:a.replace(new RegExp("^"+k+"*"),"")}}}function f(a){function b(a,b){var c=a.children||(a.children=[]);c.push(b)}for(var f,g,h,i,k={},l=a.split(j),m=0;m<l.length;m++)if(g=l[m],!c(g)){if(h=d(g),i=e(g),0===h){if(f)throw new Error("Invalid local format");f=i}else{if(!k[h-1])throw new Error("Invalid local format");b(k[h-1],i)}k[h]=i}return f}function g(a){if(!Utils.isString(a))return!1;h=a;try{i=f(a)}catch(b){i=null}return!!i}var h,i,j="\n",k="	";return{fileDescription:"",fileExtension:".txt",encode:function(a){return b(a,0)},decode:function(a){return h==a&&i?i:f(a)},recognize:g,recognizePriority:-1}}),f.registerProtocal("json",function(){function a(a,b){return"layout"==a||"shicon"==a?void 0:b}return{fileDescription:"KityMinder",fileExtension:".km",encode:function(b){return JSON.stringify(b,a)},decode:function(a){return JSON.parse(a)},recognize:function(a){return Utils.isString(a)&&"{"==a.charAt(0)&&"}"==a.charAt(a.length-1)},recognizePriority:0}}),f.registerProtocal("png",function(){function a(a,b){var c=new Image;c.onload=b,c.src=a}return{fileDescription:"PNG ",fileExtension:".png",encode:function(c,d){function e(a,b,c,d){a.save(),a.fillStyle=a.createPattern(b,"repeat"),a.fillRect(0,0,c,d),a.restore()}function f(a,b,c,d){a.drawImage(b,c,d)}function g(a){var b=a.toDataURL("png");return b.replace("image/png","image/octet-stream")}var h,i,j,k,l,m,n=d.getPaper().container,o=getComputedStyle(n).backgroundImage,p=/url\((.+)\)$/.exec(o)[1],q=d.getRenderContainer(),r=q.getRenderBox(),s=(q.getTransform(),r.width),t=r.height,u=20,v=document.createElement("canvas"),w=v.getContext("2d");return q.translate(-r.x,-r.y),h=d.getPaper().container.innerHTML,q.translate(r.x,r.y),i=$(h),i.attr({width:r.width,height:r.height,style:'font-family: Arial, "Heiti SC", "Microsoft Yahei";'}),h=$("<div></div").append(i).html(),j=new Blob([h],{type:"image/svg+xml;charset=utf-8"}),k=b.URL||b.webkitURL||b,l=k.createObjectURL(j),v.width=s+2*u,v.height=t+2*u,a(l,function(){var b=this;a(p,function(){var a;e(w,this,v.width,v.height),f(w,b,u,u),k.revokeObjectURL(l),a=g(v),m&&m(a)})}),{then:function(a){m=a}}},recognizePriority:-1}}),f.registerProtocal("svg",function(){return{fileDescription:"SVG ",fileExtension:".svg",encode:function(a,b){return b.getPaper().container.innerHTML},recognizePriority:-1}})}(kity,window);